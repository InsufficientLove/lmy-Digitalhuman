@echo off
chcp 65001 > nul
color 0C
title æ•°å­—äººç³»ç»Ÿ - HTTPSè¯ä¹¦å¼ºåŠ›ä¿®å¤å·¥å…·

echo ================================================================================
echo                        æ•°å­—äººç³»ç»Ÿ - HTTPSè¯ä¹¦å¼ºåŠ›ä¿®å¤å·¥å…·
echo ================================================================================
echo.
echo âš ï¸  æ­¤å·¥å…·å°†å½»åº•è§£å†³ HTTPS å¼€å‘è¯ä¹¦é—®é¢˜
echo.
echo ðŸ”§ ä¿®å¤æ­¥éª¤ï¼š
echo   1. å®Œå…¨æ¸…ç†æ‰€æœ‰å¼€å‘è¯ä¹¦
echo   2. é‡æ–°ç”Ÿæˆå¹¶å¼ºåˆ¶ä¿¡ä»»è¯ä¹¦
echo   3. æ¸…ç†æµè§ˆå™¨SSLç¼“å­˜
echo   4. æ·»åŠ Chromeå®‰å…¨ä¾‹å¤–
echo.
echo âš ï¸  è¯·ç¡®ä¿ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œæ­¤è„šæœ¬ï¼
echo.
pause

echo ================================================================================
echo [æ­¥éª¤ 1/5] åœæ­¢ç›¸å…³è¿›ç¨‹
echo ================================================================================

echo [ä¿¡æ¯] æ­£åœ¨åœæ­¢å¯èƒ½å ç”¨è¯ä¹¦çš„è¿›ç¨‹...
taskkill /f /im "dotnet.exe" >nul 2>&1
taskkill /f /im "LmyDigitalHuman.exe" >nul 2>&1
echo [âœ“] è¿›ç¨‹æ¸…ç†å®Œæˆ

echo ================================================================================
echo [æ­¥éª¤ 2/5] å®Œå…¨æ¸…ç†çŽ°æœ‰è¯ä¹¦
echo ================================================================================

echo [ä¿¡æ¯] æ¸…ç†æ‰€æœ‰HTTPSå¼€å‘è¯ä¹¦...
dotnet dev-certs https --clean --verbose
if %errorlevel% neq 0 (
    echo [è­¦å‘Š] æ¸…ç†è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œç»§ç»­æ‰§è¡Œ...
)

echo [ä¿¡æ¯] æ¸…ç†IIS Expressè¯ä¹¦...
netsh http delete sslcert ipport=0.0.0.0:44300 >nul 2>&1
netsh http delete sslcert ipport=0.0.0.0:7001 >nul 2>&1

echo ================================================================================
echo [æ­¥éª¤ 3/5] ç”Ÿæˆæ–°çš„å—ä¿¡ä»»è¯ä¹¦
echo ================================================================================

echo [ä¿¡æ¯] ç”Ÿæˆæ–°çš„å¼€å‘è¯ä¹¦...
dotnet dev-certs https --verbose
if %errorlevel% neq 0 (
    echo [é”™è¯¯] è¯ä¹¦ç”Ÿæˆå¤±è´¥
    pause
    goto end
)

echo [ä¿¡æ¯] å¼ºåˆ¶ä¿¡ä»»è¯ä¹¦...
dotnet dev-certs https --trust --verbose
if %errorlevel% neq 0 (
    echo [é”™è¯¯] è¯ä¹¦ä¿¡ä»»å¤±è´¥
    echo.
    echo è¯·ç¡®ä¿ï¼š
    echo 1. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œæ­¤è„šæœ¬
    echo 2. åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ç‚¹å‡»"æ˜¯"
    pause
    goto end
)

echo ================================================================================
echo [æ­¥éª¤ 4/5] éªŒè¯è¯ä¹¦çŠ¶æ€
echo ================================================================================

echo [ä¿¡æ¯] æ£€æŸ¥è¯ä¹¦çŠ¶æ€...
dotnet dev-certs https --check --verbose
if %errorlevel% neq 0 (
    echo [è­¦å‘Š] è¯ä¹¦éªŒè¯å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ...
) else (
    echo [âœ“] è¯ä¹¦éªŒè¯æˆåŠŸ
)

echo ================================================================================
echo [æ­¥éª¤ 5/5] æ¸…ç†æµè§ˆå™¨ç¼“å­˜æŒ‡å¯¼
echo ================================================================================

echo [ä¿¡æ¯] è¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹æµè§ˆå™¨æ¸…ç†æ­¥éª¤ï¼š
echo.
echo ðŸŒ Chromeæµè§ˆå™¨ï¼š
echo   1. æŒ‰ Ctrl+Shift+Delete æ‰“å¼€æ¸…ç†å¯¹è¯æ¡†
echo   2. é€‰æ‹©"é«˜çº§"é€‰é¡¹å¡
echo   3. æ—¶é—´èŒƒå›´é€‰æ‹©"æ‰€æœ‰æ—¶é—´"
echo   4. å‹¾é€‰"CookieåŠå…¶ä»–ç½‘ç«™æ•°æ®"å’Œ"ç¼“å­˜çš„å›¾ç‰‡å’Œæ–‡ä»¶"
echo   5. ç‚¹å‡»"æ¸…é™¤æ•°æ®"
echo.
echo ðŸ”’ Chrome SSLçŠ¶æ€é‡ç½®ï¼š
echo   1. åœ¨åœ°å€æ è¾“å…¥: chrome://settings/security
echo   2. ç‚¹å‡»"ç®¡ç†è¯ä¹¦"
echo   3. åœ¨"å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæž„"ä¸­æ‰¾åˆ°"localhost"è¯ä¹¦
echo   4. ç¡®ä¿è¯ä¹¦å­˜åœ¨ä¸”æœ‰æ•ˆ
echo.
echo ðŸ’¡ æˆ–è€…å°è¯•åœ¨Chromeä¸­è®¿é—® chrome://flags/#allow-insecure-localhost
echo    å¯ç”¨"Allow invalid certificates for resources loaded from localhost"
echo.

echo ================================================================================
echo                                ä¿®å¤å®Œæˆ
echo ================================================================================
echo.
echo [âœ“] è¯ä¹¦ä¿®å¤å®Œæˆï¼
echo.
echo ðŸš€ æŽ¥ä¸‹æ¥è¯·ï¼š
echo.
echo   1. å…³é—­æ‰€æœ‰æµè§ˆå™¨çª—å£
echo   2. é‡å¯ Visual Studio 2022
echo   3. é‡æ–°è¿è¡Œé¡¹ç›®
echo   4. è®¿é—®: https://localhost:7001/digital-human-test.html
echo.
echo ðŸ’¡ å¦‚æžœä»æœ‰é—®é¢˜ï¼Œè¯·å°è¯•ï¼š
echo   - ä½¿ç”¨æ— ç—•æ¨¡å¼è®¿é—®
echo   - åœ¨Chromeåœ°å€æ ä¸­è¾“å…¥ thisisunsafeï¼ˆå½“çœ‹åˆ°è¯ä¹¦è­¦å‘Šæ—¶ï¼‰
echo   - ç‚¹å‡»"é«˜çº§" â†’ "ç»§ç»­å‰å¾€ localhostï¼ˆä¸å®‰å…¨ï¼‰"
echo.

:end
echo æŒ‰ä»»æ„é”®é€€å‡º...
pause >nul