<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whisperè¯­éŸ³è¯†åˆ«æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
        }
        .section h2 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .file-input {
            margin: 10px 0;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .recording {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ Whisperè¯­éŸ³è¯†åˆ«æµ‹è¯•</h1>
        
        <!-- å¥åº·æ£€æŸ¥ -->
        <div class="section">
            <h2>ğŸ” æœåŠ¡çŠ¶æ€æ£€æŸ¥</h2>
            <button class="btn" onclick="checkHealth()">æ£€æŸ¥WhisperæœåŠ¡çŠ¶æ€</button>
            <button class="btn" onclick="getEnvironment()">è·å–ç¯å¢ƒä¿¡æ¯</button>
            <div id="healthResult"></div>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ æµ‹è¯• -->
        <div class="section">
            <h2>ğŸ“ æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h2>
            <input type="file" id="audioFile" accept="audio/*" class="file-input">
            <button class="btn" onclick="transcribeFile()">è½¬å½•éŸ³é¢‘æ–‡ä»¶</button>
            <div id="fileResult"></div>
        </div>

        <!-- å½•éŸ³æµ‹è¯• -->
        <div class="section">
            <h2>ğŸ™ï¸ å½•éŸ³æµ‹è¯•</h2>
            <button class="btn" onclick="startRecording()" id="startBtn">å¼€å§‹å½•éŸ³</button>
            <button class="btn" onclick="stopRecording()" id="stopBtn" disabled>åœæ­¢å½•éŸ³</button>
            <div id="recordingStatus"></div>
            <div id="recordingResult"></div>
        </div>

        <!-- æ‰¹é‡æµ‹è¯• -->
        <div class="section">
            <h2>ğŸ“¦ æ‰¹é‡æµ‹è¯•</h2>
            <input type="file" id="batchFiles" accept="audio/*" multiple class="file-input">
            <button class="btn" onclick="transcribeBatch()">æ‰¹é‡è½¬å½•</button>
            <div id="batchResult"></div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        // å¥åº·æ£€æŸ¥
        async function checkHealth() {
            const resultDiv = document.getElementById('healthResult');
            resultDiv.innerHTML = '<div class="status info">æ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€...</div>';
            
            try {
                const response = await fetch('/api/WhisperTest/health');
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="status success">
                            âœ… æœåŠ¡çŠ¶æ€: ${data.isHealthy ? 'æ­£å¸¸' : 'å¼‚å¸¸'}
                        </div>
                        <div class="result">
æ”¯æŒæ ¼å¼: ${data.supportedFormats.join(', ')}
å¯ç”¨æ¨¡å‹: ${data.availableModels.join(', ')}
æ£€æŸ¥æ—¶é—´: ${new Date(data.timestamp).toLocaleString()}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ æ£€æŸ¥å¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è·å–ç¯å¢ƒä¿¡æ¯
        async function getEnvironment() {
            const resultDiv = document.getElementById('healthResult');
            resultDiv.innerHTML = '<div class="status info">æ­£åœ¨è·å–ç¯å¢ƒä¿¡æ¯...</div>';
            
            try {
                const response = await fetch('/api/WhisperTest/environment');
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="status success">âœ… ç¯å¢ƒä¿¡æ¯è·å–æˆåŠŸ</div>
                        <div class="result">
æ“ä½œç³»ç»Ÿ: ${data.environment.os}
å¹³å°: ${data.environment.platform}
æœºå™¨å: ${data.environment.machineName}
å¤„ç†å™¨æ•°: ${data.environment.processorCount}
å·¥ä½œé›†: ${(data.environment.workingSet / 1024 / 1024).toFixed(2)} MB
å½“å‰ç›®å½•: ${data.environment.currentDirectory}
Pythonè·¯å¾„: ${data.environment.pythonPath}
Whisperè·¯å¾„: ${data.environment.whisperPath}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ è·å–å¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è½¬å½•æ–‡ä»¶
        async function transcribeFile() {
            const fileInput = document.getElementById('audioFile');
            const resultDiv = document.getElementById('fileResult');
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="status error">âŒ è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="status info">æ­£åœ¨è½¬å½•éŸ³é¢‘æ–‡ä»¶...</div>';
            
            const formData = new FormData();
            formData.append('audioFile', fileInput.files[0]);
            
            try {
                const response = await fetch('/api/WhisperTest/transcribe', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="status success">âœ… è½¬å½•æˆåŠŸ</div>
                        <div class="result">
è½¬å½•æ–‡æœ¬: ${data.transcription.text || '(æ— æ–‡æœ¬)'}
ç½®ä¿¡åº¦: ${(data.transcription.confidence * 100).toFixed(2)}%
è¯­è¨€: ${data.transcription.language}
å¤„ç†æ—¶é—´: ${data.transcription.processingTime}ms
æ€»æ—¶é—´: ${data.transcription.totalTime}ms
æ–‡ä»¶ä¿¡æ¯:
  æ–‡ä»¶å: ${data.fileInfo.fileName}
  æ–‡ä»¶å¤§å°: ${(data.fileInfo.fileSize / 1024).toFixed(2)} KB
  å†…å®¹ç±»å‹: ${data.fileInfo.contentType}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ è½¬å½•å¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioFile = new File([audioBlob], 'recording.wav', { type: 'audio/wav' });
                    
                    // è‡ªåŠ¨è½¬å½•å½•éŸ³
                    transcribeRecording(audioFile);
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('recordingStatus').innerHTML = '<div class="status info"><span class="recording"></span> æ­£åœ¨å½•éŸ³...</div>';
                
            } catch (error) {
                document.getElementById('recordingStatus').innerHTML = `<div class="status error">âŒ å½•éŸ³å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('recordingStatus').innerHTML = '<div class="status info">å½•éŸ³å®Œæˆï¼Œæ­£åœ¨è½¬å½•...</div>';
            }
        }

        // è½¬å½•å½•éŸ³
        async function transcribeRecording(audioFile) {
            const resultDiv = document.getElementById('recordingResult');
            
            const formData = new FormData();
            formData.append('audioFile', audioFile);
            
            try {
                const response = await fetch('/api/WhisperTest/transcribe', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="status success">âœ… å½•éŸ³è½¬å½•æˆåŠŸ</div>
                        <div class="result">
è½¬å½•æ–‡æœ¬: ${data.transcription.text || '(æ— æ–‡æœ¬)'}
ç½®ä¿¡åº¦: ${(data.transcription.confidence * 100).toFixed(2)}%
è¯­è¨€: ${data.transcription.language}
å¤„ç†æ—¶é—´: ${data.transcription.processingTime}ms
æ€»æ—¶é—´: ${data.transcription.totalTime}ms
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ å½•éŸ³è½¬å½•å¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ‰¹é‡è½¬å½•
        async function transcribeBatch() {
            const fileInput = document.getElementById('batchFiles');
            const resultDiv = document.getElementById('batchResult');
            
            if (!fileInput.files.length) {
                resultDiv.innerHTML = '<div class="status error">âŒ è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="status info">æ­£åœ¨æ‰¹é‡è½¬å½•...</div>';
            
            const formData = new FormData();
            for (let file of fileInput.files) {
                formData.append('audioFiles', file);
            }
            
            try {
                const response = await fetch('/api/WhisperTest/transcribe-batch', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let resultsHtml = `
                        <div class="status success">âœ… æ‰¹é‡è½¬å½•å®Œæˆ</div>
                        <div class="result">
æ€»è®¡: ${data.summary.totalFiles} ä¸ªæ–‡ä»¶
æˆåŠŸ: ${data.summary.successCount} ä¸ª
å¤±è´¥: ${data.summary.failureCount} ä¸ª
æˆåŠŸç‡: ${data.summary.successRate.toFixed(2)}%
æ€»æ—¶é—´: ${data.summary.totalTime}ms

è¯¦ç»†ç»“æœ:
                    `;
                    
                    data.results.forEach((result, index) => {
                        resultsHtml += `
${index + 1}. ${result.fileName}
   æ–‡æœ¬: ${result.transcription.text || '(æ— æ–‡æœ¬)'}
   ç½®ä¿¡åº¦: ${(result.transcription.confidence * 100).toFixed(2)}%
   è¯­è¨€: ${result.transcription.language}
   å¤„ç†æ—¶é—´: ${result.transcription.processingTime}ms

                        `;
                    });
                    
                    resultsHtml += '</div>';
                    resultDiv.innerHTML = resultsHtml;
                } else {
                    resultDiv.innerHTML = `<div class="status error">âŒ æ‰¹é‡è½¬å½•å¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥å¥åº·çŠ¶æ€
        window.onload = function() {
            checkHealth();
        };
    </script>
</body>
</html> 