# 🔧 故障排除指南

## �� 常见问题及解决方案

### 1. 语音识别失败问题

**问题描述**: 语音识别时出现"系统找不到指定的文件"错误

**解决方案**:

#### 方法1：检查Whisper安装
```bash
# 检查whisper命令是否可用
whisper --help

# 如果不可用，尝试pip安装
pip install openai-whisper

# 或者使用python -m whisper
python -m whisper --help
```

#### 方法2：检查PATH环境变量
1. 确认Python Scripts目录在PATH中
2. 重启命令行或IDE
3. 运行测试脚本验证

#### 方法3：使用测试脚本
```batch
# 运行依赖测试
测试依赖.bat
```

**技术细节**:
- 系统现在支持多种Whisper调用方式
- 自动检测并使用可用的命令路径
- 增强了错误处理和日志记录
- 自动清理临时文件

### 2. 发送消息报错问题

**问题描述**: 发送消息时API返回错误，无法生成数字人视频

**解决方案**:

#### 检查依赖服务
```bash
# 检查Ollama服务
curl http://localhost:11434/api/version

# 检查Edge-TTS
edge-tts --help

# 检查FFmpeg
ffmpeg -version
```

#### 检查头像文件
1. 确认选择的头像存在
2. 检查头像文件权限
3. 验证模板配置正确

#### 查看详细错误日志
- 检查 `logs/` 目录中的日志文件
- 查看浏览器控制台错误信息
- 确认API响应状态

**技术改进**:
- 增强了错误处理和返回详细错误信息
- 添加了文件存在性检查
- 改进了视频生成流程验证

### 3. 默认头像管理问题

**问题描述**: 需要删除默认头像，只保留自定义上传的头像

**解决方案**:

#### 系统更新
- ✅ 已删除所有默认头像
- ✅ 只显示用户上传的自定义头像
- ✅ 头像数据持久化存储
- ✅ 添加占位符提示上传

#### 上传自定义头像
1. 点击"📤 上传头像"按钮
2. 填写头像名称和描述
3. 选择图片文件（JPG/PNG，最大10MB）
4. 点击"创建模板"完成上传

#### 头像管理
- 头像存储在 `wwwroot/templates/` 目录
- 配置文件保存为JSON格式
- 支持删除、编辑和复制头像
- 按创建时间排序显示

### 4. 临时文件清理问题

**问题描述**: 语音识别后临时文件未清理，占用磁盘空间

**解决方案**:

#### 自动清理机制
- ✅ 每次识别后自动清理临时文件
- ✅ 清理超过1小时的过期文件
- ✅ 使用finally块确保文件清理
- ✅ 详细的清理日志记录

#### 手动清理
```bash
# 清理temp目录
cd temp
del whisper_*.*

# 清理Whisper输出目录
cd temp/whisper_output
del *.*
```

### 5. 界面无法滚动问题

**问题描述**: 页面内容显示不完整，无法向下滚动

**解决方案**:
- ✅ 已修复CSS样式问题
- ✅ 刷新页面即可正常滚动
- ✅ 支持鼠标滚轮和键盘方向键
- ✅ 移动设备上支持触摸滚动

### 6. HTTPS无法访问问题

**问题描述**: https://localhost:7135 无法访问，显示连接错误

**解决方案**:

#### 方法1：使用启动脚本（推荐）
```batch
# 双击运行
启动系统.bat
```

#### 方法2：手动信任证书
```bash
# 在项目目录中运行
dotnet dev-certs https --trust
```

#### 方法3：检查证书状态
```bash
# 检查证书是否已安装
dotnet dev-certs https --check

# 如果证书无效，重新生成
dotnet dev-certs https --clean
dotnet dev-certs https --trust
```

#### 方法4：浏览器设置
1. 访问 https://localhost:7135
2. 点击"高级"
3. 点击"继续访问 localhost（不安全）"
4. 浏览器会记住这个选择

### 7. 录音权限问题

**问题描述**: 录音功能不工作，显示权限错误

**解决方案**:

#### 检查访问协议
- ✅ 使用HTTPS: https://localhost:7135
- ❌ 避免使用HTTP（录音权限受限）

#### 浏览器权限设置
**Chrome浏览器**:
1. 点击地址栏左侧的🔒图标
2. 选择"网站设置"
3. 将"麦克风"设置为"允许"

**Edge浏览器**:
1. 点击地址栏右侧的🔒图标
2. 选择"此网站的权限"
3. 将"麦克风"设置为"允许"

#### 系统权限检查
1. 确认麦克风设备正常工作
2. 检查系统麦克风权限
3. 确认没有其他应用占用麦克风

### 4. Ollama服务问题

**问题描述**: 无法连接到Ollama服务

**解决方案**:

#### 启动Ollama服务
```bash
# 新开命令行窗口
ollama serve
```

#### 检查服务状态
```bash
# 检查服务是否运行
curl http://localhost:11434/api/version

# 检查可用模型
ollama list
```

#### 下载模型
```bash
# 下载推荐模型
ollama pull qwen2.5:14b-instruct-q4_0
```

### 5. 端口占用问题

**问题描述**: 端口被占用，无法启动应用

**解决方案**:

#### 检查端口占用
```bash
# 检查端口7135
netstat -an | findstr 7135

# 检查端口5109
netstat -an | findstr 5109
```

#### 终止占用进程
```bash
# 查找占用进程
netstat -ano | findstr :7135

# 终止进程（替换PID）
taskkill /F /PID <进程ID>
```

#### 使用其他端口
```bash
# 使用自定义端口启动
dotnet run --urls="https://localhost:8443;http://localhost:8080"
```

### 6. 头像加载问题

**问题描述**: 数字人头像不显示或加载失败

**解决方案**:

#### 检查头像文件
1. 确认 `wwwroot/images/avatars/` 目录存在
2. 检查头像文件格式（JPG/PNG）
3. 确认文件权限正确

#### 检查SadTalker路径
1. 确认SadTalker安装在 `F:/AI/SadTalker/`
2. 检查 `examples/source_image/` 目录
3. 确认有头像文件存在

#### 刷新头像列表
- 点击"🔄 刷新"按钮
- 重新加载页面

### 7. 视频生成问题

**问题描述**: 数字人视频生成失败

**解决方案**:

#### 检查依赖
1. 确认FFmpeg已安装并在PATH中
2. 检查Python环境配置
3. 确认SadTalker模型文件完整

#### 检查磁盘空间
1. 确认有足够的磁盘空间
2. 清理临时文件
3. 检查输出目录权限

### 8. 依赖缺失问题

**问题描述**: 系统提示缺少Python依赖或工具

**解决方案**:

#### 自动安装依赖
```batch
# 双击运行依赖安装脚本
安装依赖.bat
```

#### 手动安装依赖
```bash
# 安装Edge-TTS
pip install edge-tts

# 安装Whisper
pip install openai-whisper

# 验证安装
edge-tts --help
whisper --help
```

#### 检查FFmpeg
```bash
# 检查FFmpeg是否安装
ffmpeg -version

# 如果未安装，请下载并添加到PATH
# 下载地址: https://ffmpeg.org/download.html
```

### 9. 语音识别优化问题

**问题描述**: 语音识别准确度不高或速度慢

**解决方案**:

#### 改善录音质量
1. 使用高质量麦克风
2. 在安静环境中录音
3. 说话清晰、语速适中
4. 避免背景噪音

#### 调整Whisper模型
```bash
# 使用更大的模型提高准确度
whisper --model medium your_audio.wav

# 可用模型: tiny, base, small, medium, large
```

#### 网络连接优化
1. 确保网络连接稳定
2. 使用HTTPS协议
3. 关闭VPN或代理

### 10. 数字人生成失败问题

**问题描述**: 发送消息后无法生成数字人视频

**解决方案**:

#### 检查后端服务
```bash
# 检查API健康状态
curl -k https://localhost:7135/health

# 检查Ollama服务
curl http://localhost:11434/api/version
```

#### 检查系统资源
1. 确保有足够的磁盘空间
2. 检查内存使用情况
3. 确认GPU驱动正常

#### 查看日志文件
1. 检查 `logs/` 目录中的日志文件
2. 查看浏览器控制台错误
3. 确认配置文件设置正确

### 8. 性能问题

**问题描述**: 系统响应缓慢或卡顿

**解决方案**:

#### 硬件优化
1. 确认GPU驱动最新
2. 检查内存使用情况
3. 关闭不必要的程序

#### 软件优化
1. 降低视频质量设置
2. 使用预渲染视频
3. 启用GPU加速

## 🛠️ 调试工具

### 1. 浏览器开发者工具
- 按F12打开开发者工具
- 查看Console标签页错误信息
- 检查Network标签页请求状态

### 2. 后端日志
- 查看 `logs/` 目录中的日志文件
- 检查控制台输出信息
- 使用详细日志级别

### 3. 系统监控
```bash
# 检查进程
tasklist | findstr FlowithRealizationAPI

# 检查端口
netstat -an | findstr 7135

# 检查服务
curl -k https://localhost:7135/health
```

## 📞 获取帮助

如果以上方案都无法解决问题，请：

1. 收集错误信息
2. 记录复现步骤
3. 检查系统环境
4. 查看日志文件

---

**希望这个指南能帮助您解决问题！** 🎯 