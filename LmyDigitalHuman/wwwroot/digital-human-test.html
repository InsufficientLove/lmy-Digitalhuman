<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­—äººç³»ç»Ÿæµ‹è¯•å¹³å°</title>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .video-display {
            text-align: center;
            min-height: 400px;
        }

        .video-container {
            position: relative;
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #digitalHumanVideo {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
            border: 2px solid #007bff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .placeholder {
            color: #6c757d;
            font-size: 1.2rem;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .interaction-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section {
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }

        .section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #495057;
            font-size: 1.1rem;
        }

        /* WebRTCæ ·å¼ */
        .webrtc-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .webrtc-controls input[type="text"] {
            flex: 1;
            min-width: 200px;
        }

        .stats-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .stats-panel h5 {
            margin: 0 0 10px 0;
            color: #495057;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .stat-item span:last-child {
            font-weight: bold;
            color: #28a745;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-group label {
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            display: block;
        }

        .file-upload-label:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .recording-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            color: #dc3545;
            font-weight: 500;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: #dc3545;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .status-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .status-label {
            font-weight: 500;
            color: #495057;
        }

        .status-value {
            color: #6c757d;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .template-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .template-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .template-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 10px;
            display: block;
        }

        .template-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .template-info {
            font-size: 12px;
            color: #6c757d;
        }

        .logs {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-info { color: #0066cc; }
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .templates-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 1% auto;
            padding: 0;
            border-radius: 15px;
            width: 95%;
            max-width: 650px;
            max-height: 95vh;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 2px solid #e9ecef;
            flex-shrink: 0;
        }

        .modal-header h3 {
            margin: 0;
            color: #495057;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px 30px;
            max-height: calc(95vh - 140px);
            -webkit-overflow-scrolling: touch;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
            flex-shrink: 0;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .input-group {
            flex: 1;
        }

        .preview-container {
            text-align: center;
            margin: 15px 0;
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– æ•°å­—äººç³»ç»Ÿæµ‹è¯•å¹³å°</h1>
            <p>ä½“éªŒæœ€æ–°çš„AIæ•°å­—äººæŠ€æœ¯ - æ”¯æŒå®æ—¶å¯¹è¯ã€è¯­éŸ³äº¤äº’å’Œä¸ªæ€§åŒ–æ¨¡æ¿</p>
        </div>

        <div class="main-grid">
            <!-- å·¦ä¾§ï¼šæ•°å­—äººè§†é¢‘æ˜¾ç¤º -->
            <div class="card video-display">
                <h3>ğŸ­ æ•°å­—äººå±•ç¤º</h3>
                <div class="video-container">
                    <video id="digitalHumanVideo" controls style="display: none;">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                    </video>
                    <div id="videoPlaceholder" class="placeholder">
                        é€‰æ‹©æ¨¡æ¿å¹¶å¼€å§‹å¯¹è¯ï¼Œæ•°å­—äººå°†åœ¨è¿™é‡Œå‡ºç°
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="playVideo()">â–¶ï¸ æ’­æ”¾</button>
                    <button class="btn btn-secondary" onclick="pauseVideo()">â¸ï¸ æš‚åœ</button>
                    <button class="btn btn-secondary" onclick="stopVideo()">â¹ï¸ åœæ­¢</button>
                    <button class="btn btn-success" onclick="downloadVideo()" id="downloadBtn" style="display: none;">ğŸ’¾ ä¸‹è½½</button>
                </div>

                <div class="status-panel">
                    <div class="status-item">
                        <span class="status-label">å½“å‰æ¨¡æ¿:</span>
                        <span class="status-value" id="currentTemplate">æœªé€‰æ‹©</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">å¤„ç†çŠ¶æ€:</span>
                        <span class="status-value" id="processingStatus">å¾…æœºä¸­</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">å¤„ç†æ—¶é—´:</span>
                        <span class="status-value" id="processingTime">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">è¿æ¥çŠ¶æ€:</span>
                        <span class="status-value" id="connectionStatus">æœªè¿æ¥</span>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šäº¤äº’æ§åˆ¶é¢æ¿ -->
            <div class="card interaction-panel">
                <h3>ğŸ›ï¸ äº¤äº’æ§åˆ¶é¢æ¿</h3>

                <!-- æ¨¡æ¿é€‰æ‹© -->
                <div class="section">
                    <h3>ğŸ“‹ é€‰æ‹©æ•°å­—äººæ¨¡æ¿</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="loadTemplates()">ğŸ”„ åˆ·æ–°æ¨¡æ¿åˆ—è¡¨</button>
                        <button class="btn btn-success" onclick="showCreateTemplateModal()">â• åˆ›å»ºæ–°æ¨¡æ¿</button>
                        <button class="btn btn-success" onclick="generateWelcomeVideoManual()" id="generateWelcomeBtn" style="display: none;">ğŸ¬ ç”Ÿæˆæ¬¢è¿è§†é¢‘</button>
                    </div>
                    <div id="templatesContainer" class="templates-grid">
                        <!-- åŠ¨æ€åŠ è½½æ¨¡æ¿ -->
                    </div>
                </div>

                <!-- æ–‡æœ¬å¯¹è¯ -->
                <div class="section">
                    <h3>ğŸ’¬ æ–‡æœ¬å¯¹è¯</h3>
                    <div class="input-group">
                        <label for="textInput">è¾“å…¥å¯¹è¯å†…å®¹:</label>
                        <textarea id="textInput" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¦æ•°å­—äººè¯´çš„è¯..."></textarea>
                    </div>
                    <div class="input-group">
                        <label for="emotionSelect">æƒ…æ„Ÿé€‰æ‹©:</label>
                        <select id="emotionSelect" class="form-control">
                            <option value="neutral">è‡ªç„¶</option>
                            <option value="happy">å¼€å¿ƒ</option>
                            <option value="professional">ä¸“ä¸š</option>
                            <option value="friendly">å‹å¥½</option>
                            <option value="excited">å…´å¥‹</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="qualitySelect">è§†é¢‘è´¨é‡:</label>
                        <select id="qualitySelect" class="form-control">
                            <option value="low">ä½è´¨é‡ (å¿«é€Ÿ)</option>
                            <option value="medium" selected>ä¸­ç­‰è´¨é‡ (æ¨è)</option>
                            <option value="high">é«˜è´¨é‡ (æ…¢é€Ÿ)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="sendTextMessage()" id="sendTextBtn">ğŸš€ ç”Ÿæˆæ•°å­—äººè§†é¢‘</button>
                </div>

                <!-- è¯­éŸ³å¯¹è¯ -->
                <div class="section">
                    <h3>ğŸ™ï¸ è¯­éŸ³å¯¹è¯</h3>
                    <div class="input-group">
                        <label>è¯­éŸ³è¾“å…¥æ–¹å¼:</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button class="btn btn-success" onclick="startRecording()" id="recordBtn">ğŸ¤ å¼€å§‹å½•éŸ³</button>
                            <button class="btn btn-danger" onclick="stopRecording()" id="stopRecordBtn" style="display: none;">â¹ï¸ åœæ­¢å½•éŸ³</button>
                        </div>
                        <div class="recording-indicator" id="recordingIndicator">
                            <div class="recording-dot"></div>
                            <span>æ­£åœ¨å½•éŸ³...</span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>æˆ–ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶:</label>
                        <div class="file-upload">
                            <input type="file" id="audioFile" accept="audio/*">
                            <label for="audioFile" class="file-upload-label">
                                ğŸ“ é€‰æ‹©éŸ³é¢‘æ–‡ä»¶ (æ”¯æŒ MP3, WAV, M4A)
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="sendAudioMessage()" id="sendAudioBtn">ğŸµ å¤„ç†è¯­éŸ³å¯¹è¯</button>
                        <button class="btn btn-secondary" onclick="testSpeechRecognition()" id="testSpeechBtn">ğŸ” æµ‹è¯•è¯­éŸ³è¯†åˆ«</button>
                    </div>
                </div>

                <!-- å®æ—¶å¯¹è¯ -->
                <div class="section">
                    <h3>âš¡ å®æ—¶å¯¹è¯</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="startRealtimeConversation()" id="startRealtimeBtn">ğŸ”´ å¼€å§‹å®æ—¶å¯¹è¯</button>
                        <button class="btn btn-danger" onclick="endRealtimeConversation()" id="endRealtimeBtn" style="display: none;">â¹ï¸ ç»“æŸå¯¹è¯</button>
                    </div>
                    <div id="realtimeStatus" style="display: none; color: #28a745; font-weight: bold;">
                        âœ… å®æ—¶å¯¹è¯å·²è¿æ¥ï¼Œå¯ä»¥å¼€å§‹è¯­éŸ³äº¤äº’
                    </div>
                </div>

                <!-- WebRTCå®æ—¶é€šä¿¡ -->
                <div class="section">
                    <h3>ğŸŒ WebRTCå®æ—¶é€šä¿¡ <span style="color: #ff6b6b; font-size: 0.8em;">(æ–°åŠŸèƒ½)</span></h3>
                    <div class="webrtc-section">
                        <div class="webrtc-video-container" style="margin-bottom: 15px;">
                            <video id="remoteVideo" autoplay playsinline muted 
                                   style="width: 100%; max-height: 200px; border-radius: 8px; background: #000; border: 2px solid #ddd;"></video>
                            <div style="text-align: center; margin-top: 5px; font-size: 0.9em; color: #666;">
                                æ•°å­—äººå®æ—¶è§†é¢‘å°†åœ¨è¿™é‡Œæ˜¾ç¤º
                            </div>
                        </div>
                        <div id="controls" class="webrtc-controls">
                            <!-- WebRTCæ§åˆ¶æŒ‰é’®å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <div id="stats" class="webrtc-stats" style="margin-top: 15px;">
                            <!-- ç»Ÿè®¡ä¿¡æ¯å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨ï¼šæ—¥å¿—å’Œè¿›åº¦ -->
        <div class="card">
            <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€ä¸æ—¥å¿—</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="logs" id="systemLogs">
                <div class="log-entry log-info">[ç³»ç»Ÿ] æ•°å­—äººç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ...</div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºæ¨¡æ¿æ¨¡æ€æ¡† -->
    <div id="createTemplateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ­ åˆ›å»ºæ–°çš„æ•°å­—äººæ¨¡æ¿</h3>
                <span class="close" onclick="hideCreateTemplateModal()">&times;</span>
            </div>
            
            <form id="createTemplateForm" onsubmit="createTemplate(event)">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="input-group">
                            <label for="templateName">æ˜¾ç¤ºåç§° *</label>
                            <input type="text" id="templateName" class="form-control" required placeholder="è¯·è¾“å…¥ä¸­æ–‡æ˜¾ç¤ºåç§°ï¼Œå¦‚ï¼šå°å“ˆ">
                        </div>
                        <div class="input-group">
                            <label for="systemName">è‹±æ–‡æ ‡è¯† *</label>
                            <input type="text" id="systemName" class="form-control" required 
                                   placeholder="è¯·è¾“å…¥è‹±æ–‡æ ‡è¯†ï¼Œå¦‚ï¼šxiaoha" 
                                   pattern="[a-zA-Z0-9_-]+" 
                                   title="åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦"
                                   oninput="validateSystemName(this)">
                            <small style="color: #666; font-size: 0.8em;">ç”¨äºæ–‡ä»¶å­˜å‚¨ï¼Œåªèƒ½åŒ…å«è‹±æ–‡ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="input-group">
                            <label for="templateDescription">æ¨¡æ¿æè¿°</label>
                            <input type="text" id="templateDescription" class="form-control" placeholder="ç®€çŸ­æè¿°è¿™ä¸ªæ¨¡æ¿">
                        </div>
                        <div class="input-group">
                            <!-- å ä½ï¼Œä¿æŒå¸ƒå±€å¹³è¡¡ -->
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="input-group">
                            <label for="templateGender">æ€§åˆ«</label>
                            <select id="templateGender" class="form-control">
                                <option value="female">å¥³æ€§</option>
                                <option value="male">ç”·æ€§</option>
                                <option value="other">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="templateStyle">é£æ ¼</label>
                            <select id="templateStyle" class="form-control">
                                <option value="professional">ä¸“ä¸š</option>
                                <option value="casual">ä¼‘é—²</option>
                                <option value="elegant">ä¼˜é›…</option>
                                <option value="modern">ç°ä»£</option>
                                <option value="classic">ç»å…¸</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="templateImage">ä¸Šä¼ å¤´åƒå›¾ç‰‡ *</label>
                        <div class="file-upload">
                            <input type="file" id="templateImage" accept="image/*" required onchange="previewTemplateImage(event)">
                            <label for="templateImage" class="file-upload-label">
                                ğŸ“· é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ (æ”¯æŒ JPG, PNG, WebP)
                            </label>
                        </div>
                    </div>

                    <div class="preview-container" id="imagePreviewContainer" style="display: none;">
                        <img id="imagePreview" class="preview-image" alt="é¢„è§ˆå›¾ç‰‡">
                    </div>

                    <div class="input-group">
                        <label for="voiceSettings">è¯­éŸ³è®¾ç½®</label>
                        <textarea id="voiceSettings" class="form-control" placeholder="è¯­éŸ³è®¾ç½® (JSONæ ¼å¼ï¼Œå¯é€‰)">{"voice": "zh-CN-XiaoxiaoNeural", "rate": "medium", "pitch": "medium"}</textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="hideCreateTemplateModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary" id="createTemplateBtn">ğŸ­ åˆ›å»ºæ¨¡æ¿</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentTemplateId = null;
        let signalRConnection = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let realtimeConversationId = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });

        async function initializeSystem() {
            addLog('ç³»ç»Ÿåˆå§‹åŒ–ä¸­...', 'info');
            
            // æ£€æŸ¥HTTPSçŠ¶æ€å’Œæµè§ˆå™¨å…¼å®¹æ€§
            checkHttpsAndBrowser();
            
            // åˆå§‹åŒ–SignalRè¿æ¥
            await initializeSignalR();
            
            // åŠ è½½æ¨¡æ¿åˆ—è¡¨
            await loadTemplates();
            
            // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
            checkBrowserSupport();
            
            addLog('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');
        }

        function checkHttpsAndBrowser() {
            const isHttps = location.protocol === 'https:';
            const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            
            if (!isHttps && isLocalhost) {
                addLog('å½“å‰ä½¿ç”¨HTTPè®¿é—®ï¼Œéº¦å…‹é£åŠŸèƒ½éœ€è¦ç”¨æˆ·æˆæƒ', 'info');
            } else if (isHttps) {
                addLog('HTTPSç¯å¢ƒæ£€æµ‹å®Œæˆ', 'success');
            }
        }

        async function initializeSignalR() {
            try {
                signalRConnection = new signalR.HubConnectionBuilder()
                    .withUrl("/conversationHub")
                    .build();

                signalRConnection.on("ReceiveConversationResponse", function (response) {
                    handleRealtimeResponse(response);
                });

                signalRConnection.on("ReceiveError", function (error) {
                    addLog(`å®æ—¶å¯¹è¯é”™è¯¯: ${error}`, 'error');
                });

                await signalRConnection.start();
                updateConnectionStatus('å·²è¿æ¥');
                addLog('SignalRè¿æ¥å·²å»ºç«‹', 'success');
            } catch (err) {
                addLog(`SignalRè¿æ¥å¤±è´¥: ${err}`, 'error');
                updateConnectionStatus('è¿æ¥å¤±è´¥');
            }
        }

        async function loadTemplates() {
            try {
                addLog('æ­£åœ¨åŠ è½½æ•°å­—äººæ¨¡æ¿...', 'info');
                updateProgress(20);
                
                const response = await fetch('/api/digitalhumantemplate/list');
                const data = await response.json();
                
                updateProgress(60);
                
                if (data.success) {
                    displayTemplates(data.templates);
                    addLog(`å·²åŠ è½½ ${data.templates.length} ä¸ªæ¨¡æ¿`, 'success');
                } else {
                    addLog('åŠ è½½æ¨¡æ¿å¤±è´¥', 'error');
                }
                
                updateProgress(100);
                setTimeout(() => updateProgress(0), 1000);
            } catch (error) {
                addLog(`åŠ è½½æ¨¡æ¿é”™è¯¯: ${error.message}`, 'error');
                updateProgress(0);
            }
        }

        function displayTemplates(templates) {
            const container = document.getElementById('templatesContainer');
            container.innerHTML = '';

            templates.forEach(template => {
                const templateCard = document.createElement('div');
                templateCard.className = 'template-card';
                
                // æ ¹æ®çŠ¶æ€è®¾ç½®æ ·å¼å’Œè¡Œä¸º
                if (template.status === 'ready') {
                    // æ­£å¸¸å¯ç”¨æ¨¡æ¿
                    templateCard.onclick = (event) => selectTemplate(template, event);
                    templateCard.innerHTML = `
                        <img src="${template.imageUrl || '/images/default-avatar.svg'}" 
                             alt="${template.templateName}" class="template-image"
                             onerror="this.src='/images/default-avatar.svg'">
                        <div class="template-name">${template.templateName}</div>
                        <div class="template-info">${template.gender} Â· ${template.style}</div>
                    `;
                } else if (template.status === 'processing') {
                    // é¢„å¤„ç†ä¸­çš„æ¨¡æ¿ - ç¦ç”¨çŠ¶æ€
                    templateCard.style.opacity = '0.6';
                    templateCard.style.cursor = 'not-allowed';
                    templateCard.innerHTML = `
                        <img src="${template.imageUrl || '/images/default-avatar.svg'}" 
                             alt="${template.templateName}" class="template-image"
                             onerror="this.src='/images/default-avatar.svg'">
                        <div class="template-name">${template.templateName}</div>
                        <div class="template-info" style="color: #ffc107;">â³ é¢„å¤„ç†ä¸­...</div>
                    `;
                } else if (template.status === 'error') {
                    // é¢„å¤„ç†å¤±è´¥çš„æ¨¡æ¿ - é”™è¯¯çŠ¶æ€
                    templateCard.style.opacity = '0.6';
                    templateCard.style.cursor = 'not-allowed';
                    templateCard.innerHTML = `
                        <img src="${template.imageUrl || '/images/default-avatar.svg'}" 
                             alt="${template.templateName}" class="template-image"
                             onerror="this.src='/images/default-avatar.svg'">
                        <div class="template-name">${template.templateName}</div>
                        <div class="template-info" style="color: #dc3545;">âŒ é¢„å¤„ç†å¤±è´¥</div>
                    `;
                } else {
                    // å…¶ä»–çŠ¶æ€ - æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
                    templateCard.innerHTML = `
                        <img src="${template.imageUrl || '/images/default-avatar.svg'}" 
                             alt="${template.templateName}" class="template-image"
                             onerror="this.src='/images/default-avatar.svg'">
                        <div class="template-name">${template.templateName}</div>
                        <div class="template-info">${template.status || 'æœªçŸ¥çŠ¶æ€'}</div>
                    `;
                }
                
                container.appendChild(templateCard);
            });
            
            // ç»Ÿè®¡æ˜¾ç¤ºä¿¡æ¯
            const readyCount = templates.filter(t => t.status === 'ready').length;
            const processingCount = templates.filter(t => t.status === 'processing').length;
            const errorCount = templates.filter(t => t.status === 'error').length;
            
            if (readyCount === 0 && (processingCount > 0 || errorCount > 0)) {
                addLog(`æ¨¡æ¿çŠ¶æ€: ${readyCount}å¯ç”¨, ${processingCount}é¢„å¤„ç†ä¸­, ${errorCount}å¤±è´¥`, 'warning');
            } else {
                addLog(`æ¨¡æ¿çŠ¶æ€: ${readyCount}å¯ç”¨, ${processingCount}é¢„å¤„ç†ä¸­, ${errorCount}å¤±è´¥`, 'info');
            }
        }

        function selectTemplate(template, event) {
            // æ£€æŸ¥æ¨¡æ¿çŠ¶æ€
            if (template.status !== 'ready') {
                if (template.status === 'processing') {
                    alert('æ¨¡æ¿æ­£åœ¨é¢„å¤„ç†ä¸­ï¼Œè¯·ç¨åå†è¯•');
                } else if (template.status === 'error') {
                    alert('æ¨¡æ¿é¢„å¤„ç†å¤±è´¥ï¼Œæ— æ³•ä½¿ç”¨');
                } else {
                    alert('æ¨¡æ¿çŠ¶æ€å¼‚å¸¸ï¼Œæ— æ³•ä½¿ç”¨');
                }
                return;
            }
            
            // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
            event.currentTarget.classList.add('selected');
            
            currentTemplateId = template.templateId;
            document.getElementById('currentTemplate').textContent = template.templateName;
            
            addLog(`å·²é€‰æ‹©æ¨¡æ¿: ${template.templateName}ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»ç”Ÿæˆè§†é¢‘`, 'info');
            updateProcessingStatus('æ¨¡æ¿å·²é€‰æ‹©ï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ');
            
            // æ˜¾ç¤ºç”Ÿæˆæ¬¢è¿è§†é¢‘æŒ‰é’®
            document.getElementById('generateWelcomeBtn').style.display = 'inline-block';
            
            // ğŸ¯ ä¸å†è‡ªåŠ¨ç”Ÿæˆæ¬¢è¿è§†é¢‘ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨è§¦å‘
            // generateWelcomeVideo(template); // å·²ç§»é™¤è‡ªåŠ¨è§¦å‘
        }

        async function generateWelcomeVideo(template) {
            addLog('æ­£åœ¨ç”Ÿæˆæ¬¢è¿è§†é¢‘...', 'info');
            updateProcessingStatus('ç”Ÿæˆæ¬¢è¿è§†é¢‘ä¸­...');
            updateProgress(20);

            try {
                const response = await fetch('/api/conversation/welcome', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        templateId: template.templateId,
                        quality: 'medium'
                    })
                });

                updateProgress(80);
                const result = await response.json();
                updateProgress(100);

                if (result.success) {
                    if (result.videoUrl) {
                        displayVideo(result.videoUrl);
                        addLog(`æ¬¢è¿è§†é¢‘ç”ŸæˆæˆåŠŸ! è€—æ—¶: ${result.processingTime}`, 'success');
                        updateProcessingStatus('æ¬¢è¿è§†é¢‘å·²å°±ç»ª');
                    } else {
                        // åªæœ‰éŸ³é¢‘ï¼Œæ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
                        displayAudio(result.audioUrl);
                        addLog(`æ¬¢è¿éŸ³é¢‘ç”ŸæˆæˆåŠŸ (è§†é¢‘ç”Ÿæˆå¤±è´¥)! è€—æ—¶: ${result.processingTime}`, 'warning');
                        updateProcessingStatus('æ¬¢è¿éŸ³é¢‘å·²å°±ç»ª');
                    }
                } else {
                    addLog(`æ¬¢è¿è§†é¢‘ç”Ÿæˆå¤±è´¥: ${result.message}`, 'error');
                    updateProcessingStatus('æ¬¢è¿è§†é¢‘ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                addLog(`ç”Ÿæˆæ¬¢è¿è§†é¢‘é”™è¯¯: ${error.message}`, 'error');
                updateProcessingStatus('æ¬¢è¿è§†é¢‘ç”Ÿæˆå¤±è´¥');
            } finally {
                setTimeout(() => updateProgress(0), 1000);
            }
        }

        async function generateWelcomeVideoManual() {
            if (!currentTemplateId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ•°å­—äººæ¨¡æ¿');
                return;
            }
            
            // æ‰¾åˆ°å½“å‰é€‰ä¸­çš„æ¨¡æ¿
            const selectedCard = document.querySelector('.template-card.selected');
            if (!selectedCard) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ•°å­—äººæ¨¡æ¿');
                return;
            }
            
            // ä»æ¨¡æ¿åˆ—è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„æ¨¡æ¿å¯¹è±¡
            const templateName = selectedCard.querySelector('.template-name').textContent;
            const template = {
                templateId: currentTemplateId,
                templateName: templateName
            };
            
            // ç”Ÿæˆæ¬¢è¿è§†é¢‘
            await generateWelcomeVideo(template);
        }

        async function sendTextMessage() {
            const textInput = document.getElementById('textInput');
            const emotion = document.getElementById('emotionSelect').value;
            const quality = document.getElementById('qualitySelect').value;
            
            if (!currentTemplateId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ•°å­—äººæ¨¡æ¿');
                return;
            }
            
            if (!textInput.value.trim()) {
                alert('è¯·è¾“å…¥å¯¹è¯å†…å®¹');
                return;
            }

            const sendBtn = document.getElementById('sendTextBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'â³ å¤„ç†ä¸­...';
            
            updateProcessingStatus('æ­£åœ¨ç”Ÿæˆæ•°å­—äººè§†é¢‘...');
            addLog(`å¼€å§‹å¤„ç†æ–‡æœ¬: "${textInput.value.substring(0, 30)}..."`, 'info');
            
            const startTime = Date.now();
            updateProgress(10);

            try {
                const response = await fetch('/api/conversation/text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        templateId: currentTemplateId,
                        text: textInput.value,
                        emotion: emotion,
                        quality: quality,
                        useCache: true
                    })
                });

                updateProgress(70);
                const result = await response.json();
                updateProgress(90);

                if (result.success) {
                    const processingTime = Date.now() - startTime;
                    
                    // æ˜¾ç¤ºè§†é¢‘
                    displayVideo(result.videoUrl);
                    
                    // æ›´æ–°çŠ¶æ€
                    updateProcessingStatus('ç”Ÿæˆå®Œæˆ');
                    updateProcessingTime(`${processingTime}ms`);
                    
                    addLog(`è§†é¢‘ç”ŸæˆæˆåŠŸ! è€—æ—¶: ${result.processingTime}ms`, 'success');
                    if (result.fromCache) {
                        addLog('ç»“æœæ¥è‡ªç¼“å­˜ï¼Œå“åº”æ›´å¿«', 'info');
                    }
                } else {
                    addLog(`å¤„ç†å¤±è´¥: ${result.message}`, 'error');
                    updateProcessingStatus('å¤„ç†å¤±è´¥');
                }
            } catch (error) {
                addLog(`è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
                updateProcessingStatus('è¯·æ±‚å¤±è´¥');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'ğŸš€ ç”Ÿæˆæ•°å­—äººè§†é¢‘';
                updateProgress(100);
                setTimeout(() => updateProgress(0), 1000);
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = function(event) {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = function() {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    processAudioBlob(audioBlob);
                };

                mediaRecorder.start();
                isRecording = true;
                
                document.getElementById('recordBtn').style.display = 'none';
                document.getElementById('stopRecordBtn').style.display = 'inline-block';
                document.getElementById('recordingIndicator').style.display = 'flex';
                
                addLog('å¼€å§‹å½•éŸ³...', 'info');
            } catch (error) {
                addLog(`å½•éŸ³å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                
                document.getElementById('recordBtn').style.display = 'inline-block';
                document.getElementById('stopRecordBtn').style.display = 'none';
                document.getElementById('recordingIndicator').style.display = 'none';
                
                addLog('å½•éŸ³å®Œæˆï¼Œæ­£åœ¨å¤„ç†...', 'info');
            }
        }

        async function sendAudioMessage() {
            const audioFile = document.getElementById('audioFile').files[0];
            
            if (!currentTemplateId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ•°å­—äººæ¨¡æ¿');
                return;
            }
            
            if (!audioFile) {
                alert('è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶æˆ–è¿›è¡Œå½•éŸ³');
                return;
            }

            const formData = new FormData();
            formData.append('templateId', currentTemplateId);
            formData.append('audioFile', audioFile);
            formData.append('quality', document.getElementById('qualitySelect').value);
            formData.append('enableEmotionDetection', 'true');
            formData.append('useCache', 'true');

            await processAudioFormData(formData);
        }

        async function processAudioBlob(audioBlob) {
            if (!currentTemplateId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ•°å­—äººæ¨¡æ¿');
                return;
            }

            const formData = new FormData();
            formData.append('templateId', currentTemplateId);
            formData.append('audioFile', audioBlob, 'recording.wav');
            formData.append('quality', document.getElementById('qualitySelect').value);
            formData.append('enableEmotionDetection', 'true');
            formData.append('useCache', 'true');

            await processAudioFormData(formData);
        }

        async function processAudioFormData(formData) {
            const sendBtn = document.getElementById('sendAudioBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'â³ å¤„ç†ä¸­...';
            
            updateProcessingStatus('æ­£åœ¨å¤„ç†éŸ³é¢‘å¯¹è¯...');
            addLog('å¼€å§‹å¤„ç†éŸ³é¢‘æ–‡ä»¶...', 'info');
            
            const startTime = Date.now();
            updateProgress(10);

            try {
                const response = await fetch('/api/conversation/audio', {
                    method: 'POST',
                    body: formData
                });

                updateProgress(70);
                const result = await response.json();
                updateProgress(90);

                if (result.success) {
                    const processingTime = Date.now() - startTime;
                    
                    // æ˜¾ç¤ºè§†é¢‘
                    displayVideo(result.videoUrl);
                    
                    // æ›´æ–°çŠ¶æ€
                    updateProcessingStatus('å¤„ç†å®Œæˆ');
                    updateProcessingTime(`${processingTime}ms`);
                    
                    addLog(`éŸ³é¢‘å¤„ç†æˆåŠŸ!`, 'success');
                    addLog(`è¯†åˆ«æ–‡æœ¬: "${result.inputText}"`, 'info');
                    addLog(`å›å¤å†…å®¹: "${result.responseText}"`, 'info');
                    addLog(`æ£€æµ‹æƒ…æ„Ÿ: ${result.detectedEmotion}`, 'info');
                    
                    if (result.fromCache) {
                        addLog('éƒ¨åˆ†ç»“æœæ¥è‡ªç¼“å­˜', 'info');
                    }
                } else {
                    addLog(`å¤„ç†å¤±è´¥: ${result.message}`, 'error');
                    updateProcessingStatus('å¤„ç†å¤±è´¥');
                }
            } catch (error) {
                addLog(`è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
                updateProcessingStatus('è¯·æ±‚å¤±è´¥');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'ğŸµ å¤„ç†è¯­éŸ³å¯¹è¯';
                updateProgress(100);
                setTimeout(() => updateProgress(0), 1000);
            }
        }

        async function testSpeechRecognition() {
            const audioFile = document.getElementById('audioFile').files[0];
            
            if (!audioFile) {
                alert('è¯·å…ˆé€‰æ‹©éŸ³é¢‘æ–‡ä»¶');
                return;
            }

            const testBtn = document.getElementById('testSpeechBtn');
            testBtn.disabled = true;
            testBtn.textContent = 'ğŸ” è¯†åˆ«ä¸­...';
            
            addLog('å¼€å§‹æµ‹è¯•è¯­éŸ³è¯†åˆ«...', 'info');
            updateProgress(10);

            try {
                const formData = new FormData();
                formData.append('audioFile', audioFile);

                const response = await fetch('/api/audio/speech-recognition', {
                    method: 'POST',
                    body: formData
                });

                updateProgress(80);
                const result = await response.json();
                updateProgress(100);

                if (result.success) {
                    addLog(`âœ… è¯­éŸ³è¯†åˆ«æˆåŠŸ!`, 'success');
                    addLog(`ğŸ¯ è¯†åˆ«æ–‡æœ¬: "${result.recognizedText}"`, 'success');
                    addLog(`â±ï¸ å¤„ç†æ—¶é•¿: ${result.processingTime}ms`, 'info');
                    addLog(`ğŸµ éŸ³é¢‘æ—¶é•¿: ${result.audioDuration}s`, 'info');
                    
                    // å°†è¯†åˆ«ç»“æœå¡«å…¥æ–‡æœ¬æ¡†
                    if (result.recognizedText) {
                        document.getElementById('textInput').value = result.recognizedText;
                        addLog('è¯†åˆ«ç»“æœå·²è‡ªåŠ¨å¡«å…¥æ–‡æœ¬å¯¹è¯æ¡†', 'info');
                    }
                } else {
                    addLog(`âŒ è¯­éŸ³è¯†åˆ«å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`ğŸš« è¯­éŸ³è¯†åˆ«é”™è¯¯: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'ğŸ” æµ‹è¯•è¯­éŸ³è¯†åˆ«';
                updateProgress(100);
                setTimeout(() => updateProgress(0), 1000);
            }
        }

        async function startRealtimeConversation() {
            if (!currentTemplateId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ•°å­—äººæ¨¡æ¿');
                return;
            }

            if (!signalRConnection || signalRConnection.state !== signalR.HubConnectionState.Connected) {
                alert('SignalRè¿æ¥æœªå»ºç«‹ï¼Œæ— æ³•å¯åŠ¨å®æ—¶å¯¹è¯');
                return;
            }

            try {
                const response = await fetch('/api/conversation/realtime/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        templateId: currentTemplateId,
                        quality: document.getElementById('qualitySelect').value,
                        enableEmotionDetection: true
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    realtimeConversationId = result.conversationId;
                    
                    // åŠ å…¥SignalRå¯¹è¯ç»„
                    await signalRConnection.invoke("JoinConversation", realtimeConversationId);
                    
                    document.getElementById('startRealtimeBtn').style.display = 'none';
                    document.getElementById('endRealtimeBtn').style.display = 'inline-block';
                    document.getElementById('realtimeStatus').style.display = 'block';
                    
                    addLog(`å®æ—¶å¯¹è¯å·²å¯åŠ¨: ${realtimeConversationId}`, 'success');
                } else {
                    addLog(`å¯åŠ¨å®æ—¶å¯¹è¯å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`å¯åŠ¨å®æ—¶å¯¹è¯é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function endRealtimeConversation() {
            if (!realtimeConversationId) return;

            try {
                const response = await fetch(`/api/conversation/realtime/end/${realtimeConversationId}`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    // ç¦»å¼€SignalRå¯¹è¯ç»„
                    await signalRConnection.invoke("LeaveConversation", realtimeConversationId);
                    
                    realtimeConversationId = null;
                    
                    document.getElementById('startRealtimeBtn').style.display = 'inline-block';
                    document.getElementById('endRealtimeBtn').style.display = 'none';
                    document.getElementById('realtimeStatus').style.display = 'none';
                    
                    addLog('å®æ—¶å¯¹è¯å·²ç»“æŸ', 'info');
                } else {
                    addLog(`ç»“æŸå®æ—¶å¯¹è¯å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`ç»“æŸå®æ—¶å¯¹è¯é”™è¯¯: ${error.message}`, 'error');
            }
        }

        function handleRealtimeResponse(response) {
            if (response.success) {
                displayVideo(response.videoUrl);
                addLog(`å®æ—¶å¯¹è¯å“åº”: "${response.responseText}"`, 'success');
                updateProcessingTime(`${response.processingTime}ms`);
            } else {
                addLog(`å®æ—¶å¯¹è¯é”™è¯¯: ${response.message}`, 'error');
            }
        }

        function displayVideo(videoUrl) {
            const video = document.getElementById('digitalHumanVideo');
            const placeholder = document.getElementById('videoPlaceholder');
            
            // ä½¿ç”¨æ”¹è¿›çš„è§†é¢‘è®¾ç½®å‡½æ•°ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if (window.setVideoSource) {
                placeholder.style.display = 'none';
                video.style.display = 'block'; 
                window.setVideoSource(videoUrl);
            } else {
                // å›é€€åˆ°åŸå§‹æ–¹æ³•
                video.src = videoUrl;
                video.style.display = 'block';
                placeholder.style.display = 'none';
                
                // ğŸ”„ è®¾ç½®å¾ªç¯æ’­æ”¾ï¼š2ç§’åè‡ªåŠ¨å¾ªç¯
                video.loop = false; // å…ˆä¸å¾ªç¯ï¼Œç­‰å¾…é¦–æ¬¡æ’­æ”¾å®Œæˆ
                video.onended = function() {
                    setTimeout(() => {
                        video.loop = true; // 2ç§’åå¼€å§‹å¾ªç¯æ’­æ”¾
                        video.play();
                        addLog('è§†é¢‘å¼€å§‹å¾ªç¯æ’­æ”¾', 'info');
                    }, 2000);
                };
                
                // è‡ªåŠ¨æ’­æ”¾
                video.play().catch(e => {
                    addLog('è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾', 'warning');
                });
            }
            
            document.getElementById('downloadBtn').style.display = 'inline-block';
            document.getElementById('downloadBtn').onclick = () => downloadVideo(videoUrl);
        }

        function displayAudio(audioUrl) {
            const video = document.getElementById('digitalHumanVideo');
            const placeholder = document.getElementById('videoPlaceholder');
            
            // éšè—è§†é¢‘ï¼Œæ˜¾ç¤ºå ä½ç¬¦å¹¶æ’­æ”¾éŸ³é¢‘
            video.style.display = 'none';
            placeholder.style.display = 'flex';
            placeholder.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 10px;">ğŸµ</div>
                    <div style="font-size: 1.2rem; margin-bottom: 15px;">æ¬¢è¿éŸ³é¢‘å·²å°±ç»ª</div>
                    <audio controls autoplay style="width: 300px;">
                        <source src="${audioUrl}" type="audio/wav">
                        <source src="${audioUrl}" type="audio/mpeg">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
                    </audio>
                </div>
            `;
            
            document.getElementById('downloadBtn').style.display = 'none';
        }

        function playVideo() {
            const video = document.getElementById('digitalHumanVideo');
            if (video.src) {
                video.play();
            }
        }

        function pauseVideo() {
            const video = document.getElementById('digitalHumanVideo');
            video.pause();
        }

        function stopVideo() {
            const video = document.getElementById('digitalHumanVideo');
            video.pause();
            video.currentTime = 0;
        }

        function downloadVideo(videoUrl) {
            if (!videoUrl) {
                videoUrl = document.getElementById('digitalHumanVideo').src;
            }
            
            const a = document.createElement('a');
            a.href = videoUrl;
            a.download = `digital_human_${Date.now()}.mp4`;
            a.click();
        }

        function checkBrowserSupport() {
            let support = [];
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                support.push('âœ… éº¦å…‹é£å½•éŸ³');
            } else {
                support.push('âŒ éº¦å…‹é£å½•éŸ³');
            }
            
            if (typeof MediaRecorder !== 'undefined') {
                support.push('âœ… éŸ³é¢‘å½•åˆ¶');
            } else {
                support.push('âŒ éŸ³é¢‘å½•åˆ¶');
            }
            
            if (typeof signalR !== 'undefined') {
                support.push('âœ… å®æ—¶é€šä¿¡');
            } else {
                support.push('âŒ å®æ—¶é€šä¿¡');
            }
            
            addLog(`æµè§ˆå™¨å…¼å®¹æ€§: ${support.join(', ')}`, 'info');
        }

        // å·¥å…·å‡½æ•°
        function addLog(message, type = 'info') {
            const logs = document.getElementById('systemLogs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ¡æ•°
            if (logs.children.length > 100) {
                logs.removeChild(logs.firstChild);
            }
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = `${percent}%`;
        }

        function updateProcessingStatus(status) {
            document.getElementById('processingStatus').textContent = status;
        }

        function updateProcessingTime(time) {
            document.getElementById('processingTime').textContent = time;
        }

        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        // æ–‡ä»¶é€‰æ‹©æç¤º
        document.getElementById('audioFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const label = document.querySelector('.file-upload-label');
                label.textContent = `ğŸ“ å·²é€‰æ‹©: ${file.name}`;
                addLog(`å·²é€‰æ‹©éŸ³é¢‘æ–‡ä»¶: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`, 'info');
            }
        });

        // å›è½¦é”®å‘é€
        document.getElementById('textInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                sendTextMessage();
            }
        });

        // åˆ›å»ºæ¨¡æ¿ç›¸å…³å‡½æ•°
        function showCreateTemplateModal() {
            document.getElementById('createTemplateModal').style.display = 'block';
        }

        function hideCreateTemplateModal() {
            document.getElementById('createTemplateModal').style.display = 'none';
            document.getElementById('createTemplateForm').reset();
            document.getElementById('imagePreviewContainer').style.display = 'none';
        }

        function previewTemplateImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    document.getElementById('imagePreviewContainer').style.display = 'block';
                };
                reader.readAsDataURL(file);
                
                // æ›´æ–°æ–‡ä»¶æ ‡ç­¾
                const label = document.querySelector('label[for="templateImage"]');
                label.textContent = `ğŸ“· å·²é€‰æ‹©: ${file.name}`;
            }
        }

        // éªŒè¯SystemNameè¾“å…¥
        function validateSystemName(input) {
            const value = input.value;
            const isValid = /^[a-zA-Z0-9_-]*$/.test(value);
            
            if (!isValid && value.length > 0) {
                input.style.borderColor = '#ff4444';
                input.style.backgroundColor = '#fff5f5';
            } else {
                input.style.borderColor = '';
                input.title = '';
            }
        }

        async function createTemplate(event) {
            event.preventDefault();
            
            const createBtn = document.getElementById('createTemplateBtn');
            createBtn.disabled = true;
            createBtn.textContent = 'â³ åˆ›å»ºä¸­...';
            
            addLog('å¼€å§‹åˆ›å»ºæ–°æ¨¡æ¿...', 'info');
            updateProgress(10);

            try {
                // éªŒè¯SystemName
                const systemName = document.getElementById('systemName').value;
                if (!/^[a-zA-Z0-9_-]+$/.test(systemName)) {
                    throw new Error('è‹±æ–‡æ ‡è¯†åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦');
                }
                
                const formData = new FormData();
                formData.append('templateName', document.getElementById('templateName').value);
                formData.append('systemName', systemName);
                formData.append('description', document.getElementById('templateDescription').value);
                formData.append('gender', document.getElementById('templateGender').value);
                formData.append('style', document.getElementById('templateStyle').value);
                formData.append('imageFile', document.getElementById('templateImage').files[0]);
                
                // å¤„ç†è¯­éŸ³è®¾ç½®
                const voiceSettingsText = document.getElementById('voiceSettings').value;
                try {
                    const voiceSettings = JSON.parse(voiceSettingsText);
                    formData.append('voiceSettings', JSON.stringify(voiceSettings));
                } catch (e) {
                    addLog('è¯­éŸ³è®¾ç½®JSONæ ¼å¼é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®', 'warning');
                    formData.append('voiceSettings', JSON.stringify({
                        voice: "zh-CN-XiaoxiaoNeural",
                        rate: "medium",
                        pitch: "medium"
                    }));
                }

                updateProgress(30);

                const response = await fetch('/api/digitalhumantemplate/create', {
                    method: 'POST',
                    body: formData
                });

                updateProgress(70);
                const result = await response.json();
                updateProgress(90);

                if (result.success) {
                    addLog(`æ¨¡æ¿åˆ›å»ºæˆåŠŸ: ${result.template.templateName}`, 'success');
                    hideCreateTemplateModal();
                    
                    // åˆ·æ–°æ¨¡æ¿åˆ—è¡¨
                    await loadTemplates();
                    
                    // è‡ªåŠ¨é€‰æ‹©æ–°åˆ›å»ºçš„æ¨¡æ¿
                    setTimeout(() => {
                        const templateCards = document.querySelectorAll('.template-card');
                        templateCards.forEach(card => {
                            if (card.textContent.includes(result.template.templateName)) {
                                card.click();
                            }
                        });
                    }, 500);
                } else {
                    addLog(`æ¨¡æ¿åˆ›å»ºå¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`åˆ›å»ºæ¨¡æ¿é”™è¯¯: ${error.message}`, 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'ğŸ­ åˆ›å»ºæ¨¡æ¿';
                updateProgress(100);
                setTimeout(() => updateProgress(0), 1000);
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('createTemplateModal');
            if (event.target === modal) {
                hideCreateTemplateModal();
            }
        };
    </script>

    <!-- WebRTCå®æ—¶é€šä¿¡è„šæœ¬ -->
    <script src="js/webrtc-realtime.js"></script>
    
    <!-- è§†é¢‘æ’­æ”¾å™¨å¢å¼ºè„šæœ¬ -->
    <script src="js/improve_video_player.js"></script>
</body>
</html>