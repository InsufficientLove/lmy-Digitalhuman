<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数字人系统测试平台</title>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .video-display {
            text-align: center;
            min-height: 400px;
        }

        .video-container {
            position: relative;
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #digitalHumanVideo {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
            border: 2px solid #007bff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .placeholder {
            color: #6c757d;
            font-size: 1.2rem;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .interaction-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section {
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }

        .section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #495057;
            font-size: 1.1rem;
        }

        /* WebRTC样式 */
        .webrtc-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .webrtc-controls input[type="text"] {
            flex: 1;
            min-width: 200px;
        }

        .stats-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .stats-panel h5 {
            margin: 0 0 10px 0;
            color: #495057;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .stat-item span:last-child {
            font-weight: bold;
            color: #28a745;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .input-group label {
            font-weight: 500;
            color: #495057;
        }

        .form-control {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            padding: 12px 20px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            display: block;
        }

        .file-upload-label:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .recording-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            color: #dc3545;
            font-weight: 500;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: #dc3545;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .status-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .status-label {
            font-weight: 500;
            color: #495057;
        }

        .status-value {
            color: #6c757d;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .template-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .template-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .template-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 10px;
            display: block;
        }

        .template-name {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .template-info {
            font-size: 12px;
            color: #6c757d;
        }

        .logs {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-info { color: #0066cc; }
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .templates-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 1% auto;
            padding: 0;
            border-radius: 15px;
            width: 95%;
            max-width: 650px;
            max-height: 95vh;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 2px solid #e9ecef;
            flex-shrink: 0;
        }

        .modal-header h3 {
            margin: 0;
            color: #495057;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px 30px;
            max-height: calc(95vh - 140px);
            -webkit-overflow-scrolling: touch;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
            flex-shrink: 0;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .input-group {
            flex: 1;
        }

        .preview-container {
            text-align: center;
            margin: 15px 0;
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 数字人系统测试平台</h1>
            <p>体验最新的AI数字人技术 - 支持实时对话、语音交互和个性化模板</p>
        </div>

        <div class="main-grid">
            <!-- 左侧：数字人视频显示 -->
            <div class="card video-display">
                <h3>🎭 数字人展示</h3>
                <div class="video-container">
                    <video id="digitalHumanVideo" controls style="display: none;">
                        您的浏览器不支持视频播放。
                    </video>
                    <div id="videoPlaceholder" class="placeholder">
                        选择模板并开始对话，数字人将在这里出现
                    </div>
                </div>
                
                <div class="controls">
                    <button class="btn btn-primary" onclick="playVideo()">▶️ 播放</button>
                    <button class="btn btn-secondary" onclick="pauseVideo()">⏸️ 暂停</button>
                    <button class="btn btn-secondary" onclick="stopVideo()">⏹️ 停止</button>
                    <button class="btn btn-success" onclick="downloadVideo()" id="downloadBtn" style="display: none;">💾 下载</button>
                </div>

                <div class="status-panel">
                    <div class="status-item">
                        <span class="status-label">当前模板:</span>
                        <span class="status-value" id="currentTemplate">未选择</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">处理状态:</span>
                        <span class="status-value" id="processingStatus">待机中</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">处理时间:</span>
                        <span class="status-value" id="processingTime">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">连接状态:</span>
                        <span class="status-value" id="connectionStatus">未连接</span>
                    </div>
                </div>
            </div>

            <!-- 右侧：交互控制面板 -->
            <div class="card interaction-panel">
                <h3>🎛️ 交互控制面板</h3>

                <!-- 模板选择 -->
                <div class="section">
                    <h3>📋 选择数字人模板</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="loadTemplates()">🔄 刷新模板列表</button>
                        <button class="btn btn-success" onclick="showCreateTemplateModal()">➕ 创建新模板</button>
                        <button class="btn btn-success" onclick="generateWelcomeVideoManual()" id="generateWelcomeBtn" style="display: none;">🎬 生成欢迎视频</button>
                    </div>
                    <div id="templatesContainer" class="templates-grid">
                        <!-- 动态加载模板 -->
                    </div>
                </div>

                <!-- 文本对话 -->
                <div class="section">
                    <h3>💬 文本对话</h3>
                    <div class="input-group">
                        <label for="textInput">输入对话内容:</label>
                        <textarea id="textInput" class="form-control" placeholder="请输入您想要数字人说的话..."></textarea>
                    </div>
                    <div class="input-group">
                        <label for="emotionSelect">情感选择:</label>
                        <select id="emotionSelect" class="form-control">
                            <option value="neutral">自然</option>
                            <option value="happy">开心</option>
                            <option value="professional">专业</option>
                            <option value="friendly">友好</option>
                            <option value="excited">兴奋</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="qualitySelect">视频质量:</label>
                        <select id="qualitySelect" class="form-control">
                            <option value="low">低质量 (快速)</option>
                            <option value="medium" selected>中等质量 (推荐)</option>
                            <option value="high">高质量 (慢速)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="sendTextMessage()" id="sendTextBtn">🚀 生成数字人视频</button>
                </div>

                <!-- 语音对话 -->
                <div class="section">
                    <h3>🎙️ 语音对话</h3>
                    <div class="input-group">
                        <label>语音输入方式:</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button class="btn btn-success" onclick="startRecording()" id="recordBtn">🎤 开始录音</button>
                            <button class="btn btn-danger" onclick="stopRecording()" id="stopRecordBtn" style="display: none;">⏹️ 停止录音</button>
                        </div>
                        <div class="recording-indicator" id="recordingIndicator">
                            <div class="recording-dot"></div>
                            <span>正在录音...</span>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>或上传音频文件:</label>
                        <div class="file-upload">
                            <input type="file" id="audioFile" accept="audio/*">
                            <label for="audioFile" class="file-upload-label">
                                📁 选择音频文件 (支持 MP3, WAV, M4A)
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="sendAudioMessage()" id="sendAudioBtn">🎵 处理语音对话</button>
                        <button class="btn btn-secondary" onclick="testSpeechRecognition()" id="testSpeechBtn">🔍 测试语音识别</button>
                    </div>
                </div>

                <!-- 实时对话 -->
                <div class="section">
                    <h3>⚡ 实时对话</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="startRealtimeConversation()" id="startRealtimeBtn">🔴 开始实时对话</button>
                        <button class="btn btn-danger" onclick="endRealtimeConversation()" id="endRealtimeBtn" style="display: none;">⏹️ 结束对话</button>
                    </div>
                    <div id="realtimeStatus" style="display: none; color: #28a745; font-weight: bold;">
                        ✅ 实时对话已连接，可以开始语音交互
                    </div>
                </div>

                <!-- WebRTC实时通信 -->
                <div class="section">
                    <h3>🌐 WebRTC实时通信 <span style="color: #ff6b6b; font-size: 0.8em;">(新功能)</span></h3>
                    <div class="webrtc-section">
                        <div class="webrtc-video-container" style="margin-bottom: 15px;">
                            <video id="remoteVideo" autoplay playsinline muted 
                                   style="width: 100%; max-height: 200px; border-radius: 8px; background: #000; border: 2px solid #ddd;"></video>
                            <div style="text-align: center; margin-top: 5px; font-size: 0.9em; color: #666;">
                                数字人实时视频将在这里显示
                            </div>
                        </div>
                        <div id="controls" class="webrtc-controls">
                            <!-- WebRTC控制按钮将由JS动态生成 -->
                        </div>
                        <div id="stats" class="webrtc-stats" style="margin-top: 15px;">
                            <!-- 统计信息将由JS动态生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部：日志和进度 -->
        <div class="card">
            <h3>📊 系统状态与日志</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="logs" id="systemLogs">
                <div class="log-entry log-info">[系统] 数字人系统已初始化，等待用户操作...</div>
            </div>
        </div>
    </div>

    <!-- 创建模板模态框 -->
    <div id="createTemplateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🎭 创建新的数字人模板</h3>
                <span class="close" onclick="hideCreateTemplateModal()">&times;</span>
            </div>
            
            <form id="createTemplateForm" onsubmit="createTemplate(event)">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="input-group">
                            <label for="templateName">显示名称 *</label>
                            <input type="text" id="templateName" class="form-control" required placeholder="请输入中文显示名称，如：小哈">
                        </div>
                        <div class="input-group">
                            <label for="systemName">英文标识 *</label>
                            <input type="text" id="systemName" class="form-control" required 
                                   placeholder="请输入英文标识，如：xiaoha" 
                                   pattern="[a-zA-Z0-9_-]+" 
                                   title="只能包含英文字母、数字、下划线和连字符"
                                   oninput="validateSystemName(this)">
                            <small style="color: #666; font-size: 0.8em;">用于文件存储，只能包含英文、数字、下划线和连字符</small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="input-group">
                            <label for="templateDescription">模板描述</label>
                            <input type="text" id="templateDescription" class="form-control" placeholder="简短描述这个模板">
                        </div>
                        <div class="input-group">
                            <!-- 占位，保持布局平衡 -->
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="input-group">
                            <label for="templateGender">性别</label>
                            <select id="templateGender" class="form-control">
                                <option value="female">女性</option>
                                <option value="male">男性</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="templateStyle">风格</label>
                            <select id="templateStyle" class="form-control">
                                <option value="professional">专业</option>
                                <option value="casual">休闲</option>
                                <option value="elegant">优雅</option>
                                <option value="modern">现代</option>
                                <option value="classic">经典</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="templateImage">上传头像图片 *</label>
                        <div class="file-upload">
                            <input type="file" id="templateImage" accept="image/*" required onchange="previewTemplateImage(event)">
                            <label for="templateImage" class="file-upload-label">
                                📷 选择图片文件 (支持 JPG, PNG, WebP)
                            </label>
                        </div>
                    </div>

                    <div class="preview-container" id="imagePreviewContainer" style="display: none;">
                        <img id="imagePreview" class="preview-image" alt="预览图片">
                    </div>

                    <div class="input-group">
                        <label for="voiceSettings">语音设置</label>
                        <textarea id="voiceSettings" class="form-control" placeholder="语音设置 (JSON格式，可选)">{"voice": "zh-CN-XiaoxiaoNeural", "rate": "medium", "pitch": "medium"}</textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="hideCreateTemplateModal()">取消</button>
                        <button type="submit" class="btn btn-primary" id="createTemplateBtn">🎭 创建模板</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 全局变量
        let currentTemplateId = null;
        let signalRConnection = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let realtimeConversationId = null;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });

        async function initializeSystem() {
            addLog('系统初始化中...', 'info');
            
            // 检查HTTPS状态和浏览器兼容性
            checkHttpsAndBrowser();
            
            // 初始化SignalR连接
            await initializeSignalR();
            
            // 加载模板列表
            await loadTemplates();
            
            // 检查浏览器兼容性
            checkBrowserSupport();
            
            addLog('系统初始化完成', 'success');
        }

        function checkHttpsAndBrowser() {
            const isHttps = location.protocol === 'https:';
            const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            
            if (!isHttps && isLocalhost) {
                addLog('当前使用HTTP访问，麦克风功能需要用户授权', 'info');
            } else if (isHttps) {
                addLog('HTTPS环境检测完成', 'success');
            }
        }

        async function initializeSignalR() {
            try {
                signalRConnection = new signalR.HubConnectionBuilder()
                    .withUrl("/conversationHub")
                    .build();

                signalRConnection.on("ReceiveConversationResponse", function (response) {
                    handleRealtimeResponse(response);
                });

                signalRConnection.on("ReceiveError", function (error) {
                    addLog(`实时对话错误: ${error}`, 'error');
                });

                await signalRConnection.start();
                updateConnectionStatus('已连接');
                addLog('SignalR连接已建立', 'success');
            } catch (err) {
                addLog(`SignalR连接失败: ${err}`, 'error');
                updateConnectionStatus('连接失败');
            }
        }

        async function loadTemplates() {
            try {
                addLog('正在加载数字人模板...', 'info');
                updateProgress(20);
                
                const response = await fetch('/api/digitalhumantemplate/list');
                const data = await response.json();
                
                updateProgress(60);
                
                if (data.success) {
                    displayTemplates(data.templates);
                    addLog(`已加载 ${data.templates.length} 个模板`, 'success');
                } else {
                    addLog('加载模板失败', 'error');
                }
                
                updateProgress(100);
                setTimeout(() => updateProgress(0), 1000);
            } catch (error) {
                addLog(`加载模板错误: ${error.message}`, 'error');
                updateProgress(0);
            }
        }

        function displayTemplates(templates) {
            const container = document.getElementById('templatesContainer');
            container.innerHTML = '';

            templates.forEach(template => {
                const templateCard = document.createElement('div');
                templateCard.className = 'template-card';
                
                // 根据状态设置样式和行为
                if (template.status === 'ready') {
                    // 正常可用模板
                    templateCard.onclick = (event) => selectTemplate(template, event);
                    templateCard.innerHTML = `
                        <img src="${template.imageUrl || '/images/default-avatar.svg'}" 
                             alt="${template.templateName}" class="template-image"
                             onerror="this.src='/images/default-avatar.svg'">
                        <div class="template-name">${template.templateName}</div>
                        <div class="template-info">${template.gender} · ${template.style}</div>
                    `;
                } else if (template.status === 'processing') {
                    // 预处理中的模板 - 禁用状态
                    templateCard.style.opacity = '0.6';
                    templateCard.style.cursor = 'not-allowed';
                    templateCard.innerHTML = `
                        <img src="${template.imageUrl || '/images/default-avatar.svg'}" 
                             alt="${template.templateName}" class="template-image"
                             onerror="this.src='/images/default-avatar.svg'">
                        <div class="template-name">${template.templateName}</div>
                        <div class="template-info" style="color: #ffc107;">⏳ 预处理中...</div>
                    `;
                } else if (template.status === 'error') {
                    // 预处理失败的模板 - 错误状态
                    templateCard.style.opacity = '0.6';
                    templateCard.style.cursor = 'not-allowed';
                    templateCard.innerHTML = `
                        <img src="${template.imageUrl || '/images/default-avatar.svg'}" 
                             alt="${template.templateName}" class="template-image"
                             onerror="this.src='/images/default-avatar.svg'">
                        <div class="template-name">${template.templateName}</div>
                        <div class="template-info" style="color: #dc3545;">❌ 预处理失败</div>
                    `;
                } else {
                    // 其他状态 - 显示状态信息
                    templateCard.innerHTML = `
                        <img src="${template.imageUrl || '/images/default-avatar.svg'}" 
                             alt="${template.templateName}" class="template-image"
                             onerror="this.src='/images/default-avatar.svg'">
                        <div class="template-name">${template.templateName}</div>
                        <div class="template-info">${template.status || '未知状态'}</div>
                    `;
                }
                
                container.appendChild(templateCard);
            });
            
            // 统计显示信息
            const readyCount = templates.filter(t => t.status === 'ready').length;
            const processingCount = templates.filter(t => t.status === 'processing').length;
            const errorCount = templates.filter(t => t.status === 'error').length;
            
            if (readyCount === 0 && (processingCount > 0 || errorCount > 0)) {
                addLog(`模板状态: ${readyCount}可用, ${processingCount}预处理中, ${errorCount}失败`, 'warning');
            } else {
                addLog(`模板状态: ${readyCount}可用, ${processingCount}预处理中, ${errorCount}失败`, 'info');
            }
        }

        function selectTemplate(template, event) {
            // 检查模板状态
            if (template.status !== 'ready') {
                if (template.status === 'processing') {
                    alert('模板正在预处理中，请稍后再试');
                } else if (template.status === 'error') {
                    alert('模板预处理失败，无法使用');
                } else {
                    alert('模板状态异常，无法使用');
                }
                return;
            }
            
            // 移除之前的选中状态
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 添加当前选中状态
            event.currentTarget.classList.add('selected');
            
            currentTemplateId = template.templateId;
            document.getElementById('currentTemplate').textContent = template.templateName;
            
            addLog(`已选择模板: ${template.templateName}，请手动点击生成视频`, 'info');
            updateProcessingStatus('模板已选择，等待用户操作');
            
            // 显示生成欢迎视频按钮
            document.getElementById('generateWelcomeBtn').style.display = 'inline-block';
            
            // 🎯 不再自动生成欢迎视频，需要用户手动触发
            // generateWelcomeVideo(template); // 已移除自动触发
        }

        async function generateWelcomeVideo(template) {
            addLog('正在生成欢迎视频...', 'info');
            updateProcessingStatus('生成欢迎视频中...');
            updateProgress(20);

            try {
                const response = await fetch('/api/conversation/welcome', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        templateId: template.templateId,
                        quality: 'medium'
                    })
                });

                updateProgress(80);
                const result = await response.json();
                updateProgress(100);

                if (result.success) {
                    if (result.videoUrl) {
                        displayVideo(result.videoUrl);
                        addLog(`欢迎视频生成成功! 耗时: ${result.processingTime}`, 'success');
                        updateProcessingStatus('欢迎视频已就绪');
                    } else {
                        // 只有音频，显示音频播放器
                        displayAudio(result.audioUrl);
                        addLog(`欢迎音频生成成功 (视频生成失败)! 耗时: ${result.processingTime}`, 'warning');
                        updateProcessingStatus('欢迎音频已就绪');
                    }
                } else {
                    addLog(`欢迎视频生成失败: ${result.message}`, 'error');
                    updateProcessingStatus('欢迎视频生成失败');
                }
            } catch (error) {
                addLog(`生成欢迎视频错误: ${error.message}`, 'error');
                updateProcessingStatus('欢迎视频生成失败');
            } finally {
                setTimeout(() => updateProgress(0), 1000);
            }
        }

        async function generateWelcomeVideoManual() {
            if (!currentTemplateId) {
                alert('请先选择一个数字人模板');
                return;
            }
            
            // 找到当前选中的模板
            const selectedCard = document.querySelector('.template-card.selected');
            if (!selectedCard) {
                alert('请先选择一个数字人模板');
                return;
            }
            
            // 从模板列表中找到对应的模板对象
            const templateName = selectedCard.querySelector('.template-name').textContent;
            const template = {
                templateId: currentTemplateId,
                templateName: templateName
            };
            
            // 生成欢迎视频
            await generateWelcomeVideo(template);
        }

        async function sendTextMessage() {
            const textInput = document.getElementById('textInput');
            const emotion = document.getElementById('emotionSelect').value;
            const quality = document.getElementById('qualitySelect').value;
            
            if (!currentTemplateId) {
                alert('请先选择一个数字人模板');
                return;
            }
            
            if (!textInput.value.trim()) {
                alert('请输入对话内容');
                return;
            }

            const sendBtn = document.getElementById('sendTextBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = '⏳ 处理中...';
            
            updateProcessingStatus('正在生成数字人视频...');
            addLog(`开始处理文本: "${textInput.value.substring(0, 30)}..."`, 'info');
            
            const startTime = Date.now();
            updateProgress(10);

            try {
                const response = await fetch('/api/conversation/text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        templateId: currentTemplateId,
                        text: textInput.value,
                        emotion: emotion,
                        quality: quality,
                        useCache: true
                    })
                });

                updateProgress(70);
                const result = await response.json();
                updateProgress(90);

                if (result.success) {
                    const processingTime = Date.now() - startTime;
                    
                    // 显示视频
                    displayVideo(result.videoUrl);
                    
                    // 更新状态
                    updateProcessingStatus('生成完成');
                    updateProcessingTime(`${processingTime}ms`);
                    
                    addLog(`视频生成成功! 耗时: ${result.processingTime}ms`, 'success');
                    if (result.fromCache) {
                        addLog('结果来自缓存，响应更快', 'info');
                    }
                } else {
                    addLog(`处理失败: ${result.message}`, 'error');
                    updateProcessingStatus('处理失败');
                }
            } catch (error) {
                addLog(`请求错误: ${error.message}`, 'error');
                updateProcessingStatus('请求失败');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '🚀 生成数字人视频';
                updateProgress(100);
                setTimeout(() => updateProgress(0), 1000);
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = function(event) {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = function() {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    processAudioBlob(audioBlob);
                };

                mediaRecorder.start();
                isRecording = true;
                
                document.getElementById('recordBtn').style.display = 'none';
                document.getElementById('stopRecordBtn').style.display = 'inline-block';
                document.getElementById('recordingIndicator').style.display = 'flex';
                
                addLog('开始录音...', 'info');
            } catch (error) {
                addLog(`录音失败: ${error.message}`, 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                
                document.getElementById('recordBtn').style.display = 'inline-block';
                document.getElementById('stopRecordBtn').style.display = 'none';
                document.getElementById('recordingIndicator').style.display = 'none';
                
                addLog('录音完成，正在处理...', 'info');
            }
        }

        async function sendAudioMessage() {
            const audioFile = document.getElementById('audioFile').files[0];
            
            if (!currentTemplateId) {
                alert('请先选择一个数字人模板');
                return;
            }
            
            if (!audioFile) {
                alert('请选择音频文件或进行录音');
                return;
            }

            const formData = new FormData();
            formData.append('templateId', currentTemplateId);
            formData.append('audioFile', audioFile);
            formData.append('quality', document.getElementById('qualitySelect').value);
            formData.append('enableEmotionDetection', 'true');
            formData.append('useCache', 'true');

            await processAudioFormData(formData);
        }

        async function processAudioBlob(audioBlob) {
            if (!currentTemplateId) {
                alert('请先选择一个数字人模板');
                return;
            }

            const formData = new FormData();
            formData.append('templateId', currentTemplateId);
            formData.append('audioFile', audioBlob, 'recording.wav');
            formData.append('quality', document.getElementById('qualitySelect').value);
            formData.append('enableEmotionDetection', 'true');
            formData.append('useCache', 'true');

            await processAudioFormData(formData);
        }

        async function processAudioFormData(formData) {
            const sendBtn = document.getElementById('sendAudioBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = '⏳ 处理中...';
            
            updateProcessingStatus('正在处理音频对话...');
            addLog('开始处理音频文件...', 'info');
            
            const startTime = Date.now();
            updateProgress(10);

            try {
                const response = await fetch('/api/conversation/audio', {
                    method: 'POST',
                    body: formData
                });

                updateProgress(70);
                const result = await response.json();
                updateProgress(90);

                if (result.success) {
                    const processingTime = Date.now() - startTime;
                    
                    // 显示视频
                    displayVideo(result.videoUrl);
                    
                    // 更新状态
                    updateProcessingStatus('处理完成');
                    updateProcessingTime(`${processingTime}ms`);
                    
                    addLog(`音频处理成功!`, 'success');
                    addLog(`识别文本: "${result.inputText}"`, 'info');
                    addLog(`回复内容: "${result.responseText}"`, 'info');
                    addLog(`检测情感: ${result.detectedEmotion}`, 'info');
                    
                    if (result.fromCache) {
                        addLog('部分结果来自缓存', 'info');
                    }
                } else {
                    addLog(`处理失败: ${result.message}`, 'error');
                    updateProcessingStatus('处理失败');
                }
            } catch (error) {
                addLog(`请求错误: ${error.message}`, 'error');
                updateProcessingStatus('请求失败');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '🎵 处理语音对话';
                updateProgress(100);
                setTimeout(() => updateProgress(0), 1000);
            }
        }

        async function testSpeechRecognition() {
            const audioFile = document.getElementById('audioFile').files[0];
            
            if (!audioFile) {
                alert('请先选择音频文件');
                return;
            }

            const testBtn = document.getElementById('testSpeechBtn');
            testBtn.disabled = true;
            testBtn.textContent = '🔍 识别中...';
            
            addLog('开始测试语音识别...', 'info');
            updateProgress(10);

            try {
                const formData = new FormData();
                formData.append('audioFile', audioFile);

                const response = await fetch('/api/audio/speech-recognition', {
                    method: 'POST',
                    body: formData
                });

                updateProgress(80);
                const result = await response.json();
                updateProgress(100);

                if (result.success) {
                    addLog(`✅ 语音识别成功!`, 'success');
                    addLog(`🎯 识别文本: "${result.recognizedText}"`, 'success');
                    addLog(`⏱️ 处理时长: ${result.processingTime}ms`, 'info');
                    addLog(`🎵 音频时长: ${result.audioDuration}s`, 'info');
                    
                    // 将识别结果填入文本框
                    if (result.recognizedText) {
                        document.getElementById('textInput').value = result.recognizedText;
                        addLog('识别结果已自动填入文本对话框', 'info');
                    }
                } else {
                    addLog(`❌ 语音识别失败: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`🚫 语音识别错误: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = '🔍 测试语音识别';
                updateProgress(100);
                setTimeout(() => updateProgress(0), 1000);
            }
        }

        async function startRealtimeConversation() {
            if (!currentTemplateId) {
                alert('请先选择一个数字人模板');
                return;
            }

            if (!signalRConnection || signalRConnection.state !== signalR.HubConnectionState.Connected) {
                alert('SignalR连接未建立，无法启动实时对话');
                return;
            }

            try {
                const response = await fetch('/api/conversation/realtime/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        templateId: currentTemplateId,
                        quality: document.getElementById('qualitySelect').value,
                        enableEmotionDetection: true
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    realtimeConversationId = result.conversationId;
                    
                    // 加入SignalR对话组
                    await signalRConnection.invoke("JoinConversation", realtimeConversationId);
                    
                    document.getElementById('startRealtimeBtn').style.display = 'none';
                    document.getElementById('endRealtimeBtn').style.display = 'inline-block';
                    document.getElementById('realtimeStatus').style.display = 'block';
                    
                    addLog(`实时对话已启动: ${realtimeConversationId}`, 'success');
                } else {
                    addLog(`启动实时对话失败: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`启动实时对话错误: ${error.message}`, 'error');
            }
        }

        async function endRealtimeConversation() {
            if (!realtimeConversationId) return;

            try {
                const response = await fetch(`/api/conversation/realtime/end/${realtimeConversationId}`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    // 离开SignalR对话组
                    await signalRConnection.invoke("LeaveConversation", realtimeConversationId);
                    
                    realtimeConversationId = null;
                    
                    document.getElementById('startRealtimeBtn').style.display = 'inline-block';
                    document.getElementById('endRealtimeBtn').style.display = 'none';
                    document.getElementById('realtimeStatus').style.display = 'none';
                    
                    addLog('实时对话已结束', 'info');
                } else {
                    addLog(`结束实时对话失败: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`结束实时对话错误: ${error.message}`, 'error');
            }
        }

        function handleRealtimeResponse(response) {
            if (response.success) {
                displayVideo(response.videoUrl);
                addLog(`实时对话响应: "${response.responseText}"`, 'success');
                updateProcessingTime(`${response.processingTime}ms`);
            } else {
                addLog(`实时对话错误: ${response.message}`, 'error');
            }
        }

        function displayVideo(videoUrl) {
            const video = document.getElementById('digitalHumanVideo');
            const placeholder = document.getElementById('videoPlaceholder');
            
            // 使用改进的视频设置函数（如果可用）
            if (window.setVideoSource) {
                placeholder.style.display = 'none';
                video.style.display = 'block'; 
                window.setVideoSource(videoUrl);
            } else {
                // 回退到原始方法
                video.src = videoUrl;
                video.style.display = 'block';
                placeholder.style.display = 'none';
                
                // 🔄 设置循环播放：2秒后自动循环
                video.loop = false; // 先不循环，等待首次播放完成
                video.onended = function() {
                    setTimeout(() => {
                        video.loop = true; // 2秒后开始循环播放
                        video.play();
                        addLog('视频开始循环播放', 'info');
                    }, 2000);
                };
                
                // 自动播放
                video.play().catch(e => {
                    addLog('自动播放失败，请手动点击播放', 'warning');
                });
            }
            
            document.getElementById('downloadBtn').style.display = 'inline-block';
            document.getElementById('downloadBtn').onclick = () => downloadVideo(videoUrl);
        }

        function displayAudio(audioUrl) {
            const video = document.getElementById('digitalHumanVideo');
            const placeholder = document.getElementById('videoPlaceholder');
            
            // 隐藏视频，显示占位符并播放音频
            video.style.display = 'none';
            placeholder.style.display = 'flex';
            placeholder.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 10px;">🎵</div>
                    <div style="font-size: 1.2rem; margin-bottom: 15px;">欢迎音频已就绪</div>
                    <audio controls autoplay style="width: 300px;">
                        <source src="${audioUrl}" type="audio/wav">
                        <source src="${audioUrl}" type="audio/mpeg">
                        您的浏览器不支持音频播放。
                    </audio>
                </div>
            `;
            
            document.getElementById('downloadBtn').style.display = 'none';
        }

        function playVideo() {
            const video = document.getElementById('digitalHumanVideo');
            if (video.src) {
                video.play();
            }
        }

        function pauseVideo() {
            const video = document.getElementById('digitalHumanVideo');
            video.pause();
        }

        function stopVideo() {
            const video = document.getElementById('digitalHumanVideo');
            video.pause();
            video.currentTime = 0;
        }

        function downloadVideo(videoUrl) {
            if (!videoUrl) {
                videoUrl = document.getElementById('digitalHumanVideo').src;
            }
            
            const a = document.createElement('a');
            a.href = videoUrl;
            a.download = `digital_human_${Date.now()}.mp4`;
            a.click();
        }

        function checkBrowserSupport() {
            let support = [];
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                support.push('✅ 麦克风录音');
            } else {
                support.push('❌ 麦克风录音');
            }
            
            if (typeof MediaRecorder !== 'undefined') {
                support.push('✅ 音频录制');
            } else {
                support.push('❌ 音频录制');
            }
            
            if (typeof signalR !== 'undefined') {
                support.push('✅ 实时通信');
            } else {
                support.push('❌ 实时通信');
            }
            
            addLog(`浏览器兼容性: ${support.join(', ')}`, 'info');
        }

        // 工具函数
        function addLog(message, type = 'info') {
            const logs = document.getElementById('systemLogs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            
            // 限制日志条数
            if (logs.children.length > 100) {
                logs.removeChild(logs.firstChild);
            }
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = `${percent}%`;
        }

        function updateProcessingStatus(status) {
            document.getElementById('processingStatus').textContent = status;
        }

        function updateProcessingTime(time) {
            document.getElementById('processingTime').textContent = time;
        }

        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        // 文件选择提示
        document.getElementById('audioFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const label = document.querySelector('.file-upload-label');
                label.textContent = `📁 已选择: ${file.name}`;
                addLog(`已选择音频文件: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`, 'info');
            }
        });

        // 回车键发送
        document.getElementById('textInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                sendTextMessage();
            }
        });

        // 创建模板相关函数
        function showCreateTemplateModal() {
            document.getElementById('createTemplateModal').style.display = 'block';
        }

        function hideCreateTemplateModal() {
            document.getElementById('createTemplateModal').style.display = 'none';
            document.getElementById('createTemplateForm').reset();
            document.getElementById('imagePreviewContainer').style.display = 'none';
        }

        function previewTemplateImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    document.getElementById('imagePreviewContainer').style.display = 'block';
                };
                reader.readAsDataURL(file);
                
                // 更新文件标签
                const label = document.querySelector('label[for="templateImage"]');
                label.textContent = `📷 已选择: ${file.name}`;
            }
        }

        // 验证SystemName输入
        function validateSystemName(input) {
            const value = input.value;
            const isValid = /^[a-zA-Z0-9_-]*$/.test(value);
            
            if (!isValid && value.length > 0) {
                input.style.borderColor = '#ff4444';
                input.style.backgroundColor = '#fff5f5';
            } else {
                input.style.borderColor = '';
                input.title = '';
            }
        }

        async function createTemplate(event) {
            event.preventDefault();
            
            const createBtn = document.getElementById('createTemplateBtn');
            createBtn.disabled = true;
            createBtn.textContent = '⏳ 创建中...';
            
            addLog('开始创建新模板...', 'info');
            updateProgress(10);

            try {
                // 验证SystemName
                const systemName = document.getElementById('systemName').value;
                if (!/^[a-zA-Z0-9_-]+$/.test(systemName)) {
                    throw new Error('英文标识只能包含英文字母、数字、下划线和连字符');
                }
                
                const formData = new FormData();
                formData.append('templateName', document.getElementById('templateName').value);
                formData.append('systemName', systemName);
                formData.append('description', document.getElementById('templateDescription').value);
                formData.append('gender', document.getElementById('templateGender').value);
                formData.append('style', document.getElementById('templateStyle').value);
                formData.append('imageFile', document.getElementById('templateImage').files[0]);
                
                // 处理语音设置
                const voiceSettingsText = document.getElementById('voiceSettings').value;
                try {
                    const voiceSettings = JSON.parse(voiceSettingsText);
                    formData.append('voiceSettings', JSON.stringify(voiceSettings));
                } catch (e) {
                    addLog('语音设置JSON格式错误，使用默认设置', 'warning');
                    formData.append('voiceSettings', JSON.stringify({
                        voice: "zh-CN-XiaoxiaoNeural",
                        rate: "medium",
                        pitch: "medium"
                    }));
                }

                updateProgress(30);

                const response = await fetch('/api/digitalhumantemplate/create', {
                    method: 'POST',
                    body: formData
                });

                updateProgress(70);
                const result = await response.json();
                updateProgress(90);

                if (result.success) {
                    addLog(`模板创建成功: ${result.template.templateName}`, 'success');
                    hideCreateTemplateModal();
                    
                    // 刷新模板列表
                    await loadTemplates();
                    
                    // 自动选择新创建的模板
                    setTimeout(() => {
                        const templateCards = document.querySelectorAll('.template-card');
                        templateCards.forEach(card => {
                            if (card.textContent.includes(result.template.templateName)) {
                                card.click();
                            }
                        });
                    }, 500);
                } else {
                    addLog(`模板创建失败: ${result.message}`, 'error');
                }
            } catch (error) {
                addLog(`创建模板错误: ${error.message}`, 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = '🎭 创建模板';
                updateProgress(100);
                setTimeout(() => updateProgress(0), 1000);
            }
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const modal = document.getElementById('createTemplateModal');
            if (event.target === modal) {
                hideCreateTemplateModal();
            }
        };
    </script>

    <!-- WebRTC实时通信脚本 -->
    <script src="js/webrtc-realtime.js"></script>
    
    <!-- 视频播放器增强脚本 -->
    <script src="js/improve_video_player.js"></script>
</body>
</html>