<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC æ•°å­—äººæµ‹è¯•å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .test-modes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .test-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .test-card h2 {
            color: #495057;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .video-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
            aspect-ratio: 16/9;
            min-height: 400px;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #888;
            font-size: 1.2rem;
            text-align: center;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 120px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .status-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .status-label {
            font-weight: 500;
            color: #495057;
        }

        .status-value {
            color: #6c757d;
            font-family: monospace;
        }

        .status-value.success {
            color: #28a745;
        }

        .status-value.error {
            color: #dc3545;
        }

        .status-value.warning {
            color: #ffc107;
        }

        .logs {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            max-height: 300px;
            overflow-y: auto;
        }

        .logs h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            margin-bottom: 5px;
            padding: 3px 5px;
            border-radius: 3px;
        }

        .log-info { 
            background: #e7f3ff;
            color: #0066cc; 
        }

        .log-success { 
            background: #d4edda;
            color: #155724; 
        }

        .log-warning { 
            background: #fff3cd;
            color: #856404; 
        }

        .log-error { 
            background: #f8d7da;
            color: #721c24; 
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #495057;
        }

        .connection-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        .connection-indicator.connected {
            background: #28a745;
        }

        .connection-indicator.connecting {
            background: #ffc107;
        }

        .connection-indicator.disconnected {
            background: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .template-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .template-selector select {
            flex: 1;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        @media (max-width: 1024px) {
            .test-modes {
                grid-template-columns: 1fr;
            }
        }

        .ice-candidates {
            background: #f1f3f5;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.85em;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ WebRTC æ•°å­—äººæµ‹è¯•å¹³å°</h1>
            <p>å®æ—¶ WebRTC é€šä¿¡æµ‹è¯• & éå®æ—¶è§†é¢‘ç”Ÿæˆæµ‹è¯•</p>
        </div>

        <div class="test-modes">
            <!-- å®æ—¶ WebRTC æµ‹è¯• -->
            <div class="test-card">
                <h2>
                    ğŸ”´ å®æ—¶ WebRTC é€šä¿¡
                    <span class="connection-indicator disconnected" id="rtcIndicator"></span>
                </h2>
                
                <div class="video-container">
                    <video id="remoteVideo" autoplay playsinline muted></video>
                    <div class="placeholder" id="rtcPlaceholder">
                        ç­‰å¾… WebRTC è¿æ¥...
                    </div>
                </div>

                <div class="controls">
                    <div class="template-selector">
                        <label>é€‰æ‹©æ¨¡æ¿:</label>
                        <select id="rtcTemplateSelect">
                            <option value="">-- è¯·é€‰æ‹©æ¨¡æ¿ --</option>
                        </select>
                        <button class="btn btn-info" onclick="loadTemplates()">ğŸ”„ åˆ·æ–°</button>
                    </div>

                    <div class="control-group">
                        <button class="btn btn-success" onclick="startWebRTC()" id="startRTCBtn">
                            â–¶ï¸ å¼€å§‹è¿æ¥
                        </button>
                        <button class="btn btn-danger" onclick="stopWebRTC()" id="stopRTCBtn" disabled>
                            â¹ï¸ æ–­å¼€è¿æ¥
                        </button>
                        <button class="btn btn-warning" onclick="restartWebRTC()" id="restartRTCBtn" disabled>
                            ğŸ”„ é‡æ–°è¿æ¥
                        </button>
                    </div>

                    <div class="input-group">
                        <input type="text" id="rtcMessage" placeholder="è¾“å…¥æ¶ˆæ¯å‘é€åˆ°æœåŠ¡å™¨...">
                        <button class="btn btn-primary" onclick="sendRTCMessage()">ğŸ“¤ å‘é€</button>
                    </div>

                    <div class="control-group">
                        <button class="btn btn-info" onclick="getStats()">ğŸ“Š è·å–ç»Ÿè®¡</button>
                        <button class="btn btn-info" onclick="toggleAudio()">ğŸ”‡ åˆ‡æ¢éŸ³é¢‘</button>
                        <button class="btn btn-info" onclick="toggleVideo()">ğŸ“¹ åˆ‡æ¢è§†é¢‘</button>
                    </div>
                </div>

                <div class="status-panel">
                    <div class="status-item">
                        <span class="status-label">è¿æ¥çŠ¶æ€:</span>
                        <span class="status-value" id="rtcStatus">æœªè¿æ¥</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ä¿¡ä»¤çŠ¶æ€:</span>
                        <span class="status-value" id="signalingState">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ICE çŠ¶æ€:</span>
                        <span class="status-value" id="iceState">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">å½“å‰æ¨¡æ¿:</span>
                        <span class="status-value" id="currentRTCTemplate">æœªé€‰æ‹©</span>
                    </div>
                </div>

                <div class="stats-grid" id="rtcStats" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-label">æ¯”ç‰¹ç‡</div>
                        <div class="stat-value" id="bitrate">0 kbps</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¸§ç‡</div>
                        <div class="stat-value" id="framerate">0 fps</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">åˆ†è¾¨ç‡</div>
                        <div class="stat-value" id="resolution">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å»¶è¿Ÿ</div>
                        <div class="stat-value" id="latency">0 ms</div>
                    </div>
                </div>

                <div class="ice-candidates" id="iceCandidates" style="display: none;">
                    <strong>ICE Candidates:</strong>
                    <div id="candidatesList"></div>
                </div>
            </div>

            <!-- éå®æ—¶è§†é¢‘ç”Ÿæˆæµ‹è¯• -->
            <div class="test-card">
                <h2>
                    ğŸ¬ éå®æ—¶è§†é¢‘ç”Ÿæˆ
                    <span class="connection-indicator disconnected" id="apiIndicator"></span>
                </h2>
                
                <div class="video-container">
                    <video id="generatedVideo" controls></video>
                    <div class="placeholder" id="videoPlaceholder">
                        ç­‰å¾…è§†é¢‘ç”Ÿæˆ...
                    </div>
                </div>

                <div class="controls">
                    <div class="template-selector">
                        <label>é€‰æ‹©æ¨¡æ¿:</label>
                        <select id="videoTemplateSelect">
                            <option value="">-- è¯·é€‰æ‹©æ¨¡æ¿ --</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <input type="text" id="textInput" placeholder="è¾“å…¥è¦ç”Ÿæˆçš„æ–‡æœ¬å†…å®¹...">
                    </div>

                    <div class="control-group">
                        <button class="btn btn-primary" onclick="generateVideo()" id="generateBtn">
                            ğŸ¥ ç”Ÿæˆè§†é¢‘
                        </button>
                        <button class="btn btn-success" onclick="generateWelcome()" id="welcomeBtn">
                            ğŸ‘‹ ç”Ÿæˆæ¬¢è¿è§†é¢‘
                        </button>
                        <button class="btn btn-info" onclick="testAudio()" id="audioBtn">
                            ğŸµ æµ‹è¯•éŸ³é¢‘
                        </button>
                    </div>

                    <div class="control-group">
                        <button class="btn btn-warning" onclick="downloadVideo()">
                            ğŸ’¾ ä¸‹è½½è§†é¢‘
                        </button>
                        <button class="btn btn-danger" onclick="clearVideo()">
                            ğŸ—‘ï¸ æ¸…é™¤è§†é¢‘
                        </button>
                    </div>
                </div>

                <div class="status-panel">
                    <div class="status-item">
                        <span class="status-label">API çŠ¶æ€:</span>
                        <span class="status-value" id="apiStatus">å°±ç»ª</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">å¤„ç†è¿›åº¦:</span>
                        <span class="status-value" id="processProgress">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">å¤„ç†æ—¶é—´:</span>
                        <span class="status-value" id="processTime">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">å½“å‰æ¨¡æ¿:</span>
                        <span class="status-value" id="currentVideoTemplate">æœªé€‰æ‹©</span>
                    </div>
                </div>

                <div class="stats-grid" id="videoStats" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-label">è§†é¢‘æ—¶é•¿</div>
                        <div class="stat-value" id="videoDuration">0s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æ–‡ä»¶å¤§å°</div>
                        <div class="stat-value" id="videoSize">0 MB</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ç”Ÿæˆè€—æ—¶</div>
                        <div class="stat-value" id="genTime">0s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ç¼“å­˜çŠ¶æ€</div>
                        <div class="stat-value" id="cacheStatus">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿä¸€æ—¥å¿—åŒºåŸŸ -->
        <div class="logs">
            <h3>ğŸ“Š ç³»ç»Ÿæ—¥å¿—</h3>
            <div id="systemLogs">
                <div class="log-entry log-info">[ç³»ç»Ÿ] WebRTC æµ‹è¯•å¹³å°å·²åˆå§‹åŒ–</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let pc = null;
        let localStream = null;
        let remoteStream = null;
        let ws = null;
        let currentRTCTemplate = null;
        let currentVideoTemplate = null;
        let statsInterval = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'info');
            loadTemplates();
            checkAPIStatus();
        });

        // åŠ è½½æ¨¡æ¿åˆ—è¡¨
        async function loadTemplates() {
            try {
                const response = await fetch('/api/digitalhumantemplate/list');
                const data = await response.json();
                
                if (data.success) {
                    const rtcSelect = document.getElementById('rtcTemplateSelect');
                    const videoSelect = document.getElementById('videoTemplateSelect');
                    
                    // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    rtcSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ¨¡æ¿ --</option>';
                    videoSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ¨¡æ¿ --</option>';
                    
                    // æ·»åŠ æ¨¡æ¿é€‰é¡¹
                    data.templates.forEach(template => {
                        if (template.status === 'ready') {
                            const option1 = new Option(template.templateName, template.templateId);
                            const option2 = new Option(template.templateName, template.templateId);
                            rtcSelect.add(option1);
                            videoSelect.add(option2);
                        }
                    });
                    
                    addLog(`åŠ è½½äº† ${data.templates.filter(t => t.status === 'ready').length} ä¸ªå¯ç”¨æ¨¡æ¿`, 'success');
                } else {
                    addLog('åŠ è½½æ¨¡æ¿å¤±è´¥', 'error');
                }
            } catch (error) {
                addLog(`åŠ è½½æ¨¡æ¿é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥APIçŠ¶æ€
        async function checkAPIStatus() {
            try {
                const response = await fetch('/api/health');
                if (response.ok) {
                    document.getElementById('apiIndicator').className = 'connection-indicator connected';
                    document.getElementById('apiStatus').textContent = 'æ­£å¸¸';
                    document.getElementById('apiStatus').className = 'status-value success';
                } else {
                    document.getElementById('apiIndicator').className = 'connection-indicator disconnected';
                    document.getElementById('apiStatus').textContent = 'å¼‚å¸¸';
                    document.getElementById('apiStatus').className = 'status-value error';
                }
            } catch (error) {
                document.getElementById('apiIndicator').className = 'connection-indicator disconnected';
                document.getElementById('apiStatus').textContent = 'ç¦»çº¿';
                document.getElementById('apiStatus').className = 'status-value error';
            }
        }

        // WebRTC ç›¸å…³å‡½æ•°
        async function startWebRTC() {
            const templateId = document.getElementById('rtcTemplateSelect').value;
            if (!templateId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿');
                return;
            }
            
            currentRTCTemplate = templateId;
            document.getElementById('currentRTCTemplate').textContent = 
                document.getElementById('rtcTemplateSelect').selectedOptions[0].text;
            
            addLog('å¼€å§‹å»ºç«‹ WebRTC è¿æ¥...', 'info');
            updateRTCStatus('connecting');
            
            try {
                // åˆ›å»º PeerConnection
                const configuration = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                };
                
                pc = new RTCPeerConnection(configuration);
                
                // è®¾ç½®äº‹ä»¶å¤„ç†å™¨
                pc.onicecandidate = handleICECandidate;
                pc.ontrack = handleTrack;
                pc.oniceconnectionstatechange = handleICEConnectionStateChange;
                pc.onsignalingstatechange = handleSignalingStateChange;
                
                // åˆ›å»º Offer
                const offer = await pc.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true
                });
                
                await pc.setLocalDescription(offer);
                
                // å‘é€ Offer åˆ°æœåŠ¡å™¨
                await sendOfferToServer(offer, templateId);
                
                // å¯ç”¨æ§åˆ¶æŒ‰é’®
                document.getElementById('startRTCBtn').disabled = true;
                document.getElementById('stopRTCBtn').disabled = false;
                document.getElementById('restartRTCBtn').disabled = false;
                
                addLog('WebRTC Offer å·²å‘é€', 'success');
                
                // å¯åŠ¨ç»Ÿè®¡
                startStatsCollection();
                
            } catch (error) {
                addLog(`WebRTC è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateRTCStatus('failed');
            }
        }

        async function stopWebRTC() {
            addLog('åœæ­¢ WebRTC è¿æ¥...', 'info');
            
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
            
            if (pc) {
                pc.close();
                pc = null;
            }
            
            if (ws) {
                ws.close();
                ws = null;
            }
            
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('rtcPlaceholder').style.display = 'block';
            
            updateRTCStatus('disconnected');
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            document.getElementById('startRTCBtn').disabled = false;
            document.getElementById('stopRTCBtn').disabled = true;
            document.getElementById('restartRTCBtn').disabled = true;
            
            // éšè—ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('rtcStats').style.display = 'none';
            document.getElementById('iceCandidates').style.display = 'none';
            
            addLog('WebRTC è¿æ¥å·²æ–­å¼€', 'info');
        }

        async function restartWebRTC() {
            await stopWebRTC();
            setTimeout(() => startWebRTC(), 1000);
        }

        async function sendOfferToServer(offer, templateId) {
            // TODO: å®ç°å‘é€ Offer åˆ°æœåŠ¡å™¨çš„é€»è¾‘
            // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„æœåŠ¡å™¨ API è¿›è¡Œå®ç°
            const response = await fetch('/api/webrtc/offer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    offer: offer,
                    templateId: templateId
                })
            });
            
            const data = await response.json();
            if (data.answer) {
                await pc.setRemoteDescription(data.answer);
                addLog('æ”¶åˆ° Answerï¼Œè¿æ¥å»ºç«‹ä¸­...', 'success');
            }
        }

        function handleICECandidate(event) {
            if (event.candidate) {
                addLog(`å‘ç° ICE candidate: ${event.candidate.candidate}`, 'info');
                
                // æ˜¾ç¤º ICE candidates
                document.getElementById('iceCandidates').style.display = 'block';
                const list = document.getElementById('candidatesList');
                const candidateDiv = document.createElement('div');
                candidateDiv.textContent = event.candidate.candidate;
                list.appendChild(candidateDiv);
                
                // TODO: å‘é€ ICE candidate åˆ°æœåŠ¡å™¨
            }
        }

        function handleTrack(event) {
            addLog('æ”¶åˆ°è¿œç¨‹åª’ä½“æµ', 'success');
            document.getElementById('remoteVideo').srcObject = event.streams[0];
            document.getElementById('rtcPlaceholder').style.display = 'none';
        }

        function handleICEConnectionStateChange() {
            const state = pc.iceConnectionState;
            document.getElementById('iceState').textContent = state;
            
            switch(state) {
                case 'connected':
                    updateRTCStatus('connected');
                    addLog('ICE è¿æ¥æˆåŠŸ', 'success');
                    break;
                case 'disconnected':
                    updateRTCStatus('disconnected');
                    addLog('ICE è¿æ¥æ–­å¼€', 'warning');
                    break;
                case 'failed':
                    updateRTCStatus('failed');
                    addLog('ICE è¿æ¥å¤±è´¥', 'error');
                    break;
            }
        }

        function handleSignalingStateChange() {
            const state = pc.signalingState;
            document.getElementById('signalingState').textContent = state;
        }

        function updateRTCStatus(status) {
            const statusElement = document.getElementById('rtcStatus');
            const indicator = document.getElementById('rtcIndicator');
            
            switch(status) {
                case 'connected':
                    statusElement.textContent = 'å·²è¿æ¥';
                    statusElement.className = 'status-value success';
                    indicator.className = 'connection-indicator connected';
                    break;
                case 'connecting':
                    statusElement.textContent = 'è¿æ¥ä¸­...';
                    statusElement.className = 'status-value warning';
                    indicator.className = 'connection-indicator connecting';
                    break;
                case 'disconnected':
                    statusElement.textContent = 'æœªè¿æ¥';
                    statusElement.className = 'status-value';
                    indicator.className = 'connection-indicator disconnected';
                    break;
                case 'failed':
                    statusElement.textContent = 'è¿æ¥å¤±è´¥';
                    statusElement.className = 'status-value error';
                    indicator.className = 'connection-indicator disconnected';
                    break;
            }
        }

        // ç»Ÿè®¡ä¿¡æ¯æ”¶é›†
        function startStatsCollection() {
            document.getElementById('rtcStats').style.display = 'grid';
            
            statsInterval = setInterval(async () => {
                if (!pc) return;
                
                const stats = await pc.getStats();
                stats.forEach(report => {
                    if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                        const bitrate = report.bytesReceived ? 
                            Math.round(report.bytesReceived * 8 / 1000) : 0;
                        document.getElementById('bitrate').textContent = `${bitrate} kbps`;
                        
                        const framerate = report.framesPerSecond || 0;
                        document.getElementById('framerate').textContent = `${framerate} fps`;
                        
                        if (report.frameWidth && report.frameHeight) {
                            document.getElementById('resolution').textContent = 
                                `${report.frameWidth}x${report.frameHeight}`;
                        }
                    }
                    
                    if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                        const latency = report.currentRoundTripTime ? 
                            Math.round(report.currentRoundTripTime * 1000) : 0;
                        document.getElementById('latency').textContent = `${latency} ms`;
                    }
                });
            }, 1000);
        }

        async function getStats() {
            if (!pc) {
                alert('WebRTC è¿æ¥æœªå»ºç«‹');
                return;
            }
            
            const stats = await pc.getStats();
            console.log('WebRTC Stats:', stats);
            addLog('ç»Ÿè®¡ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°', 'info');
        }

        function toggleAudio() {
            const video = document.getElementById('remoteVideo');
            video.muted = !video.muted;
            addLog(`éŸ³é¢‘ ${video.muted ? 'å·²é™éŸ³' : 'å·²å¼€å¯'}`, 'info');
        }

        function toggleVideo() {
            const video = document.getElementById('remoteVideo');
            if (video.style.display === 'none') {
                video.style.display = 'block';
                addLog('è§†é¢‘å·²æ˜¾ç¤º', 'info');
            } else {
                video.style.display = 'none';
                addLog('è§†é¢‘å·²éšè—', 'info');
            }
        }

        function sendRTCMessage() {
            const message = document.getElementById('rtcMessage').value;
            if (!message) return;
            
            // TODO: å®ç°é€šè¿‡ DataChannel æˆ– WebSocket å‘é€æ¶ˆæ¯
            addLog(`å‘é€æ¶ˆæ¯: ${message}`, 'info');
            document.getElementById('rtcMessage').value = '';
        }

        // éå®æ—¶è§†é¢‘ç”Ÿæˆç›¸å…³å‡½æ•°
        async function generateVideo() {
            const templateId = document.getElementById('videoTemplateSelect').value;
            const text = document.getElementById('textInput').value;
            
            if (!templateId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿');
                return;
            }
            
            if (!text) {
                alert('è¯·è¾“å…¥è¦ç”Ÿæˆçš„æ–‡æœ¬');
                return;
            }
            
            currentVideoTemplate = templateId;
            document.getElementById('currentVideoTemplate').textContent = 
                document.getElementById('videoTemplateSelect').selectedOptions[0].text;
            
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = 'â³ ç”Ÿæˆä¸­...';
            
            updateProcessStatus('processing');
            const startTime = Date.now();
            
            try {
                addLog(`å¼€å§‹ç”Ÿæˆè§†é¢‘: "${text.substring(0, 30)}..."`, 'info');
                
                const response = await fetch('/api/conversation/text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        templateId: templateId,
                        text: text,
                        emotion: 'neutral',
                        quality: 'medium',
                        useCache: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const endTime = Date.now();
                    const processTime = (endTime - startTime) / 1000;
                    
                    displayVideo(result.videoUrl);
                    updateProcessStatus('completed');
                    document.getElementById('processTime').textContent = `${processTime.toFixed(2)}s`;
                    document.getElementById('genTime').textContent = `${processTime.toFixed(2)}s`;
                    document.getElementById('cacheStatus').textContent = result.fromCache ? 'å‘½ä¸­' : 'æœªå‘½ä¸­';
                    
                    document.getElementById('videoStats').style.display = 'grid';
                    
                    addLog(`è§†é¢‘ç”ŸæˆæˆåŠŸï¼Œè€—æ—¶: ${processTime.toFixed(2)}s`, 'success');
                } else {
                    updateProcessStatus('failed');
                    addLog(`è§†é¢‘ç”Ÿæˆå¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                updateProcessStatus('failed');
                addLog(`è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ¥ ç”Ÿæˆè§†é¢‘';
            }
        }

        async function generateWelcome() {
            const templateId = document.getElementById('videoTemplateSelect').value;
            
            if (!templateId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿');
                return;
            }
            
            currentVideoTemplate = templateId;
            document.getElementById('currentVideoTemplate').textContent = 
                document.getElementById('videoTemplateSelect').selectedOptions[0].text;
            
            const btn = document.getElementById('welcomeBtn');
            btn.disabled = true;
            btn.textContent = 'â³ ç”Ÿæˆä¸­...';
            
            updateProcessStatus('processing');
            
            try {
                addLog('å¼€å§‹ç”Ÿæˆæ¬¢è¿è§†é¢‘...', 'info');
                
                const response = await fetch('/api/conversation/welcome', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        templateId: templateId,
                        quality: 'medium'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.videoUrl) {
                    displayVideo(result.videoUrl);
                    updateProcessStatus('completed');
                    addLog('æ¬¢è¿è§†é¢‘ç”ŸæˆæˆåŠŸ', 'success');
                } else {
                    updateProcessStatus('failed');
                    addLog(`æ¬¢è¿è§†é¢‘ç”Ÿæˆå¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                updateProcessStatus('failed');
                addLog(`è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ‘‹ ç”Ÿæˆæ¬¢è¿è§†é¢‘';
            }
        }

        async function testAudio() {
            const templateId = document.getElementById('videoTemplateSelect').value;
            
            if (!templateId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿');
                return;
            }
            
            const btn = document.getElementById('audioBtn');
            btn.disabled = true;
            btn.textContent = 'â³ æµ‹è¯•ä¸­...';
            
            try {
                addLog('å¼€å§‹æµ‹è¯•éŸ³é¢‘ç”Ÿæˆ...', 'info');
                
                // TODO: å®ç°éŸ³é¢‘æµ‹è¯•é€»è¾‘
                addLog('éŸ³é¢‘æµ‹è¯•åŠŸèƒ½å¾…å®ç°', 'warning');
                
            } catch (error) {
                addLog(`éŸ³é¢‘æµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸµ æµ‹è¯•éŸ³é¢‘';
            }
        }

        function displayVideo(videoUrl) {
            const video = document.getElementById('generatedVideo');
            const placeholder = document.getElementById('videoPlaceholder');
            
            video.src = videoUrl;
            video.style.display = 'block';
            placeholder.style.display = 'none';
            
            video.onloadedmetadata = function() {
                document.getElementById('videoDuration').textContent = 
                    `${Math.round(video.duration)}s`;
            };
            
            // è·å–æ–‡ä»¶å¤§å°
            fetch(videoUrl, { method: 'HEAD' })
                .then(response => {
                    const size = response.headers.get('content-length');
                    if (size) {
                        const mb = (parseInt(size) / 1024 / 1024).toFixed(2);
                        document.getElementById('videoSize').textContent = `${mb} MB`;
                    }
                });
        }

        function downloadVideo() {
            const video = document.getElementById('generatedVideo');
            if (!video.src) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„è§†é¢‘');
                return;
            }
            
            const a = document.createElement('a');
            a.href = video.src;
            a.download = `digital_human_${Date.now()}.mp4`;
            a.click();
            
            addLog('å¼€å§‹ä¸‹è½½è§†é¢‘', 'info');
        }

        function clearVideo() {
            const video = document.getElementById('generatedVideo');
            const placeholder = document.getElementById('videoPlaceholder');
            
            video.src = '';
            video.style.display = 'none';
            placeholder.style.display = 'flex';
            
            document.getElementById('videoStats').style.display = 'none';
            updateProcessStatus('ready');
            
            addLog('è§†é¢‘å·²æ¸…é™¤', 'info');
        }

        function updateProcessStatus(status) {
            const element = document.getElementById('processProgress');
            
            switch(status) {
                case 'processing':
                    element.textContent = 'å¤„ç†ä¸­...';
                    element.className = 'status-value warning';
                    break;
                case 'completed':
                    element.textContent = 'å®Œæˆ';
                    element.className = 'status-value success';
                    break;
                case 'failed':
                    element.textContent = 'å¤±è´¥';
                    element.className = 'status-value error';
                    break;
                case 'ready':
                    element.textContent = 'å°±ç»ª';
                    element.className = 'status-value';
                    break;
            }
        }

        // æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            const logs = document.getElementById('systemLogs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ¡æ•°
            if (logs.children.length > 50) {
                logs.removeChild(logs.firstChild);
            }
        }

        // å®šæœŸæ£€æŸ¥çŠ¶æ€
        setInterval(checkAPIStatus, 30000);
    </script>
</body>
</html>