<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Êï∞Â≠ó‰∫∫ÊµãËØïÂπ≥Âè∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .test-modes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .test-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .test-card h2 {
            color: #495057;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .video-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
            aspect-ratio: 16/9;
            min-height: 400px;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #888;
            font-size: 1.2rem;
            text-align: center;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 120px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .status-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .status-label {
            font-weight: 500;
            color: #495057;
        }

        .status-value {
            color: #6c757d;
            font-family: monospace;
        }

        .status-value.success {
            color: #28a745;
        }

        .status-value.error {
            color: #dc3545;
        }

        .status-value.warning {
            color: #ffc107;
        }

        .logs {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            max-height: 300px;
            overflow-y: auto;
        }

        .logs h3 {
            margin-bottom: 15px;
            color: #495057;
        }

        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            margin-bottom: 5px;
            padding: 3px 5px;
            border-radius: 3px;
        }

        .log-info { 
            background: #e7f3ff;
            color: #0066cc; 
        }

        .log-success { 
            background: #d4edda;
            color: #155724; 
        }

        .log-warning { 
            background: #fff3cd;
            color: #856404; 
        }

        .log-error { 
            background: #f8d7da;
            color: #721c24; 
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #495057;
        }

        .connection-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        .connection-indicator.connected {
            background: #28a745;
        }

        .connection-indicator.connecting {
            background: #ffc107;
        }

        .connection-indicator.disconnected {
            background: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .template-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .template-selector select {
            flex: 1;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        @media (max-width: 1024px) {
            .test-modes {
                grid-template-columns: 1fr;
            }
        }

        .ice-candidates {
            background: #f1f3f5;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.85em;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé• WebRTC Êï∞Â≠ó‰∫∫ÊµãËØïÂπ≥Âè∞</h1>
            <p>ÂÆûÊó∂ WebRTC ÈÄö‰ø°ÊµãËØï & ÈùûÂÆûÊó∂ËßÜÈ¢ëÁîüÊàêÊµãËØï</p>
        </div>

        <div class="test-modes">
            <!-- ÂÆûÊó∂ WebRTC ÊµãËØï -->
            <div class="test-card">
                <h2>
                    üî¥ ÂÆûÊó∂ WebRTC ÈÄö‰ø°
                    <span class="connection-indicator disconnected" id="rtcIndicator"></span>
                </h2>
                
                <div class="video-container">
                    <video id="remoteVideo" autoplay playsinline muted></video>
                    <div class="placeholder" id="rtcPlaceholder">
                        Á≠âÂæÖ WebRTC ËøûÊé•...
                    </div>
                </div>

                <div class="controls">
                    <div class="template-selector">
                        <label>ÈÄâÊã©Ê®°Êùø:</label>
                        <select id="rtcTemplateSelect">
                            <option value="">-- ËØ∑ÈÄâÊã©Ê®°Êùø --</option>
                        </select>
                        <button class="btn btn-info" onclick="loadTemplates()">üîÑ Âà∑Êñ∞</button>
                    </div>

                    <div class="control-group">
                        <button class="btn btn-success" onclick="startWebRTC()" id="startRTCBtn">
                            ‚ñ∂Ô∏è ÂºÄÂßãËøûÊé•
                        </button>
                        <button class="btn btn-danger" onclick="stopWebRTC()" id="stopRTCBtn" disabled>
                            ‚èπÔ∏è Êñ≠ÂºÄËøûÊé•
                        </button>
                        <button class="btn btn-warning" onclick="restartWebRTC()" id="restartRTCBtn" disabled>
                            üîÑ ÈáçÊñ∞ËøûÊé•
                        </button>
                    </div>

                    <div class="input-group">
                        <input type="text" id="rtcMessage" placeholder="ËæìÂÖ•Ê∂àÊÅØÂèëÈÄÅÂà∞ÊúçÂä°Âô®...">
                        <button class="btn btn-primary" onclick="sendRTCMessage()">üì§ ÂèëÈÄÅ</button>
                    </div>

                    <div class="control-group">
                        <button class="btn btn-info" onclick="getStats()">üìä Ëé∑ÂèñÁªüËÆ°</button>
                        <button class="btn btn-info" onclick="toggleAudio()">üîá ÂàáÊç¢Èü≥È¢ë</button>
                        <button class="btn btn-info" onclick="toggleVideo()">üìπ ÂàáÊç¢ËßÜÈ¢ë</button>
                    </div>
                </div>

                <div class="status-panel">
                    <div class="status-item">
                        <span class="status-label">ËøûÊé•Áä∂ÊÄÅ:</span>
                        <span class="status-value" id="rtcStatus">Êú™ËøûÊé•</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">‰ø°‰ª§Áä∂ÊÄÅ:</span>
                        <span class="status-value" id="signalingState">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ICE Áä∂ÊÄÅ:</span>
                        <span class="status-value" id="iceState">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ÂΩìÂâçÊ®°Êùø:</span>
                        <span class="status-value" id="currentRTCTemplate">Êú™ÈÄâÊã©</span>
                    </div>
                </div>

                <div class="stats-grid" id="rtcStats" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-label">ÊØîÁâπÁéá</div>
                        <div class="stat-value" id="bitrate">0 kbps</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Â∏ßÁéá</div>
                        <div class="stat-value" id="framerate">0 fps</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ÂàÜËæ®Áéá</div>
                        <div class="stat-value" id="resolution">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Âª∂Ëøü</div>
                        <div class="stat-value" id="latency">0 ms</div>
                    </div>
                </div>

                <div class="ice-candidates" id="iceCandidates" style="display: none;">
                    <strong>ICE Candidates:</strong>
                    <div id="candidatesList"></div>
                </div>
            </div>

            <!-- ÈùûÂÆûÊó∂ËßÜÈ¢ëÁîüÊàêÊµãËØï -->
            <div class="test-card">
                <h2>
                    üé¨ ÈùûÂÆûÊó∂ËßÜÈ¢ëÁîüÊàê
                    <span class="connection-indicator disconnected" id="apiIndicator"></span>
                </h2>
                
                <div class="video-container">
                    <video id="generatedVideo" controls></video>
                    <div class="placeholder" id="videoPlaceholder">
                        Á≠âÂæÖËßÜÈ¢ëÁîüÊàê...
                    </div>
                </div>

                <div class="controls">
                    <div class="template-selector">
                        <label>ÈÄâÊã©Ê®°Êùø:</label>
                        <select id="videoTemplateSelect">
                            <option value="">-- ËØ∑ÈÄâÊã©Ê®°Êùø --</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <input type="text" id="textInput" placeholder="ËæìÂÖ•Ë¶ÅÁîüÊàêÁöÑÊñáÊú¨ÂÜÖÂÆπ...">
                    </div>

                    <div class="control-group">
                        <button class="btn btn-primary" onclick="generateVideo()" id="generateBtn">
                            üé• ÁîüÊàêËßÜÈ¢ë
                        </button>
                        <button class="btn btn-success" onclick="generateWelcome()" id="welcomeBtn">
                            üëã ÁîüÊàêÊ¨¢ËøéËßÜÈ¢ë
                        </button>
                        <button class="btn btn-info" onclick="testAudio()" id="audioBtn">
                            üéµ ÊµãËØïÈü≥È¢ë
                        </button>
                    </div>

                    <div class="control-group">
                        <button class="btn btn-warning" onclick="downloadVideo()">
                            üíæ ‰∏ãËΩΩËßÜÈ¢ë
                        </button>
                        <button class="btn btn-danger" onclick="clearVideo()">
                            üóëÔ∏è Ê∏ÖÈô§ËßÜÈ¢ë
                        </button>
                    </div>
                </div>

                <div class="status-panel">
                    <div class="status-item">
                        <span class="status-label">API Áä∂ÊÄÅ:</span>
                        <span class="status-value" id="apiStatus">Â∞±Áª™</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Â§ÑÁêÜËøõÂ∫¶:</span>
                        <span class="status-value" id="processProgress">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Â§ÑÁêÜÊó∂Èó¥:</span>
                        <span class="status-value" id="processTime">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ÂΩìÂâçÊ®°Êùø:</span>
                        <span class="status-value" id="currentVideoTemplate">Êú™ÈÄâÊã©</span>
                    </div>
                </div>

                <div class="stats-grid" id="videoStats" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-label">ËßÜÈ¢ëÊó∂Èïø</div>
                        <div class="stat-value" id="videoDuration">0s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Êñá‰ª∂Â§ßÂ∞è</div>
                        <div class="stat-value" id="videoSize">0 MB</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ÁîüÊàêËÄóÊó∂</div>
                        <div class="stat-value" id="genTime">0s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ÁºìÂ≠òÁä∂ÊÄÅ</div>
                        <div class="stat-value" id="cacheStatus">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Áªü‰∏ÄÊó•ÂøóÂå∫Âüü -->
        <div class="logs">
            <h3>üìä Á≥ªÁªüÊó•Âøó</h3>
            <div id="systemLogs">
                <div class="log-entry log-info">[Á≥ªÁªü] WebRTC ÊµãËØïÂπ≥Âè∞Â∑≤ÂàùÂßãÂåñ</div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let pc = null;
        let localStream = null;
        let remoteStream = null;
        let ws = null;
        let currentRTCTemplate = null;
        let currentVideoTemplate = null;
        let statsInterval = null;

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            addLog('Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàê', 'info');
            loadTemplates();
            checkAPIStatus();
        });

        // Âä†ËΩΩÊ®°ÊùøÂàóË°®
        async function loadTemplates() {
            try {
                const response = await fetch('/api/digitalhumantemplate/list');
                const data = await response.json();
                
                if (data.success) {
                    const rtcSelect = document.getElementById('rtcTemplateSelect');
                    const videoSelect = document.getElementById('videoTemplateSelect');
                    
                    // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
                    rtcSelect.innerHTML = '<option value="">-- ËØ∑ÈÄâÊã©Ê®°Êùø --</option>';
                    videoSelect.innerHTML = '<option value="">-- ËØ∑ÈÄâÊã©Ê®°Êùø --</option>';
                    
                    // Ê∑ªÂä†Ê®°ÊùøÈÄâÈ°π
                    data.templates.forEach(template => {
                        if (template.status === 'ready') {
                            const option1 = new Option(template.templateName, template.templateId);
                            const option2 = new Option(template.templateName, template.templateId);
                            rtcSelect.add(option1);
                            videoSelect.add(option2);
                        }
                    });
                    
                    addLog(`Âä†ËΩΩ‰∫Ü ${data.templates.filter(t => t.status === 'ready').length} ‰∏™ÂèØÁî®Ê®°Êùø`, 'success');
                } else {
                    addLog('Âä†ËΩΩÊ®°ÊùøÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                addLog(`Âä†ËΩΩÊ®°ÊùøÈîôËØØ: ${error.message}`, 'error');
            }
        }

        // Ê£ÄÊü•APIÁä∂ÊÄÅ
        async function checkAPIStatus() {
            try {
                const response = await fetch('/api/health');
                if (response.ok) {
                    document.getElementById('apiIndicator').className = 'connection-indicator connected';
                    document.getElementById('apiStatus').textContent = 'Ê≠£Â∏∏';
                    document.getElementById('apiStatus').className = 'status-value success';
                } else {
                    document.getElementById('apiIndicator').className = 'connection-indicator disconnected';
                    document.getElementById('apiStatus').textContent = 'ÂºÇÂ∏∏';
                    document.getElementById('apiStatus').className = 'status-value error';
                }
            } catch (error) {
                document.getElementById('apiIndicator').className = 'connection-indicator disconnected';
                document.getElementById('apiStatus').textContent = 'Á¶ªÁ∫ø';
                document.getElementById('apiStatus').className = 'status-value error';
            }
        }

        // WebRTC Áõ∏ÂÖ≥ÂáΩÊï∞
        async function startWebRTC() {
            const templateId = document.getElementById('rtcTemplateSelect').value;
            if (!templateId) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ê®°Êùø');
                return;
            }
            
            currentRTCTemplate = templateId;
            document.getElementById('currentRTCTemplate').textContent = 
                document.getElementById('rtcTemplateSelect').selectedOptions[0].text;
            
            addLog('ÂºÄÂßãÂª∫Á´ã WebRTC ËøûÊé•...', 'info');
            updateRTCStatus('connecting');
            
            try {
                // ÂàõÂª∫ PeerConnection
                const configuration = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                };
                
                pc = new RTCPeerConnection(configuration);
                
                // ËÆæÁΩÆ‰∫ã‰ª∂Â§ÑÁêÜÂô®
                pc.onicecandidate = handleICECandidate;
                pc.ontrack = handleTrack;
                pc.oniceconnectionstatechange = handleICEConnectionStateChange;
                pc.onsignalingstatechange = handleSignalingStateChange;
                
                // ÂàõÂª∫ Offer
                const offer = await pc.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true
                });
                
                await pc.setLocalDescription(offer);
                
                // ÂèëÈÄÅ Offer Âà∞ÊúçÂä°Âô®
                await sendOfferToServer(offer, templateId);
                
                // ÂêØÁî®ÊéßÂà∂ÊåâÈíÆ
                document.getElementById('startRTCBtn').disabled = true;
                document.getElementById('stopRTCBtn').disabled = false;
                document.getElementById('restartRTCBtn').disabled = false;
                
                addLog('WebRTC Offer Â∑≤ÂèëÈÄÅ', 'success');
                
                // ÂêØÂä®ÁªüËÆ°
                startStatsCollection();
                
            } catch (error) {
                addLog(`WebRTC ËøûÊé•Â§±Ë¥•: ${error.message}`, 'error');
                updateRTCStatus('failed');
            }
        }

        async function stopWebRTC() {
            addLog('ÂÅúÊ≠¢ WebRTC ËøûÊé•...', 'info');
            
            if (statsInterval) {
                clearInterval(statsInterval);
                statsInterval = null;
            }
            
            if (pc) {
                pc.close();
                pc = null;
            }
            
            if (ws) {
                ws.close();
                ws = null;
            }
            
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('rtcPlaceholder').style.display = 'block';
            
            updateRTCStatus('disconnected');
            
            // ÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
            document.getElementById('startRTCBtn').disabled = false;
            document.getElementById('stopRTCBtn').disabled = true;
            document.getElementById('restartRTCBtn').disabled = true;
            
            // ÈöêËóèÁªüËÆ°‰ø°ÊÅØ
            document.getElementById('rtcStats').style.display = 'none';
            document.getElementById('iceCandidates').style.display = 'none';
            
            addLog('WebRTC ËøûÊé•Â∑≤Êñ≠ÂºÄ', 'info');
        }

        async function restartWebRTC() {
            await stopWebRTC();
            setTimeout(() => startWebRTC(), 1000);
        }

        async function sendOfferToServer(offer, templateId) {
            // TODO: ÂÆûÁé∞ÂèëÈÄÅ Offer Âà∞ÊúçÂä°Âô®ÁöÑÈÄªËæë
            // ËøôÈáåÈúÄË¶ÅÊ†πÊçÆÂÆûÈôÖÁöÑÊúçÂä°Âô® API ËøõË°åÂÆûÁé∞
            const response = await fetch('/api/webrtc/offer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    offer: offer,
                    templateId: templateId
                })
            });
            
            const data = await response.json();
            if (data.answer) {
                await pc.setRemoteDescription(data.answer);
                addLog('Êî∂Âà∞ AnswerÔºåËøûÊé•Âª∫Á´ã‰∏≠...', 'success');
            }
        }

        function handleICECandidate(event) {
            if (event.candidate) {
                addLog(`ÂèëÁé∞ ICE candidate: ${event.candidate.candidate}`, 'info');
                
                // ÊòæÁ§∫ ICE candidates
                document.getElementById('iceCandidates').style.display = 'block';
                const list = document.getElementById('candidatesList');
                const candidateDiv = document.createElement('div');
                candidateDiv.textContent = event.candidate.candidate;
                list.appendChild(candidateDiv);
                
                // TODO: ÂèëÈÄÅ ICE candidate Âà∞ÊúçÂä°Âô®
            }
        }

        function handleTrack(event) {
            addLog('Êî∂Âà∞ËøúÁ®ãÂ™í‰ΩìÊµÅ', 'success');
            document.getElementById('remoteVideo').srcObject = event.streams[0];
            document.getElementById('rtcPlaceholder').style.display = 'none';
        }

        function handleICEConnectionStateChange() {
            const state = pc.iceConnectionState;
            document.getElementById('iceState').textContent = state;
            
            switch(state) {
                case 'connected':
                    updateRTCStatus('connected');
                    addLog('ICE ËøûÊé•ÊàêÂäü', 'success');
                    break;
                case 'disconnected':
                    updateRTCStatus('disconnected');
                    addLog('ICE ËøûÊé•Êñ≠ÂºÄ', 'warning');
                    break;
                case 'failed':
                    updateRTCStatus('failed');
                    addLog('ICE ËøûÊé•Â§±Ë¥•', 'error');
                    break;
            }
        }

        function handleSignalingStateChange() {
            const state = pc.signalingState;
            document.getElementById('signalingState').textContent = state;
        }

        function updateRTCStatus(status) {
            const statusElement = document.getElementById('rtcStatus');
            const indicator = document.getElementById('rtcIndicator');
            
            switch(status) {
                case 'connected':
                    statusElement.textContent = 'Â∑≤ËøûÊé•';
                    statusElement.className = 'status-value success';
                    indicator.className = 'connection-indicator connected';
                    break;
                case 'connecting':
                    statusElement.textContent = 'ËøûÊé•‰∏≠...';
                    statusElement.className = 'status-value warning';
                    indicator.className = 'connection-indicator connecting';
                    break;
                case 'disconnected':
                    statusElement.textContent = 'Êú™ËøûÊé•';
                    statusElement.className = 'status-value';
                    indicator.className = 'connection-indicator disconnected';
                    break;
                case 'failed':
                    statusElement.textContent = 'ËøûÊé•Â§±Ë¥•';
                    statusElement.className = 'status-value error';
                    indicator.className = 'connection-indicator disconnected';
                    break;
            }
        }

        // ÁªüËÆ°‰ø°ÊÅØÊî∂ÈõÜ
        function startStatsCollection() {
            document.getElementById('rtcStats').style.display = 'grid';
            
            statsInterval = setInterval(async () => {
                if (!pc) return;
                
                const stats = await pc.getStats();
                stats.forEach(report => {
                    if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
                        const bitrate = report.bytesReceived ? 
                            Math.round(report.bytesReceived * 8 / 1000) : 0;
                        document.getElementById('bitrate').textContent = `${bitrate} kbps`;
                        
                        const framerate = report.framesPerSecond || 0;
                        document.getElementById('framerate').textContent = `${framerate} fps`;
                        
                        if (report.frameWidth && report.frameHeight) {
                            document.getElementById('resolution').textContent = 
                                `${report.frameWidth}x${report.frameHeight}`;
                        }
                    }
                    
                    if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                        const latency = report.currentRoundTripTime ? 
                            Math.round(report.currentRoundTripTime * 1000) : 0;
                        document.getElementById('latency').textContent = `${latency} ms`;
                    }
                });
            }, 1000);
        }

        async function getStats() {
            if (!pc) {
                alert('WebRTC ËøûÊé•Êú™Âª∫Á´ã');
                return;
            }
            
            const stats = await pc.getStats();
            console.log('WebRTC Stats:', stats);
            addLog('ÁªüËÆ°‰ø°ÊÅØÂ∑≤ËæìÂá∫Âà∞ÊéßÂà∂Âè∞', 'info');
        }

        function toggleAudio() {
            const video = document.getElementById('remoteVideo');
            video.muted = !video.muted;
            addLog(`Èü≥È¢ë ${video.muted ? 'Â∑≤ÈùôÈü≥' : 'Â∑≤ÂºÄÂêØ'}`, 'info');
        }

        function toggleVideo() {
            const video = document.getElementById('remoteVideo');
            if (video.style.display === 'none') {
                video.style.display = 'block';
                addLog('ËßÜÈ¢ëÂ∑≤ÊòæÁ§∫', 'info');
            } else {
                video.style.display = 'none';
                addLog('ËßÜÈ¢ëÂ∑≤ÈöêËóè', 'info');
            }
        }

        function sendRTCMessage() {
            const message = document.getElementById('rtcMessage').value;
            if (!message) return;
            
            // TODO: ÂÆûÁé∞ÈÄöËøá DataChannel Êàñ WebSocket ÂèëÈÄÅÊ∂àÊÅØ
            addLog(`ÂèëÈÄÅÊ∂àÊÅØ: ${message}`, 'info');
            document.getElementById('rtcMessage').value = '';
        }

        // ÈùûÂÆûÊó∂ËßÜÈ¢ëÁîüÊàêÁõ∏ÂÖ≥ÂáΩÊï∞
        async function generateVideo() {
            const templateId = document.getElementById('videoTemplateSelect').value;
            const text = document.getElementById('textInput').value;
            
            if (!templateId) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ê®°Êùø');
                return;
            }
            
            if (!text) {
                alert('ËØ∑ËæìÂÖ•Ë¶ÅÁîüÊàêÁöÑÊñáÊú¨');
                return;
            }
            
            currentVideoTemplate = templateId;
            document.getElementById('currentVideoTemplate').textContent = 
                document.getElementById('videoTemplateSelect').selectedOptions[0].text;
            
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ ÁîüÊàê‰∏≠...';
            
            updateProcessStatus('processing');
            const startTime = Date.now();
            
            try {
                addLog(`ÂºÄÂßãÁîüÊàêËßÜÈ¢ë: "${text.substring(0, 30)}..."`, 'info');
                
                const response = await fetch('/api/conversation/text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        templateId: templateId,
                        text: text,
                        emotion: 'neutral',
                        quality: 'medium',
                        useCache: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const endTime = Date.now();
                    const processTime = (endTime - startTime) / 1000;
                    
                    displayVideo(result.videoUrl);
                    updateProcessStatus('completed');
                    document.getElementById('processTime').textContent = `${processTime.toFixed(2)}s`;
                    document.getElementById('genTime').textContent = `${processTime.toFixed(2)}s`;
                    document.getElementById('cacheStatus').textContent = result.fromCache ? 'ÂëΩ‰∏≠' : 'Êú™ÂëΩ‰∏≠';
                    
                    document.getElementById('videoStats').style.display = 'grid';
                    
                    addLog(`ËßÜÈ¢ëÁîüÊàêÊàêÂäüÔºåËÄóÊó∂: ${processTime.toFixed(2)}s`, 'success');
                } else {
                    updateProcessStatus('failed');
                    addLog(`ËßÜÈ¢ëÁîüÊàêÂ§±Ë¥•: ${result.message}`, 'error');
                }
            } catch (error) {
                updateProcessStatus('failed');
                addLog(`ËØ∑Ê±ÇÈîôËØØ: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üé• ÁîüÊàêËßÜÈ¢ë';
            }
        }

        async function generateWelcome() {
            const templateId = document.getElementById('videoTemplateSelect').value;
            
            if (!templateId) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ê®°Êùø');
                return;
            }
            
            currentVideoTemplate = templateId;
            document.getElementById('currentVideoTemplate').textContent = 
                document.getElementById('videoTemplateSelect').selectedOptions[0].text;
            
            const btn = document.getElementById('welcomeBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ ÁîüÊàê‰∏≠...';
            
            updateProcessStatus('processing');
            
            try {
                addLog('ÂºÄÂßãÁîüÊàêÊ¨¢ËøéËßÜÈ¢ë...', 'info');
                
                const response = await fetch('/api/conversation/welcome', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        templateId: templateId,
                        quality: 'medium'
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.videoUrl) {
                    displayVideo(result.videoUrl);
                    updateProcessStatus('completed');
                    addLog('Ê¨¢ËøéËßÜÈ¢ëÁîüÊàêÊàêÂäü', 'success');
                } else {
                    updateProcessStatus('failed');
                    addLog(`Ê¨¢ËøéËßÜÈ¢ëÁîüÊàêÂ§±Ë¥•: ${result.message}`, 'error');
                }
            } catch (error) {
                updateProcessStatus('failed');
                addLog(`ËØ∑Ê±ÇÈîôËØØ: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üëã ÁîüÊàêÊ¨¢ËøéËßÜÈ¢ë';
            }
        }

        async function testAudio() {
            const templateId = document.getElementById('videoTemplateSelect').value;
            
            if (!templateId) {
                alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ê®°Êùø');
                return;
            }
            
            const btn = document.getElementById('audioBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ ÊµãËØï‰∏≠...';
            
            try {
                addLog('ÂºÄÂßãÊµãËØïÈü≥È¢ëÁîüÊàê...', 'info');
                
                // TODO: ÂÆûÁé∞Èü≥È¢ëÊµãËØïÈÄªËæë
                addLog('Èü≥È¢ëÊµãËØïÂäüËÉΩÂæÖÂÆûÁé∞', 'warning');
                
            } catch (error) {
                addLog(`Èü≥È¢ëÊµãËØïÈîôËØØ: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üéµ ÊµãËØïÈü≥È¢ë';
            }
        }

        function displayVideo(videoUrl) {
            const video = document.getElementById('generatedVideo');
            const placeholder = document.getElementById('videoPlaceholder');
            
            video.src = videoUrl;
            video.style.display = 'block';
            placeholder.style.display = 'none';
            
            video.onloadedmetadata = function() {
                document.getElementById('videoDuration').textContent = 
                    `${Math.round(video.duration)}s`;
            };
            
            // Ëé∑ÂèñÊñá‰ª∂Â§ßÂ∞è
            fetch(videoUrl, { method: 'HEAD' })
                .then(response => {
                    const size = response.headers.get('content-length');
                    if (size) {
                        const mb = (parseInt(size) / 1024 / 1024).toFixed(2);
                        document.getElementById('videoSize').textContent = `${mb} MB`;
                    }
                });
        }

        function downloadVideo() {
            const video = document.getElementById('generatedVideo');
            if (!video.src) {
                alert('Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑËßÜÈ¢ë');
                return;
            }
            
            const a = document.createElement('a');
            a.href = video.src;
            a.download = `digital_human_${Date.now()}.mp4`;
            a.click();
            
            addLog('ÂºÄÂßã‰∏ãËΩΩËßÜÈ¢ë', 'info');
        }

        function clearVideo() {
            const video = document.getElementById('generatedVideo');
            const placeholder = document.getElementById('videoPlaceholder');
            
            video.src = '';
            video.style.display = 'none';
            placeholder.style.display = 'flex';
            
            document.getElementById('videoStats').style.display = 'none';
            updateProcessStatus('ready');
            
            addLog('ËßÜÈ¢ëÂ∑≤Ê∏ÖÈô§', 'info');
        }

        function updateProcessStatus(status) {
            const element = document.getElementById('processProgress');
            
            switch(status) {
                case 'processing':
                    element.textContent = 'Â§ÑÁêÜ‰∏≠...';
                    element.className = 'status-value warning';
                    break;
                case 'completed':
                    element.textContent = 'ÂÆåÊàê';
                    element.className = 'status-value success';
                    break;
                case 'failed':
                    element.textContent = 'Â§±Ë¥•';
                    element.className = 'status-value error';
                    break;
                case 'ready':
                    element.textContent = 'Â∞±Áª™';
                    element.className = 'status-value';
                    break;
            }
        }

        // Êó•ÂøóÂáΩÊï∞
        function addLog(message, type = 'info') {
            const logs = document.getElementById('systemLogs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            
            // ÈôêÂà∂Êó•ÂøóÊù°Êï∞
            if (logs.children.length > 50) {
                logs.removeChild(logs.firstChild);
            }
        }

        // ÂÆöÊúüÊ£ÄÊü•Áä∂ÊÄÅ
        setInterval(checkAPIStatus, 30000);
    </script>
</body>
</html>