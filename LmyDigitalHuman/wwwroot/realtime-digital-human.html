<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶æ•°å­—äººå¯¹è¯ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 1200px;
            backdrop-filter: blur(10px);
            margin: 0 auto;
            margin-top: 20px;
            margin-bottom: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .video-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .video-player {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-size: 1.2em;
        }

        .avatar-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: cover;
        }

        .avatar-option:hover {
            transform: scale(1.1);
        }

        .avatar-option.active {
            border-color: #667eea;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
        }

        .avatar-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .avatar-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .avatar-actions button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .control-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }

        .input-methods {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .method-tab {
            flex: 1;
            padding: 10px;
            background: #e9ecef;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .method-tab.active {
            background: #667eea;
            color: white;
        }

        .input-panel {
            display: none;
        }

        .input-panel.active {
            display: block;
        }

        .text-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1.1em;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 15px;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .voice-input {
            text-align: center;
            padding: 20px;
        }

        .record-button {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .record-button:hover {
            transform: scale(1.1);
        }

        .record-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .record-button.recording {
            background: linear-gradient(45deg, #ff4757, #ff3838);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .settings-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .setting-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .setting-label {
            min-width: 80px;
            font-weight: bold;
        }

        .setting-select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .status-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: bold;
            color: #333;
        }

        .status-value {
            color: #666;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #ff4757;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .success-message {
            background: #2ed573;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .warning-message {
            background: #ffa502;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 20px auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-form {
            flex: 1;
            overflow-y: auto;
        }

        .modal-actions {
            flex-shrink: 0;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
            background: #fefefe;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background-color: #f0f8ff;
        }

        .preview-image {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .avatar-selector {
                justify-content: center;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px auto;
                padding: 15px;
                max-height: 95vh;
            }
            
            .form-group {
                margin-bottom: 12px;
            }
            
            .upload-area {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– è‡ªå®šä¹‰æ•°å­—äººå¯¹è¯ç³»ç»Ÿ</h1>
            <p>ä¸Šä¼ å¤´åƒ â€¢ åˆ›å»ºä¸“å±æ•°å­—äºº â€¢ å®æ—¶å¯¹è¯</p>
        </div>

        <div class="main-content">
            <!-- è§†é¢‘æ’­æ”¾åŒºåŸŸ -->
            <div class="video-section">
                <div class="video-container">
                    <video id="videoPlayer" class="video-player" controls style="display: none;"></video>
                    <div id="videoPlaceholder" class="video-placeholder">
                        <div>
                            <div style="font-size: 3em; margin-bottom: 10px;">ğŸ­</div>
                            <div>åˆ›å»ºè‡ªå®šä¹‰æ•°å­—äººå¼€å§‹å¯¹è¯</div>
                            <div style="font-size: 0.9em; color: #888; margin-top: 10px;">ç‚¹å‡»"ğŸ“¤ ä¸Šä¼ å¤´åƒ"åˆ›å»ºæ‚¨çš„ä¸“å±æ•°å­—äºº</div>
                        </div>
                    </div>
                </div>

                <div class="avatar-selector" id="avatarSelector">
                    <!-- å¤´åƒå°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>

                <div class="avatar-actions">
                    <button id="uploadAvatarBtn">ğŸ“¤ ä¸Šä¼ å¤´åƒ</button>
                    <button id="manageTemplatesBtn">ğŸ“‹ ç®¡ç†æ¨¡æ¿</button>
                    <button id="refreshAvatarsBtn">ğŸ”„ åˆ·æ–°</button>
                </div>

                <div class="status-panel">
                    <div class="status-item">
                        <span class="status-label">å“åº”æ¨¡å¼:</span>
                        <span class="status-value" id="currentMode">ç«‹å³å“åº”</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">å¤„ç†æ—¶é—´:</span>
                        <span class="status-value" id="processingTime">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">è§†é¢‘è´¨é‡:</span>
                        <span class="status-value" id="videoQuality">ä¸­ç­‰</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">å½•éŸ³æƒé™:</span>
                        <span class="status-value" id="microphoneStatus">æ£€æŸ¥ä¸­...</span>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-section">
                <div class="input-methods">
                    <button class="method-tab active" data-method="text">ğŸ’¬ æ–‡æœ¬è¾“å…¥</button>
                    <button class="method-tab" data-method="voice">ğŸ¤ è¯­éŸ³è¾“å…¥</button>
                </div>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
                <div class="warning-message" id="warningMessage"></div>

                <!-- æ–‡æœ¬è¾“å…¥é¢æ¿ -->
                <div class="input-panel active" id="textPanel">
                    <textarea class="text-input" id="textInput" placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¯´çš„è¯..."></textarea>
                    
                    <!-- è¯­éŸ³è½¬æ–‡æœ¬æ—¶é—´æ˜¾ç¤º -->
                    <div id="speechToTextTime" style="display: none; padding: 8px 12px; background: #e3f2fd; border-radius: 5px; margin-bottom: 15px; font-size: 0.9em; color: #1976d2;">
                        <span>ğŸ¤ è¯­éŸ³è½¬æ–‡æœ¬è€—æ—¶: <strong id="speechTimeValue">-</strong></span>
                    </div>
                    
                    <div class="settings-panel">
                        <div class="setting-group">
                            <span class="setting-label">å“åº”æ¨¡å¼:</span>
                            <select class="setting-select" id="responseMode">
                                <option value="instant">ç«‹å³å“åº” (< 1ç§’)</option>
                                <option value="fast">å¿«é€Ÿå“åº” (1-3ç§’)</option>
                                <option value="quality">é«˜è´¨é‡ (3-5ç§’)</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <span class="setting-label">è§†é¢‘è´¨é‡:</span>
                            <select class="setting-select" id="videoQuality">
                                <option value="low">ä½è´¨é‡ (640x480)</option>
                                <option value="medium" selected>ä¸­ç­‰ (1280x720)</option>
                                <option value="high">é«˜è´¨é‡ (1920x1080)</option>
                                <option value="ultra">è¶…é«˜æ¸… (2560x1440)</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <span class="setting-label">æƒ…æ„Ÿè¡¨è¾¾:</span>
                            <select class="setting-select" id="emotionMode">
                                <option value="true" selected>å¯ç”¨</option>
                                <option value="false">ç¦ç”¨</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <span class="setting-label">å¯¹è¯æ¨¡å¼:</span>
                            <select class="setting-select" id="chatMode">
                                <option value="normal" selected>æ™®é€šæ¨¡å¼</option>
                                <option value="streaming">æµå¼æ¨¡å¼ï¼ˆå®æ—¶è¯­éŸ³ï¼‰</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <span class="setting-label">TTSè¯­éŸ³:</span>
                            <select class="setting-select" id="ttsVoice">
                                <option value="zh-CN-XiaoxiaoNeural" selected>æ™“æ™“ï¼ˆå¥³å£°-å‹å¥½ï¼‰</option>
                                <option value="zh-CN-XiaoyiNeural">æ™“ä¼Šï¼ˆå¥³å£°-ä¸“ä¸šï¼‰</option>
                                <option value="zh-CN-XiaochenNeural">æ™“è¾°ï¼ˆå¥³å£°-æ´»æ³¼ï¼‰</option>
                                <option value="zh-CN-XiaohanNeural">æ™“æ¶µï¼ˆå¥³å£°-æ¸©æŸ”ï¼‰</option>
                                <option value="zh-CN-YunxiNeural">äº‘å¸Œï¼ˆç”·å£°-ä¸“ä¸šï¼‰</option>
                                <option value="zh-CN-YunyangNeural">äº‘æ‰¬ï¼ˆç”·å£°-é˜³å…‰ï¼‰</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <span class="setting-label">å¯ç”¨AIå¯¹è¯:</span>
                            <select class="setting-select" id="enableAI">
                                <option value="true" selected>å¯ç”¨ï¼ˆæ™ºèƒ½å›ç­”ï¼‰</option>
                                <option value="false">ç¦ç”¨ï¼ˆåŸæ ·æ’­æŠ¥ï¼‰</option>
                            </select>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" id="sendTextBtn">å‘é€æ¶ˆæ¯</button>
                        <button class="btn btn-secondary" id="clearTextBtn">æ¸…ç©º</button>
                    </div>
                </div>

                <!-- è¯­éŸ³è¾“å…¥é¢æ¿ -->
                <div class="input-panel" id="voicePanel">
                    <div class="voice-input">
                        <button class="record-button" id="recordBtn" disabled>
                            <div id="recordIcon">ğŸ¤</div>
                            <div style="font-size: 0.8em; margin-top: 5px;">ç‚¹å‡»å½•éŸ³</div>
                        </button>
                        <div id="recordingStatus">æ£€æŸ¥éº¦å…‹é£æƒé™...</div>
                        
                        <!-- è¯­éŸ³è¯†åˆ«ç»“æœæ–‡æœ¬æ¡† -->
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="voiceResultText">è¯†åˆ«ç»“æœ:</label>
                            <textarea id="voiceResultText" class="text-input" placeholder="è¯­éŸ³è¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly style="min-height: 80px; background-color: #f8f9fa;"></textarea>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" id="sendVoiceTextBtn" disabled>å‘é€è¯†åˆ«å†…å®¹</button>
                        <button class="btn btn-secondary" id="clearVoiceBtn">æ¸…ç©º</button>
                    </div>
                </div>

                <div class="loading" id="loadingPanel">
                    <div class="spinner"></div>
                    <div id="loadingText">æ­£åœ¨å¤„ç†ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸Šä¼ å¤´åƒæ¨¡æ€æ¡† -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeModal">&times;</span>
            <h2>ä¸Šä¼ è‡ªå®šä¹‰æ•°å­—äººå¤´åƒ</h2>
            <form id="uploadForm">
                <div class="modal-form">
                    <div class="form-group">
                        <label for="templateName">æ¨¡æ¿åç§°:</label>
                        <input type="text" id="templateName" name="templateName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">æè¿°:</label>
                        <textarea id="description" name="description" placeholder="è¯·æè¿°è¿™ä¸ªæ•°å­—äººçš„ç‰¹ç‚¹..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="gender">æ€§åˆ«:</label>
                        <select id="gender" name="gender">
                            <option value="female">å¥³æ€§</option>
                            <option value="male">ç”·æ€§</option>
                            <option value="neutral">ä¸­æ€§</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="style">é£æ ¼:</label>
                        <select id="style" name="style">
                            <option value="professional">ä¸“ä¸š</option>
                            <option value="friendly">å‹å¥½</option>
                            <option value="casual">ä¼‘é—²</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>å¤´åƒå›¾ç‰‡:</label>
                        <div class="upload-area" id="uploadArea">
                            <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
                            <p style="font-size: 0.9em; color: #666;">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œå»ºè®® 512x512 åƒç´ </p>
                            <input type="file" id="imageFile" accept="image/*" style="display: none;">
                            <img id="previewImage" class="preview-image" style="display: none;">
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <div class="action-buttons">
                        <button type="submit" class="btn btn-primary">åˆ›å»ºæ¨¡æ¿</button>
                        <button type="button" class="btn btn-secondary" id="cancelUpload">å–æ¶ˆ</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // æµå¼å“åº”åˆ†æ®µç®¡ç†å™¨
        class StreamingSegmentManager {
            constructor() {
                this.textSegments = [];
                this.audioSegments = [];
                this.currentTextBuffer = '';
                this.sentenceBuffer = '';
                this.isProcessing = false;
                this.processingQueue = [];
            }

            addTextChunk(textDelta) {
                this.currentTextBuffer += textDelta;
                this.sentenceBuffer += textDelta;
                
                // æ£€æµ‹å®Œæ•´çš„å¥å­
                const sentences = this.splitIntoSentences(this.sentenceBuffer);
                if (sentences.length > 1) {
                    // å¤„ç†å®Œæ•´çš„å¥å­ï¼ˆé™¤äº†æœ€åä¸€ä¸ªï¼‰
                    for (let i = 0; i < sentences.length - 1; i++) {
                        const sentence = sentences[i].trim();
                        if (sentence && sentence.length > 3) {
                            this.textSegments.push(sentence);
                            this.processingQueue.push({
                                type: 'text',
                                content: sentence,
                                timestamp: Date.now()
                            });
                        }
                    }
                    
                    // ä¿ç•™æœ€åä¸€ä¸ªæœªå®Œæˆçš„å¥å­
                    this.sentenceBuffer = sentences[sentences.length - 1];
                }
                
                // å¦‚æœç¼“å­˜çš„æ–‡æœ¬è¶…è¿‡æŸä¸ªé•¿åº¦ï¼Œå¼ºåˆ¶åˆ†æ®µ
                if (this.currentTextBuffer.length > 100) {
                    this.forceSegment();
                }
            }

            addAudioChunk(audioUrl) {
                this.audioSegments.push(audioUrl);
            }

            forceSegment() {
                if (this.sentenceBuffer.trim().length > 0) {
                    this.textSegments.push(this.sentenceBuffer.trim());
                    this.processingQueue.push({
                        type: 'text',
                        content: this.sentenceBuffer.trim(),
                        timestamp: Date.now()
                    });
                    this.sentenceBuffer = '';
                }
            }

            splitIntoSentences(text) {
                // ä¸­æ–‡å’Œè‹±æ–‡å¥å­åˆ†å‰²
                const pattern = /[ã€‚ï¼ï¼Ÿï¼›!?;]+/;
                const sentences = text.split(pattern).filter(s => s.trim().length > 0);
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¥å­åˆ†éš”ç¬¦ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿé•¿çš„æ–‡æœ¬
                if (sentences.length <= 1 && text.length > 50) {
                    // æŒ‰é€—å·åˆ†å‰²è¾ƒé•¿çš„æ–‡æœ¬
                    const commaPattern = /[ï¼Œ,]+/;
                    const commaSentences = text.split(commaPattern).filter(s => s.trim().length > 10);
                    if (commaSentences.length > 1) {
                        return commaSentences;
                    }
                }
                
                return sentences.length > 1 ? sentences : [text];
            }

            async processCompletedResponse(avatarId, settings, digitalHumanInstance) {
                // å¤„ç†æœ€åçš„æ–‡æœ¬æ®µ
                this.forceSegment();
                
                console.log('[StreamingSegment] å¼€å§‹å¤„ç†å®Œæ•´å“åº”, æ–‡æœ¬æ®µæ•°:', this.textSegments.length);
                
                if (this.textSegments.length === 0) {
                    console.log('[StreamingSegment] æ²¡æœ‰æ–‡æœ¬æ®µéœ€è¦å¤„ç†');
                    return;
                }

                // åˆå¹¶æ‰€æœ‰æ–‡æœ¬æ®µ
                const fullText = this.textSegments.join('ï¼Œ');
                
                try {
                    // ç”Ÿæˆå®Œæ•´çš„æ•°å­—äººè§†é¢‘
                    console.log('[StreamingSegment] ç”Ÿæˆæ•°å­—äººè§†é¢‘:', fullText.substring(0, 50) + '...');
                    
                    const response = await fetch('/api/RealtimeDigitalHuman/instant-chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: fullText,
                            avatarId: avatarId,
                            responseMode: 'quality',
                            quality: settings.quality,
                            enableEmotion: settings.enableEmotion
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.videoUrl) {
                            console.log('[StreamingSegment] æ•°å­—äººè§†é¢‘ç”ŸæˆæˆåŠŸ:', result.videoUrl);
                            digitalHumanInstance.playVideo(result.videoUrl);
                            digitalHumanInstance.updateStatus(result.metadata);
                        } else {
                            console.error('[StreamingSegment] è§†é¢‘ç”Ÿæˆå¤±è´¥:', result);
                        }
                    } else {
                        console.error('[StreamingSegment] è§†é¢‘ç”Ÿæˆè¯·æ±‚å¤±è´¥:', response.status);
                    }
                } catch (error) {
                    console.error('[StreamingSegment] å¤„ç†å®Œæ•´å“åº”å¤±è´¥:', error);
                }
            }

            getStatistics() {
                return {
                    textSegments: this.textSegments.length,
                    audioSegments: this.audioSegments.length,
                    totalText: this.textSegments.join(''),
                    queueLength: this.processingQueue.length
                };
            }
        }

        class RealtimeDigitalHuman {
            constructor() {
                this.currentAvatar = null;
                this.isRecording = false;
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.currentMethod = 'text';
                this.availableAvatars = [];
                this.microphonePermission = 'unknown';
                
                this.initializeElements();
                this.bindEvents();
                this.checkMicrophonePermission();
                this.loadAvailableAvatars();
                this.checkSystemHealth();
            }

            initializeElements() {
                this.videoPlayer = document.getElementById('videoPlayer');
                this.videoPlaceholder = document.getElementById('videoPlaceholder');
                this.textInput = document.getElementById('textInput');
                this.recordBtn = document.getElementById('recordBtn');
                this.loadingPanel = document.getElementById('loadingPanel');
                this.errorMessage = document.getElementById('errorMessage');
                this.successMessage = document.getElementById('successMessage');
                this.warningMessage = document.getElementById('warningMessage');
                this.avatarSelector = document.getElementById('avatarSelector');
                this.uploadModal = document.getElementById('uploadModal');
                this.uploadForm = document.getElementById('uploadForm');
            }

            bindEvents() {
                // è¾“å…¥æ–¹å¼åˆ‡æ¢
                document.querySelectorAll('.method-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.method-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.input-panel').forEach(p => p.classList.remove('active'));
                        
                        e.target.classList.add('active');
                        this.currentMethod = e.target.dataset.method;
                        document.getElementById(`${this.currentMethod}Panel`).classList.add('active');
                    });
                });

                // æ–‡æœ¬è¾“å…¥
                document.getElementById('sendTextBtn').addEventListener('click', () => {
                    this.sendTextMessage();
                });

                document.getElementById('clearTextBtn').addEventListener('click', () => {
                    this.textInput.value = '';
                    // éšè—è¯­éŸ³è½¬æ–‡æœ¬æ—¶é—´æ˜¾ç¤º
                    document.getElementById('speechToTextTime').style.display = 'none';
                });

                // è¯­éŸ³è¾“å…¥
                document.getElementById('recordBtn').addEventListener('click', () => {
                    this.toggleRecording();
                });

                document.getElementById('sendVoiceTextBtn').addEventListener('click', () => {
                    this.sendVoiceTextMessage();
                });

                document.getElementById('clearVoiceBtn').addEventListener('click', () => {
                    this.clearVoiceResult();
                });

                // å¤´åƒç®¡ç†
                document.getElementById('uploadAvatarBtn').addEventListener('click', () => {
                    this.showUploadModal();
                });

                document.getElementById('manageTemplatesBtn').addEventListener('click', () => {
                    this.showTemplateManager();
                });

                document.getElementById('refreshAvatarsBtn').addEventListener('click', () => {
                    this.loadAvailableAvatars();
                });

                // æ¨¡æ€æ¡†äº‹ä»¶
                document.getElementById('closeModal').addEventListener('click', () => {
                    this.hideUploadModal();
                });

                document.getElementById('cancelUpload').addEventListener('click', () => {
                    this.hideUploadModal();
                });

                // ä¸Šä¼ è¡¨å•
                this.uploadForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createCustomAvatar();
                });

                // æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
                this.setupFileUpload();

                // å›è½¦å‘é€
                this.textInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendTextMessage();
                    }
                });

                // æ¨¡æ€æ¡†å¤–éƒ¨ç‚¹å‡»å…³é—­
                window.addEventListener('click', (e) => {
                    if (e.target === this.uploadModal) {
                        this.hideUploadModal();
                    }
                });
            }

            async checkMicrophonePermission() {
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        this.microphonePermission = 'unsupported';
                        this.updateMicrophoneStatus('ä¸æ”¯æŒ');
                        this.showWarning('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½');
                        return;
                    }

                    // æ£€æŸ¥æ˜¯å¦åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ä¸­
                    if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                        this.microphonePermission = 'insecure';
                        this.updateMicrophoneStatus('éœ€è¦HTTPS');
                        this.showWarning('å½•éŸ³åŠŸèƒ½éœ€è¦HTTPSç¯å¢ƒã€‚è¯·ä½¿ç”¨ https://localhost:7135 è®¿é—®ï¼Œæˆ–åœ¨æµè§ˆå™¨ä¸­æ‰‹åŠ¨å…è®¸HTTPå½•éŸ³æƒé™ã€‚');
                        return;
                    }

                    // å¯¹äºlocalhostçš„HTTPï¼Œä¹Ÿç»™å‡ºæç¤º
                    if (location.protocol === 'http:' && (location.hostname === 'localhost' || location.hostname === '127.0.0.1')) {
                        this.showWarning('å»ºè®®ä½¿ç”¨HTTPSè®¿é—®ä»¥è·å¾—æœ€ä½³å½•éŸ³ä½“éªŒï¼šhttps://localhost:7135');
                    }

                    // æ£€æŸ¥æƒé™
                    const permission = await navigator.permissions.query({name: 'microphone'});
                    
                    if (permission.state === 'granted') {
                        this.microphonePermission = 'granted';
                        this.updateMicrophoneStatus('å·²æˆæƒ');
                        this.recordBtn.disabled = false;
                        document.getElementById('recordingStatus').textContent = 'å‡†å¤‡å½•éŸ³';
                    } else if (permission.state === 'denied') {
                        this.microphonePermission = 'denied';
                        this.updateMicrophoneStatus('å·²æ‹’ç»');
                        this.showWarning('éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®éº¦å…‹é£');
                    } else {
                        this.microphonePermission = 'prompt';
                        this.updateMicrophoneStatus('éœ€è¦æˆæƒ');
                        this.recordBtn.disabled = false;
                        document.getElementById('recordingStatus').textContent = 'ç‚¹å‡»å½•éŸ³æŒ‰é’®æˆæƒ';
                    }

                    // ç›‘å¬æƒé™å˜åŒ–
                    permission.onchange = () => {
                        this.checkMicrophonePermission();
                    };

                } catch (error) {
                    console.error('æ£€æŸ¥éº¦å…‹é£æƒé™å¤±è´¥:', error);
                    this.microphonePermission = 'error';
                    this.updateMicrophoneStatus('æ£€æŸ¥å¤±è´¥');
                    this.showWarning('æ— æ³•æ£€æŸ¥éº¦å…‹é£æƒé™ï¼Œè¯·æ‰‹åŠ¨æˆæƒ');
                }
            }

            updateMicrophoneStatus(status) {
                document.getElementById('microphoneStatus').textContent = status;
            }

            async loadAvailableAvatars() {
                try {
                    this.showLoading('æ­£åœ¨åŠ è½½æ•°å­—äººå¤´åƒ...');
                    console.log('[Avatar] è¯·æ±‚å¤´åƒåˆ—è¡¨...');
                    
                    // è·å–å¯ç”¨å¤´åƒåˆ—è¡¨
                    const response = await fetch('/api/RealtimeDigitalHuman/avatars');
                    
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('[Avatar] APIè¿”å›:', result);
                    
                    if (result.success && result.avatars && Array.isArray(result.avatars)) {
                        this.availableAvatars = result.avatars;
                        console.log('[Avatar] æˆåŠŸåŠ è½½å¤´åƒ:', this.availableAvatars.length, 'ä¸ª');
                        this.renderAvatars();
                    } else {
                        console.warn('[Avatar] APIè¿”å›æ ¼å¼å¼‚å¸¸:', result);
                        // å¦‚æœAPIè¿”å›æ ¼å¼ä¸æ­£ç¡®ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                        this.availableAvatars = [];
                        this.renderAvatars();
                        this.showWarning('æš‚æ— å¯ç”¨çš„æ•°å­—äººå¤´åƒï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ª');
                    }
                } catch (error) {
                    console.error('[Avatar] åŠ è½½å¤´åƒå¤±è´¥:', error);
                    // ç½‘ç»œé”™è¯¯æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€
                    this.availableAvatars = [];
                    this.renderAvatars();
                    this.showError('åŠ è½½å¤´åƒå¤±è´¥ï¼š' + error.message);
                } finally {
                    this.hideLoading();
                }
            }

            renderAvatars() {
                this.avatarSelector.innerHTML = '';
                
                if (this.availableAvatars.length === 0) {
                    // æ²¡æœ‰è‡ªå®šä¹‰æ•°å­—äººï¼Œæ˜¾ç¤ºå¼•å¯¼æç¤º
                    this.avatarSelector.innerHTML = `
                        <div style="color:#666;text-align:center;width:100%;padding:20px;">
                            <div style="font-size:2em;margin-bottom:10px;">ğŸ­</div>
                            <div style="font-size:1.1em;margin-bottom:10px;">è¿˜æ²¡æœ‰è‡ªå®šä¹‰æ•°å­—äºº</div>
                            <div style="font-size:0.9em;color:#888;">ç‚¹å‡»ä¸‹æ–¹"ğŸ“¤ ä¸Šä¼ å¤´åƒ"æŒ‰é’®åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªæ•°å­—äºº</div>
                        </div>
                    `;
                    document.getElementById('sendTextBtn').disabled = true;
                    document.getElementById('sendVoiceTextBtn').disabled = true;
                    return;
                }

                // å¯ç”¨å‘é€æŒ‰é’®
                document.getElementById('sendTextBtn').disabled = false;
                document.getElementById('sendVoiceTextBtn').disabled = false;
                
                this.availableAvatars.forEach((avatar, index) => {
                    const img = document.createElement('img');
                    img.src = avatar.previewImageUrl || avatar.imageUrl;
                    img.className = 'avatar-option';
                    img.dataset.avatar = avatar.id;
                    img.alt = avatar.name;
                    img.title = `${avatar.name}\n${avatar.description || ''}`;
                    
                    // ç¬¬ä¸€ä¸ªå¤´åƒé»˜è®¤é€‰ä¸­
                    if (index === 0) {
                        img.classList.add('active');
                        this.currentAvatar = avatar.id;
                    }
                    
                    img.addEventListener('click', (e) => {
                        document.querySelectorAll('.avatar-option').forEach(a => a.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentAvatar = e.target.dataset.avatar;
                        console.log('[Avatar] é€‰ä¸­å¤´åƒ:', this.currentAvatar);
                    });
                    
                    img.addEventListener('error', (e) => {
                        console.warn('[Avatar] å›¾ç‰‡åŠ è½½å¤±è´¥:', img.src);
                        // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤å ä½ç¬¦
                        const placeholder = document.createElement('div');
                        placeholder.className = 'avatar-option';
                        placeholder.style.cssText = 'width:60px;height:60px;border-radius:50%;border:3px solid #ddd;display:flex;align-items:center;justify-content:center;background:#f8f9fa;color:#666;font-size:1.5em;cursor:pointer;';
                        placeholder.textContent = 'ğŸ­';
                        placeholder.dataset.avatar = avatar.id;
                        placeholder.title = `${avatar.name}\n${avatar.description || ''}\n(å›¾ç‰‡åŠ è½½å¤±è´¥)`;
                        
                        // å¤åˆ¶ç‚¹å‡»äº‹ä»¶
                        placeholder.addEventListener('click', (e) => {
                            document.querySelectorAll('.avatar-option').forEach(a => a.classList.remove('active'));
                            e.target.classList.add('active');
                            this.currentAvatar = e.target.dataset.avatar;
                            console.log('[Avatar] é€‰ä¸­å¤´åƒ:', this.currentAvatar);
                        });
                        
                        // å¦‚æœæ˜¯å½“å‰é€‰ä¸­çš„ï¼ŒåŒæ­¥activeçŠ¶æ€
                        if (img.classList.contains('active')) {
                            placeholder.classList.add('active');
                        }
                        
                        img.parentNode.replaceChild(placeholder, img);
                    });
                    
                    this.avatarSelector.appendChild(img);
                });
                
                console.log('[Avatar] æ¸²æŸ“å®Œæˆï¼Œå½“å‰é€‰ä¸­:', this.currentAvatar);
            }

            async createCustomAvatar() {
                const formData = new FormData();
                const fileInput = document.getElementById('imageFile');
                
                if (!fileInput.files[0]) {
                    this.showError('è¯·é€‰æ‹©å¤´åƒå›¾ç‰‡');
                    return;
                }

                const templateName = document.getElementById('templateName').value;
                const description = document.getElementById('description').value;
                const gender = document.getElementById('gender').value;
                const style = document.getElementById('style').value;

                console.log('[CreateAvatar] è¡¨å•æ•°æ®:', {
                    templateName,
                    description,
                    gender,
                    style,
                    fileName: fileInput.files[0].name
                });

                formData.append('ImageFile', fileInput.files[0]);
                formData.append('TemplateName', templateName);
                formData.append('Description', description);
                formData.append('Gender', gender);
                formData.append('Style', style);
                formData.append('TemplateType', 'headshot');
                formData.append('EnableEmotion', 'true');

                try {
                    this.showLoading('æ­£åœ¨åˆ›å»ºè‡ªå®šä¹‰æ•°å­—äºº...');
                    
                    const response = await fetch('/api/RealtimeDigitalHuman/create-avatar', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    console.log('[CreateAvatar] è¿”å›ç»“æœ:', result);
                    
                    if (result.success) {
                        this.showSuccess('è‡ªå®šä¹‰æ•°å­—äººåˆ›å»ºæˆåŠŸï¼é¢„è§ˆè§†é¢‘æ­£åœ¨åå°ç”Ÿæˆä¸­...');
                        this.hideUploadModal();
                        await this.loadAvailableAvatars(); // é‡æ–°åŠ è½½å¤´åƒåˆ—è¡¨
                        
                        // æç¤ºç”¨æˆ·è§†é¢‘æ­£åœ¨ç”Ÿæˆ
                        if (!result.avatar?.previewVideoPath) {
                            setTimeout(() => {
                                this.showWarning('æç¤ºï¼šé¢„è§ˆè§†é¢‘ä»åœ¨ç”Ÿæˆä¸­ï¼Œç¨ååˆ·æ–°å³å¯æŸ¥çœ‹');
                            }, 1000);
                        }
                    } else {
                        this.showError(result.message || result.error || 'åˆ›å»ºå¤±è´¥');
                    }
                } catch (error) {
                    console.error('åˆ›å»ºè‡ªå®šä¹‰æ•°å­—äººå¤±è´¥:', error);
                    this.showError('åˆ›å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                } finally {
                    this.hideLoading();
                }
            }

            showTemplateManager() {
                // æ‰“å¼€æ¨¡æ¿ç®¡ç†é¡µé¢
                window.open('/templates', '_blank');
            }

            async sendTextMessage() {
                const text = this.textInput.value.trim();
                if (!text) {
                    this.showError('è¯·è¾“å…¥æ–‡æœ¬å†…å®¹');
                    return;
                }

                const chatMode = document.getElementById('chatMode').value;
                const enableAI = document.getElementById('enableAI').value === 'true';

                if (chatMode === 'streaming' && enableAI) {
                    // æµå¼æ¨¡å¼
                    await this.sendStreamingMessage(text);
                } else {
                    // æ™®é€šæ¨¡å¼
                    await this.sendNormalMessage(text);
                }
            }

            async sendNormalMessage(text) {
                this.showLoading('æ­£åœ¨ç”Ÿæˆæ•°å­—äººè§†é¢‘...');
                this.showPendingAvatar();
                try {
                    console.log('[SendText] å‘é€æ¶ˆæ¯:', text, 'avatar:', this.currentAvatar);
                    const response = await fetch('/api/RealtimeDigitalHuman/instant-chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: text,
                            avatarId: this.currentAvatar,
                            responseMode: document.getElementById('responseMode').value,
                            quality: document.getElementById('videoQuality').value,
                            enableEmotion: document.getElementById('emotionMode').value === 'true'
                        })
                    });
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                    }
                    const result = await response.json();
                    console.log('[SendText] è¿”å›:', result);
                    if (result.success) {
                        this.playVideo(result.videoUrl);
                        this.updateStatus(result.metadata);
                        this.showSuccess('æ¶ˆæ¯å‘é€æˆåŠŸï¼');
                        this.textInput.value = '';
                        // éšè—è¯­éŸ³è½¬æ–‡æœ¬æ—¶é—´æ˜¾ç¤º
                        document.getElementById('speechToTextTime').style.display = 'none';
                    } else {
                        this.showError(result.message || result.error || 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
                        console.error('APIè¿”å›é”™è¯¯:', result);
                    }
                } catch (error) {
                    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                    this.showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥å’ŒæœåŠ¡çŠ¶æ€');
                } finally {
                    this.hideLoading();
                }
            }

            async sendStreamingMessage(text) {
                this.showLoading('æ­£åœ¨è¿æ¥AI...');
                this.showPendingAvatar();
                
                const responseTextArea = document.createElement('div');
                responseTextArea.style.cssText = 'margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; max-height: 200px; overflow-y: auto;';
                responseTextArea.innerHTML = '<strong>AIå›å¤ï¼š</strong><br>';
                this.textInput.parentElement.insertBefore(responseTextArea, this.textInput.nextSibling);

                // åˆ†æ®µå“åº”ç®¡ç†
                const segmentManager = new StreamingSegmentManager();
                let fullResponse = '';
                let videoGenerated = false;

                try {
                    const response = await fetch('/api/RealtimeDigitalHuman/streaming-chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: text,
                            avatarId: this.currentAvatar,
                            voice: document.getElementById('ttsVoice').value,
                            model: 'qwen2.5:14b-instruct-q4_0',
                            enableEmotion: document.getElementById('emotionMode').value === 'true',
                            quality: document.getElementById('videoQuality').value,
                            systemPrompt: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIåŠ©æ‰‹ï¼Œè¯·ç”¨ä¸­æ–‡å›ç­”é—®é¢˜ã€‚å›ç­”è¦å‡†ç¡®ã€ç®€æ´ã€æœ‰å¸®åŠ©ã€‚'
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                    }

                    // ä½¿ç”¨ EventSource è¯»å– SSE æµ
                    const decoder = new TextDecoder();
                    const reader = response.body.getReader();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const dataStr = line.slice(6);
                                if (dataStr === '[DONE]') {
                                    break;
                                }
                                
                                try {
                                    const data = JSON.parse(dataStr);
                                
                                switch (data.type) {
                                    case 'text':
                                        // æ˜¾ç¤ºæ–‡æœ¬å¹¶æ·»åŠ åˆ°åˆ†æ®µç®¡ç†å™¨
                                        fullResponse += data.textDelta;
                                        responseTextArea.innerHTML = '<strong>AIå›å¤ï¼š</strong><br>' + fullResponse;
                                        responseTextArea.scrollTop = responseTextArea.scrollHeight;
                                        
                                        // æ·»åŠ åˆ°åˆ†æ®µç®¡ç†å™¨
                                        segmentManager.addTextChunk(data.textDelta);
                                        break;
                                        
                                    case 'audio':
                                        // å°†éŸ³é¢‘æ·»åŠ åˆ°åˆ†æ®µç®¡ç†å™¨
                                        segmentManager.addAudioChunk(data.audioChunkUrl);
                                        // å¯ä»¥åœ¨è¿™é‡Œæ’­æ”¾éŸ³é¢‘
                                        this.playAudioInBackground(data.audioChunkUrl);
                                        break;
                                        
                                    case 'video':
                                        // æ’­æ”¾ç”Ÿæˆçš„è§†é¢‘
                                        if (!videoGenerated) {
                                            this.playVideo(data.videoUrl);
                                            videoGenerated = true;
                                        }
                                        break;
                                        
                                    case 'complete':
                                        // å¤„ç†å®Œæ•´å“åº”
                                        await segmentManager.processCompletedResponse(this.currentAvatar, {
                                            quality: document.getElementById('videoQuality').value,
                                            enableEmotion: document.getElementById('emotionMode').value === 'true'
                                        }, this);
                                        
                                        this.showSuccess('å¯¹è¯å®Œæˆï¼');
                                        this.textInput.value = '';
                                        // 3ç§’åç§»é™¤å›å¤æ–‡æœ¬
                                        setTimeout(() => {
                                            responseTextArea.remove();
                                        }, 3000);
                                        break;
                                        
                                    case 'error':
                                        this.showError('æµå¼å¯¹è¯å‡ºé”™: ' + data.textDelta);
                                        break;
                                }
                            } catch (e) {
                                console.error('è§£ææµå¼æ•°æ®å¤±è´¥:', e, 'line:', line);
                            }
                        }
                    }
                } catch (error) {
                    console.error('æµå¼å¯¹è¯å¤±è´¥:', error);
                    this.showError('æµå¼å¯¹è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    responseTextArea.remove();
                } finally {
                    this.hideLoading();
                }
            }

            async toggleRecording() {
                if (!this.isRecording) {
                    await this.startRecording();
                } else {
                    this.stopRecording();
                }
            }

            async startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.mediaRecorder = new MediaRecorder(stream);
                    this.audioChunks = [];

                    this.mediaRecorder.ondataavailable = (event) => {
                        this.audioChunks.push(event.data);
                    };

                    this.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                        this.processVoiceInput(audioBlob);
                    };

                    this.mediaRecorder.start();
                    this.isRecording = true;
                    this.microphonePermission = 'granted';
                    this.updateMicrophoneStatus('å·²æˆæƒ');
                    
                    this.recordBtn.classList.add('recording');
                    document.getElementById('recordIcon').textContent = 'â¹ï¸';
                    document.getElementById('recordingStatus').textContent = 'å½•éŸ³ä¸­... ç‚¹å‡»åœæ­¢';
                    
                } catch (error) {
                    console.error('å¯åŠ¨å½•éŸ³å¤±è´¥:', error);
                    this.microphonePermission = 'denied';
                    this.updateMicrophoneStatus('æƒé™è¢«æ‹’ç»');
                    this.showError('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                }
            }

            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    
                    this.recordBtn.classList.remove('recording');
                    document.getElementById('recordIcon').textContent = 'ğŸ¤';
                    document.getElementById('recordingStatus').textContent = 'å¤„ç†ä¸­...';
                }
            }

            async processVoiceInput(audioBlob) {
                this.showLoading('æ­£åœ¨è¯†åˆ«è¯­éŸ³...');

                try {
                    const formData = new FormData();
                    formData.append('audioFile', audioBlob, 'recording.wav');

                    const response = await fetch('/api/RealtimeDigitalHuman/speech-to-text', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    console.log('[è¯­éŸ³è¯†åˆ«] APIå“åº”:', result);
                    
                    if (result.success && result.text) {
                        // è·å–å¤„ç†æ—¶é—´
                        const processingTimeMs = result.processingTime || 0;
                        console.log(`[è¯­éŸ³è¯†åˆ«] å¤„ç†å®Œæˆ: æ–‡æœ¬="${result.text}" ç½®ä¿¡åº¦=${result.confidence} æ—¶é—´=${processingTimeMs}ms`);
                        
                        // æ˜¾ç¤ºè¯†åˆ«ç»“æœåœ¨æ–‡æœ¬æ¡†ä¸­
                        document.getElementById('voiceResultText').value = result.text;
                        document.getElementById('sendVoiceTextBtn').disabled = false;
                        document.getElementById('recordingStatus').textContent = `è¯†åˆ«å®Œæˆï¼Œå¯ä»¥å‘é€ (${processingTimeMs}ms)`;
                        
                        // æ˜¾ç¤ºè¯†åˆ«ä¿¡æ¯ï¼ŒåŒ…å«å¤„ç†æ—¶é—´
                        this.showSuccess(`è¯­éŸ³è¯†åˆ«æˆåŠŸï¼ç½®ä¿¡åº¦: ${(result.confidence * 100).toFixed(1)}% | å¤„ç†æ—¶é—´: ${processingTimeMs}ms`);
                        
                        // æ›´æ–°çŠ¶æ€é¢æ¿ä¸­çš„å¤„ç†æ—¶é—´
                        document.getElementById('processingTime').textContent = `${processingTimeMs}ms (è¯­éŸ³è¯†åˆ«)`;
                        
                        // è‡ªåŠ¨å¡«å……åˆ°æ–‡æœ¬è¾“å…¥æ¡†
                        this.textInput.value = result.text;
                        
                        // åœ¨æ–‡æœ¬è¾“å…¥é¢æ¿æ˜¾ç¤ºè¯­éŸ³è½¬æ–‡æœ¬æ—¶é—´
                        document.getElementById('speechTimeValue').textContent = `${processingTimeMs}ms`;
                        document.getElementById('speechToTextTime').style.display = 'block';
                    } else {
                        this.showError('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
                        document.getElementById('recordingStatus').textContent = 'è¯†åˆ«å¤±è´¥';
                    }
                } catch (error) {
                    console.error('è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
                    this.showError('è¯­éŸ³è¯†åˆ«æœåŠ¡å¼‚å¸¸');
                    document.getElementById('recordingStatus').textContent = 'è¯†åˆ«å¤±è´¥';
                } finally {
                    this.hideLoading();
                }
            }

            async sendVoiceTextMessage() {
                const text = document.getElementById('voiceResultText').value.trim();
                if (!text) {
                    this.showError('æ²¡æœ‰å¯å‘é€çš„è¯†åˆ«å†…å®¹');
                    return;
                }

                this.showLoading('æ­£åœ¨ç”Ÿæˆæ•°å­—äººè§†é¢‘...');

                try {
                    const response = await fetch('/api/RealtimeDigitalHuman/instant-chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            text: text,
                            avatarId: this.currentAvatar,
                            responseMode: document.getElementById('responseMode').value,
                            quality: document.getElementById('videoQuality').value,
                            enableEmotion: document.getElementById('emotionMode').value === 'true'
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.playVideo(result.videoUrl);
                        this.updateStatus(result.metadata);
                        this.showSuccess('è¯­éŸ³æ¶ˆæ¯å‘é€æˆåŠŸï¼');
                        this.clearVoiceResult();
                    } else {
                        this.showError(result.message || 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                } catch (error) {
                    console.error('å‘é€è¯­éŸ³æ¶ˆæ¯å¤±è´¥:', error);
                    this.showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
                } finally {
                    this.hideLoading();
                }
            }

            clearVoiceResult() {
                document.getElementById('voiceResultText').value = '';
                document.getElementById('sendVoiceTextBtn').disabled = true;
                document.getElementById('recordingStatus').textContent = 'å‡†å¤‡å½•éŸ³';
            }

            playVideo(videoUrl) {
                this.videoPlayer.src = videoUrl;
                this.videoPlayer.style.display = 'block';
                this.videoPlaceholder.style.display = 'none';
                this.videoPlayer.play();
            }

            updateStatus(metadata) {
                document.getElementById('currentMode').textContent = this.getModeText(metadata.responseType);
                document.getElementById('processingTime').textContent = `${metadata.processingTime}ms (è§†é¢‘ç”Ÿæˆ)`;
                document.getElementById('videoQuality').textContent = this.getQualityText(metadata.quality?.resolution);
            }

            getModeText(responseType) {
                const modeMap = {
                    'prerendered': 'é¢„æ¸²æŸ“è§†é¢‘',
                    'instant': 'ç«‹å³å“åº”',
                    'realtime': 'å®æ—¶åˆæˆ',
                    'quality': 'é«˜è´¨é‡æ¨¡å¼'
                };
                return modeMap[responseType] || responseType;
            }

            getQualityText(resolution) {
                const qualityMap = {
                    '640x480': 'ä½è´¨é‡',
                    '1280x720': 'ä¸­ç­‰',
                    '1920x1080': 'é«˜è´¨é‡',
                    '2560x1440': 'è¶…é«˜æ¸…'
                };
                return qualityMap[resolution] || 'ä¸­ç­‰';
            }

            showLoading(text) {
                console.log('[Loading]', text);
                document.getElementById('loadingText').textContent = text;
                this.loadingPanel.style.display = 'block';
                // å…¨å±é®ç½©
                if (!document.getElementById('globalLoadingMask')) {
                    const mask = document.createElement('div');
                    mask.id = 'globalLoadingMask';
                    mask.style.position = 'fixed';
                    mask.style.left = '0';
                    mask.style.top = '0';
                    mask.style.width = '100vw';
                    mask.style.height = '100vh';
                    mask.style.background = 'rgba(0,0,0,0.25)';
                    mask.style.zIndex = '9999';
                    mask.innerHTML = `<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;">
                        <div class="spinner" style="margin:0 auto 20px;"></div>
                        <div style="color:#fff;font-size:1.2em;">${text}</div>
                    </div>`;
                    document.body.appendChild(mask);
                } else {
                    document.getElementById('globalLoadingMask').style.display = 'block';
                    document.getElementById('globalLoadingMask').querySelector('div[style*="font-size:1.2em;"]').textContent = text;
                }
            }

            hideLoading() {
                this.loadingPanel.style.display = 'none';
                const mask = document.getElementById('globalLoadingMask');
                if (mask) mask.style.display = 'none';
            }

            showError(message) {
                console.error('[Error]', message);
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
                this.successMessage.style.display = 'none';
                this.warningMessage.style.display = 'none';
                // å¢åŠ å…³é—­æŒ‰é’®
                if (!this.errorMessage.querySelector('.close-error')) {
                    const closeBtn = document.createElement('span');
                    closeBtn.textContent = 'Ã—';
                    closeBtn.className = 'close-error';
                    closeBtn.style.cssText = 'float:right;cursor:pointer;font-size:1.2em;margin-left:10px;';
                    closeBtn.onclick = () => { this.errorMessage.style.display = 'none'; };
                    this.errorMessage.appendChild(closeBtn);
                }
                setTimeout(() => {
                    this.errorMessage.style.display = 'none';
                }, 6000);
            }

            showSuccess(message) {
                console.log('[Success]', message);
                this.successMessage.textContent = message;
                this.successMessage.style.display = 'block';
                this.errorMessage.style.display = 'none';
                this.warningMessage.style.display = 'none';
                setTimeout(() => {
                    this.successMessage.style.display = 'none';
                }, 3000);
            }

            showWarning(message) {
                console.warn('[Warning]', message);
                this.warningMessage.textContent = message;
                this.warningMessage.style.display = 'block';
                this.errorMessage.style.display = 'none';
                this.successMessage.style.display = 'none';
                setTimeout(() => {
                    this.warningMessage.style.display = 'none';
                }, 8000);
            }

            async checkSystemHealth() {
                try {
                    const response = await fetch('/api/RealtimeDigitalHuman/health');
                    const health = await response.json();
                    
                    if (!health.isHealthy) {
                        this.showError('ç³»ç»ŸçŠ¶æ€å¼‚å¸¸ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™');
                    }
                } catch (error) {
                    console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
                }
            }

            showPendingAvatar() {
                // æ˜¾ç¤ºç­‰å¾…ä¸­çš„å¤´åƒçŠ¶æ€
                this.videoPlayer.style.display = 'none';
                this.videoPlaceholder.style.display = 'flex';
                this.videoPlaceholder.innerHTML = `
                    <div>
                        <div style="font-size: 3em; margin-bottom: 10px;">â³</div>
                        <div>æ­£åœ¨ç”Ÿæˆæ•°å­—äººè§†é¢‘...</div>
                    </div>
                `;
            }

            setupFileUpload() {
                const uploadArea = document.getElementById('uploadArea');
                const imageFile = document.getElementById('imageFile');
                const previewImage = document.getElementById('previewImage');

                // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
                uploadArea.addEventListener('click', () => {
                    imageFile.click();
                });

                // æ‹–æ‹½ä¸Šä¼ 
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        imageFile.files = files;
                        this.handleImageSelection(files[0]);
                    }
                });

                // æ–‡ä»¶é€‰æ‹©å¤„ç†
                imageFile.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.handleImageSelection(e.target.files[0]);
                    }
                });
            }

            handleImageSelection(file) {
                // éªŒè¯æ–‡ä»¶ç±»å‹
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    this.showError('è¯·é€‰æ‹©JPGã€PNGæˆ–WebPæ ¼å¼çš„å›¾ç‰‡');
                    return;
                }

                // éªŒè¯æ–‡ä»¶å¤§å° (æœ€å¤§10MB)
                if (file.size > 10 * 1024 * 1024) {
                    this.showError('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œæœ€å¤§æ”¯æŒ10MB');
                    return;
                }

                // é¢„è§ˆå›¾ç‰‡
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewImage = document.getElementById('previewImage');
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    
                    // éšè—ä¸Šä¼ æç¤º
                    const uploadArea = document.getElementById('uploadArea');
                    uploadArea.querySelector('p').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }

            showUploadModal() {
                this.uploadModal.style.display = 'block';
                // é‡ç½®è¡¨å•
                this.uploadForm.reset();
                document.getElementById('previewImage').style.display = 'none';
                document.getElementById('uploadArea').querySelector('p').style.display = 'block';
            }

            hideUploadModal() {
                this.uploadModal.style.display = 'none';
            }

            playAudioInBackground(audioUrl) {
                // åˆ›å»ºä¸€ä¸ªéšè—çš„audioå…ƒç´ æ’­æ”¾éŸ³é¢‘
                const audio = new Audio(audioUrl);
                audio.volume = 0.8;
                audio.play().catch(e => {
                    console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
                });
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new RealtimeDigitalHuman();
        });
    </script>
</body>
</html>