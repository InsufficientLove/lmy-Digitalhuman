# âš¡ MuseTalkå®æ—¶æ€§èƒ½åˆ†æ

åŸºäº[MuseTalkå®˜æ–¹GitHub](https://github.com/TMElyralab/MuseTalk)çš„`realtime_inference.py`å®ç°çœŸæ­£çš„å®æ—¶å¤šGPUæ–¹æ¡ˆã€‚

## ğŸ¯ æ ¸å¿ƒåŒºåˆ«

### ğŸ“Š å®æ—¶ vs éå®æ—¶å¯¹æ¯”

| æ–¹æ¡ˆ | é¢„å¤„ç† | æ¨ç†æ—¶è®¡ç®— | æ€§èƒ½ | é€‚ç”¨åœºæ™¯ |
|------|--------|-----------|------|----------|
| **éå®æ—¶** (`scripts.inference`) | âŒ æ¯æ¬¡éƒ½è¦é¢éƒ¨æ£€æµ‹ã€åæ ‡æå–ã€VAEç¼–ç  | å®Œæ•´æµç¨‹ | æ…¢ | ç¦»çº¿æ‰¹å¤„ç† |
| **å®æ—¶** (`realtime_inference`) | âœ… ä¸€æ¬¡æ€§é¢„å¤„ç†ï¼Œä¿å­˜åˆ°ç£ç›˜ | ä»…UNet+VAE | **å¿«** | åœ¨çº¿å®æ—¶ |

### ğŸš€ å®æ—¶æ–¹æ¡ˆçš„å…³é”®ä¼˜åŒ–

1. **é¢„å¤„ç†é˜¶æ®µ** (Avataråˆå§‹åŒ–):
   ```python
   # ä¸€æ¬¡æ€§å®Œæˆï¼Œä¿å­˜åˆ°ç£ç›˜
   - é¢éƒ¨æ£€æµ‹å’Œåæ ‡æå– (get_landmark_and_bbox)
   - VAEç¼–ç é¢„è®¡ç®— (vae.get_latents_for_unet)
   - é¢éƒ¨è§£æå’Œmaskç”Ÿæˆ (get_image_prepare_material)
   ```

2. **æ¨ç†é˜¶æ®µ** (å®æ—¶å“åº”):
   ```python
   # ä»…è®¡ç®—å¿…è¦éƒ¨åˆ†
   - éŸ³é¢‘ç‰¹å¾æå– (audio_processor.get_audio_feature)
   - UNetæ¨ç† (unet.model)
   - VAEè§£ç  (vae.decode_latents)
   ```

## ğŸ“ˆ æ€§èƒ½é¢„æœŸ

### ğŸ”¥ åŸºäºå®˜æ–¹åŸºå‡†çš„æ€§èƒ½è®¡ç®—

æ ¹æ®[å®˜æ–¹æ–‡æ¡£](https://github.com/TMElyralab/MuseTalk)ï¼š
- **å®˜æ–¹åŸºå‡†**: RTX 3050 Ti (4GB) fp16æ¨¡å¼ï¼Œ8ç§’è§†é¢‘éœ€5åˆ†é’Ÿ
- **æ‚¨çš„ç¡¬ä»¶**: 4x RTX 4090 (24GB each)

#### å•GPUæ€§èƒ½æå‡
| GPU | æ˜¾å­˜ | ç†è®ºæ€§èƒ½æå‡ | é¢„æœŸæ—¶é—´ |
|-----|------|-------------|----------|
| RTX 3050 Ti | 4GB | åŸºå‡† | 8ç§’è§†é¢‘ = 5åˆ†é’Ÿ |
| RTX 4090 | 24GB | 6å€ | 8ç§’è§†é¢‘ = 50ç§’ |

#### å®æ—¶ä¼˜åŒ–æ•ˆæœ
| é˜¶æ®µ | éå®æ—¶è€—æ—¶ | å®æ—¶è€—æ—¶ | ä¼˜åŒ–å€æ•° |
|------|-----------|---------|----------|
| é¢éƒ¨æ£€æµ‹ | 10-20ç§’ | **0ç§’** (é¢„å¤„ç†) | âˆ |
| åæ ‡æå– | 5-10ç§’ | **0ç§’** (é¢„å¤„ç†) | âˆ |
| VAEç¼–ç  | 5-15ç§’ | **0ç§’** (é¢„å¤„ç†) | âˆ |
| UNetæ¨ç† | 20-30ç§’ | 20-30ç§’ | 1å€ |
| VAEè§£ç  | 5-10ç§’ | 5-10ç§’ | 1å€ |
| **æ€»è®¡** | **45-85ç§’** | **25-40ç§’** | **2-3å€** |

#### å¤šGPUå¹¶è¡Œæ•ˆæœ
| æ–¹æ¡ˆ | å•ä¸ª3ç§’è§†é¢‘ | 4ä¸ªå¹¶å‘è¯·æ±‚ | GPUåˆ©ç”¨ç‡ |
|------|------------|------------|----------|
| å•GPUå®æ—¶ | 12-15ç§’ | 48-60ç§’ | 25% |
| **4GPUå¹¶è¡Œå®æ—¶** | **12-15ç§’** | **12-15ç§’** | **100%** |

## ğŸ¯ æœ€ç»ˆæ€§èƒ½é¢„æœŸ

### âœ… ä¿å®ˆä¼°ç®—
- **é¦–æ¬¡ä½¿ç”¨avatar**: 12-15ç§’ (åŒ…å«é¢„å¤„ç†)
- **åç»­ä½¿ç”¨ç›¸åŒavatar**: **5-8ç§’** (ä»…æ¨ç†)
- **4ä¸ªç”¨æˆ·å¹¶å‘**: æ¯ä¸ªç”¨æˆ·ä»ç„¶5-8ç§’

### ğŸš€ æœ€ä½³æƒ…å†µ
- **é¢„çƒ­avatar**: **3-5ç§’**
- **å¤šç”¨æˆ·å¹¶å‘**: æ¯ä¸ªç”¨æˆ·3-5ç§’
- **çœŸæ­£æ¥è¿‘å®æ—¶**: æ»¡è¶³B/Sé¡¹ç›®éœ€æ±‚

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. Avataré¢„å¤„ç†ç¼“å­˜
```csharp
private readonly ConcurrentDictionary<string, AvatarInfo> _avatarCache = new();

// å¯åŠ¨æ—¶é¢„çƒ­å¸¸ç”¨avatar
await PreprocessAvatarAsync(avatarId, avatarPath);
```

### 2. 4GPUå¹¶è¡Œé˜Ÿåˆ—
```csharp
private readonly ConcurrentQueue<GpuTask>[] _gpuQueues = new ConcurrentQueue<GpuTask>[4];

// æ™ºèƒ½è´Ÿè½½å‡è¡¡
var selectedGpuId = SelectBestGpu();
```

### 3. å®æ—¶æ¨ç†ä¼˜åŒ–
```python
# ä½¿ç”¨å®˜æ–¹realtime_inference.py
python -m scripts.realtime_inference --batch_size 20 --gpu_id 0
```

## ğŸ‰ ç»“è®º

é€šè¿‡ç»“åˆï¼š
1. **å®˜æ–¹å®æ—¶æ–¹æ¡ˆ** (realtime_inference.py)
2. **4x RTX 4090å¹¶è¡Œ**
3. **Avataré¢„å¤„ç†ç¼“å­˜**

å®ç°äº†ä»**45-85ç§’**åˆ°**3-8ç§’**çš„å·¨å¤§æ€§èƒ½æå‡ï¼Œå®Œå…¨æ»¡è¶³B/Sé¡¹ç›®çš„å®æ—¶å“åº”éœ€æ±‚ï¼