events {
    worker_connections 1024;
}

http {
    upstream digitalhuman_backend {
        server digitalhuman:5000;
    }
    
    upstream ollama_backend {
        server ollama:11434;
    }

    # 速率限制
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

    server {
        listen 80;
        server_name localhost;

        # 安全头
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";

        # 文件上传大小限制
        client_max_body_size 100M;

        # 数字人API
        location /api/ {
            limit_req zone=api burst=20;
            
            proxy_pass http://digitalhuman_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 300s;
        }

        # Swagger文档
        location /swagger {
            proxy_pass http://digitalhuman_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Ollama API（可选）
        location /ollama/ {
            rewrite ^/ollama/(.*) /$1 break;
            proxy_pass http://ollama_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # 静态文件
        location /videos/ {
            alias /app/wwwroot/videos/;
            expires 1d;
            add_header Cache-Control "public, immutable";
        }

        location /templates/ {
            alias /app/wwwroot/templates/;
            expires 1h;
        }

        # 健康检查
        location /health {
            proxy_pass http://digitalhuman_backend/api/diagnostics/system-info;
            access_log off;
        }

        # 默认页面
        location / {
            return 200 '
<!DOCTYPE html>
<html>
<head>
    <title>数字人系统</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .service { background: #f5f5f5; padding: 20px; margin: 10px 0; border-radius: 5px; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 3px; color: white; }
        .online { background: #4CAF50; }
        .offline { background: #f44336; }
        a { color: #2196F3; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🤖 数字人系统</h1>
        <p>系统已成功部署并运行中</p>
        
        <div class="service">
            <h3>📡 API 服务</h3>
            <p><strong>数字人API:</strong> <a href="/api" target="_blank">/api</a></p>
            <p><strong>API文档:</strong> <a href="/swagger" target="_blank">/swagger</a></p>
            <p><strong>系统诊断:</strong> <a href="/api/diagnostics/system-info" target="_blank">/api/diagnostics/system-info</a></p>
            <p><strong>Python环境:</strong> <a href="/api/diagnostics/python-environments" target="_blank">/api/diagnostics/python-environments</a></p>
        </div>
        
        <div class="service">
            <h3>🧠 Ollama LLM</h3>
            <p><strong>Ollama API:</strong> <a href="/ollama/api/version" target="_blank">/ollama/api/version</a></p>
        </div>

        <div class="service">
            <h3>📁 文件服务</h3>
            <p><strong>生成视频:</strong> <a href="/videos/" target="_blank">/videos/</a></p>
            <p><strong>模板文件:</strong> <a href="/templates/" target="_blank">/templates/</a></p>
        </div>
        
        <div class="service">
            <h3>🔧 系统管理</h3>
            <p><strong>健康检查:</strong> <a href="/health" target="_blank">/health</a></p>
        </div>
    </div>
</body>
</html>
            ';
            add_header Content-Type text/html;
        }
    }

    # HTTPS配置（生产环境使用）
    # server {
    #     listen 443 ssl http2;
    #     server_name your-domain.com;
    #     
    #     ssl_certificate /etc/nginx/ssl/cert.pem;
    #     ssl_certificate_key /etc/nginx/ssl/key.pem;
    #     
    #     # 其他配置同上...
    # }
}