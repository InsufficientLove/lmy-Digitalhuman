events {
    worker_connections 1024;
}

http {
    upstream digitalhuman_backend {
        server digitalhuman:5000;
    }
    
    upstream ollama_backend {
        server ollama:11434;
    }

    # é€Ÿç‡é™åˆ¶
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

    server {
        listen 80;
        server_name localhost;

        # å®‰å…¨å¤´
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";

        # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
        client_max_body_size 100M;

        # æ•°å­—äººAPI
        location /api/ {
            limit_req zone=api burst=20;
            
            proxy_pass http://digitalhuman_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 300s;
        }

        # Swaggeræ–‡æ¡£
        location /swagger {
            proxy_pass http://digitalhuman_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Ollama APIï¼ˆå¯é€‰ï¼‰
        location /ollama/ {
            rewrite ^/ollama/(.*) /$1 break;
            proxy_pass http://ollama_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # é™æ€æ–‡ä»¶
        location /videos/ {
            alias /app/wwwroot/videos/;
            expires 1d;
            add_header Cache-Control "public, immutable";
        }

        location /templates/ {
            alias /app/wwwroot/templates/;
            expires 1h;
        }

        # å¥åº·æ£€æŸ¥
        location /health {
            proxy_pass http://digitalhuman_backend/api/diagnostics/system-info;
            access_log off;
        }

        # é»˜è®¤é¡µé¢
        location / {
            return 200 '
<!DOCTYPE html>
<html>
<head>
    <title>æ•°å­—äººç³»ç»Ÿ</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        .service { background: #f5f5f5; padding: 20px; margin: 10px 0; border-radius: 5px; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 3px; color: white; }
        .online { background: #4CAF50; }
        .offline { background: #f44336; }
        a { color: #2196F3; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– æ•°å­—äººç³»ç»Ÿ</h1>
        <p>ç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²å¹¶è¿è¡Œä¸­</p>
        
        <div class="service">
            <h3>ğŸ“¡ API æœåŠ¡</h3>
            <p><strong>æ•°å­—äººAPI:</strong> <a href="/api" target="_blank">/api</a></p>
            <p><strong>APIæ–‡æ¡£:</strong> <a href="/swagger" target="_blank">/swagger</a></p>
            <p><strong>ç³»ç»Ÿè¯Šæ–­:</strong> <a href="/api/diagnostics/system-info" target="_blank">/api/diagnostics/system-info</a></p>
            <p><strong>Pythonç¯å¢ƒ:</strong> <a href="/api/diagnostics/python-environments" target="_blank">/api/diagnostics/python-environments</a></p>
        </div>
        
        <div class="service">
            <h3>ğŸ§  Ollama LLM</h3>
            <p><strong>Ollama API:</strong> <a href="/ollama/api/version" target="_blank">/ollama/api/version</a></p>
        </div>

        <div class="service">
            <h3>ğŸ“ æ–‡ä»¶æœåŠ¡</h3>
            <p><strong>ç”Ÿæˆè§†é¢‘:</strong> <a href="/videos/" target="_blank">/videos/</a></p>
            <p><strong>æ¨¡æ¿æ–‡ä»¶:</strong> <a href="/templates/" target="_blank">/templates/</a></p>
        </div>
        
        <div class="service">
            <h3>ğŸ”§ ç³»ç»Ÿç®¡ç†</h3>
            <p><strong>å¥åº·æ£€æŸ¥:</strong> <a href="/health" target="_blank">/health</a></p>
        </div>
    </div>
</body>
</html>
            ';
            add_header Content-Type text/html;
        }
    }

    # HTTPSé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼‰
    # server {
    #     listen 443 ssl http2;
    #     server_name your-domain.com;
    #     
    #     ssl_certificate /etc/nginx/ssl/cert.pem;
    #     ssl_certificate_key /etc/nginx/ssl/key.pem;
    #     
    #     # å…¶ä»–é…ç½®åŒä¸Š...
    # }
}